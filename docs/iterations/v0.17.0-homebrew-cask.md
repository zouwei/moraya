# v0.17.0 Homebrew Cask Distribution
**版本：** v0.17.0
**状态：** 已完成
**日期：** 2026-02-27

> Enable macOS users to install Moraya with a single `brew install --cask moraya` command, with the Cask formula automatically updated on every release.

## Background

Moraya is currently distributed only via GitHub Releases as macOS DMG files. Users must manually download the DMG, drag the app to Applications, and run `xattr -cr` to bypass Gatekeeper restrictions. Homebrew is the most widely used package manager on macOS. Adding Homebrew Cask support provides:

- Installation simplified from 3 steps to 1 command
- `brew upgrade` for automatic upgrades to the latest version
- `brew uninstall --zap` for complete removal including preferences and caches

## Key Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Distribution channel | Self-hosted Tap (`zouwei/homebrew-moraya`) | Official `Homebrew/homebrew-cask` requires 75+ stars + code signing + notarization; self-hosted has no approval requirements |
| Repository naming | `homebrew-moraya` | The `homebrew-` prefix enables `brew tap zouwei/moraya` shorthand |
| Multi-architecture | `arch arm: "aarch64", intel: "x64"` | Matches Tauri DMG filename suffixes; Homebrew auto-selects the correct architecture |
| SHA256 update method | CI automation | `release.yml` triggers `bump-cask.yml` to automatically download DMGs → compute SHA256 → update formula → commit |
| Version detection | `livecheck` stanza | Enables `brew livecheck moraya` to detect new versions |

## Feature List

### F17.1 Homebrew Cask Formula

**Goal**: Write a Cask formula supporting both Apple Silicon and Intel architectures.

**Technical Approach**:

Cask formula file `Casks/moraya.rb`:

```ruby
cask "moraya" do
  arch arm: "aarch64", intel: "x64"

  version "0.16.1"
  sha256 arm:   "<aarch64_sha256>",
         intel: "<x64_sha256>"

  url "https://github.com/zouwei/moraya/releases/download/v#{version}/Moraya_#{version}_#{arch}.dmg",
      verified: "github.com/zouwei/moraya/"

  name "Moraya"
  desc "Minimalist AI-powered WYSIWYG Markdown editor built with Tauri"
  homepage "https://github.com/zouwei/moraya"

  livecheck do
    url :url
    strategy :github_latest
    regex(/^v?(\d+(?:\.\d+)+)$/i)
  end

  depends_on macos: ">= :big_sur"

  app "Moraya.app"

  zap trash: [
    "~/Library/Application Support/com.moraya.app",
    "~/Library/Caches/com.moraya.app",
    "~/Library/Preferences/com.moraya.app.plist",
    "~/Library/Saved Application State/com.moraya.app.savedState",
  ]
end
```

**Key Stanza Reference**:

| Stanza | Purpose |
|--------|---------|
| `arch arm: "aarch64", intel: "x64"` | `#{arch}` in the URL is replaced with the corresponding string based on CPU architecture |
| `sha256 arm:, intel:` | Per-architecture integrity verification; Homebrew auto-selects the matching checksum |
| `verified:` | Informs `brew audit` that the download domain is verified |
| `livecheck` + `strategy :github_latest` | Parses the latest version number from the GitHub Latest Release |
| `depends_on macos: ">= :big_sur"` | Tauri v2 WKWebView requires macOS Big Sur or later |
| `app "Moraya.app"` | Moves the .app from the DMG to `/Applications/` |
| `zap trash` | Directories removed on `brew uninstall --zap` (uses bundle ID `com.moraya.app`) |

**Files** (homebrew-moraya repository):
- `Casks/moraya.rb` — New file

### F17.2 Automated Cask Update Workflow

**Goal**: Automatically update the Cask formula's version and SHA256 whenever a new version of Moraya is released.

**Architecture**:

```
moraya repository:
  git tag v* → release.yml
    ├── release job (existing) → Build DMGs → GitHub Releases
    └── update-homebrew job (new) → gh workflow run → trigger homebrew-moraya

homebrew-moraya repository:
  bump-cask.yml (workflow_dispatch)
    → Download both DMGs
    → Compute SHA256
    → sed update moraya.rb
    → commit & push
```

**bump-cask.yml workflow** (homebrew-moraya repository):

```yaml
name: Bump Moraya Cask

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'New version (without v prefix)'
        required: true
      tag:
        description: 'Git tag (with v prefix)'
        required: true

jobs:
  bump:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download DMGs and compute SHA256
        run: |
          VERSION="${{ github.event.inputs.version }}"
          TAG="${{ github.event.inputs.tag }}"
          BASE_URL="https://github.com/zouwei/moraya/releases/download/${TAG}"

          curl -fSL "${BASE_URL}/Moraya_${VERSION}_aarch64.dmg" -o arm64.dmg
          curl -fSL "${BASE_URL}/Moraya_${VERSION}_x64.dmg" -o x64.dmg

          echo "SHA_ARM=$(shasum -a 256 arm64.dmg | awk '{print $1}')" >> $GITHUB_ENV
          echo "SHA_INTEL=$(shasum -a 256 x64.dmg | awk '{print $1}')" >> $GITHUB_ENV
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Update cask formula
        run: |
          sed -i "s/version \".*\"/version \"${VERSION}\"/" Casks/moraya.rb
          sed -i "s/sha256 arm:   \".*\"/sha256 arm:   \"${SHA_ARM}\"/" Casks/moraya.rb
          sed -i "s/intel: \".*\"/intel: \"${SHA_INTEL}\"/" Casks/moraya.rb

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/moraya.rb
          git diff --cached --quiet && echo "No changes" && exit 0
          git commit -m "bump moraya to ${VERSION}"
          git push
```

**Files** (homebrew-moraya repository):
- `.github/workflows/bump-cask.yml` — New file

### F17.3 Release Workflow Integration

**Goal**: Add an `update-homebrew` job to Moraya's `release.yml` that automatically triggers the Cask update after release assets are uploaded.

**New Job**:

```yaml
update-homebrew:
  needs: [release]
  runs-on: ubuntu-latest
  steps:
    - name: Trigger Homebrew tap update
      env:
        GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
      run: |
        VERSION="${GITHUB_REF_NAME#v}"
        gh workflow run bump-cask.yml \
          -R zouwei/homebrew-moraya \
          -f version="$VERSION" \
          -f tag="${GITHUB_REF_NAME}"
```

**trigger-deploy dependency update**:

```yaml
trigger-deploy:
  needs: [release, update-homebrew]  # previously only depended on release
```

**releaseBody update**: Homebrew install command added to the macOS section (marked as recommended).

**Prerequisites**:
- Create a Fine-grained PAT (grant `contents:write` + `actions:write` on the `homebrew-moraya` repository)
- Add it as a GitHub Secret `HOMEBREW_TAP_TOKEN` in the moraya repository

**Files** (moraya repository):
- `.github/workflows/release.yml` — Add `update-homebrew` job, update `trigger-deploy.needs`, update `releaseBody`

### F17.4 README Install Section Update

**Goal**: Add Homebrew as the preferred macOS installation method in the README.md `## Install` section.

**Changes**:

```markdown
## Install

### macOS (Homebrew)

\```bash
brew tap zouwei/moraya
brew install --cask moraya
\```

Upgrade: `brew upgrade --cask moraya` · Uninstall: `brew uninstall --cask moraya`

### All Platforms

Download from [GitHub Releases](https://github.com/zouwei/moraya/releases).

| Platform | File | Install |
|----------|------|---------|
| macOS (Apple Silicon) | `Moraya_x.x.x_aarch64.dmg` | Open DMG, drag to Applications |
| macOS (Intel) | `Moraya_x.x.x_x64.dmg` | Open DMG, drag to Applications |
| Windows | `Moraya_x.x.x_x64_en-US.msi` | Run the MSI installer |
| Linux (Debian) | `moraya_x.x.x_amd64.deb` | `sudo dpkg -i moraya_*.deb` |
| Linux (AppImage) | `Moraya_x.x.x_amd64.AppImage` | `chmod +x` then run |
```

**Files** (moraya repository):
- `README.md` — Restructure `## Install` section

## homebrew-moraya Repository Structure

```
zouwei/homebrew-moraya/
├── Casks/
│   └── moraya.rb                      # Cask formula
├── .github/
│   └── workflows/
│       └── bump-cask.yml              # Auto-update workflow
└── README.md                          # Install instructions
```

## moraya Repository Modified Files

| File Path | Changes |
|-----------|---------|
| `.github/workflows/release.yml` | Add `update-homebrew` job; add dependency to `trigger-deploy.needs`; append brew instructions to releaseBody |
| `README.md` | Add Homebrew install commands and all-platform install table to `## Install` |

## GitHub Configuration Checklist

| Item | Location | Notes |
|------|----------|-------|
| `zouwei/homebrew-moraya` public repository | GitHub | Repository name must include the `homebrew-` prefix |
| Fine-grained PAT | GitHub Settings → Developer settings → Tokens | Grant `contents:write` + `actions:write` on `homebrew-moraya` |
| `HOMEBREW_TAP_TOKEN` Secret | moraya repo → Settings → Secrets → Actions | Store the PAT created above |

## User Install Flow

```bash
# First-time install (one-time tap + install)
brew tap zouwei/moraya
brew install --cask moraya

# Or combine into a single command
brew install --cask zouwei/moraya/moraya

# Upgrade
brew upgrade --cask moraya

# Uninstall
brew uninstall --cask moraya

# Full uninstall (including preferences and caches)
brew uninstall --zap --cask moraya
```

## Automated Release Flow

Fully unified with the existing desktop release process — no additional steps required:

```bash
pnpm version:bump 0.17.0
git add -A && git commit -m "chore: release v0.17.0"
git tag v0.17.0
git push origin main --tags
# GitHub Actions handles everything automatically:
#   → release: Build DMG/MSI/DEB/AppImage → GitHub Releases
#   → update-homebrew: Trigger homebrew-moraya's bump-cask.yml
#   → bump-cask.yml: Download DMGs → compute SHA256 → update moraya.rb → commit
#   → trigger-deploy: Cloudflare Pages deployment
#   → Users can run: brew upgrade --cask moraya
```

## Verification

### Initial Release Verification

```bash
# 1. Cask syntax check
brew tap zouwei/moraya
brew audit --cask zouwei/moraya/moraya

# 2. Install verification
brew install --cask moraya
ls /Applications/Moraya.app     # Confirm installation succeeded
open /Applications/Moraya.app   # Confirm the app launches correctly

# 3. Uninstall verification
brew uninstall --cask moraya
ls /Applications/Moraya.app     # Confirm removal
```

### Auto-Update Verification

1. Push a new tag to the moraya repository
2. Wait for the `release` job to complete
3. Confirm the `update-homebrew` job successfully triggers `bump-cask.yml`
4. Check the `homebrew-moraya` repository for a new commit (version + SHA256 updated)
5. Run `brew upgrade --cask moraya` and confirm the upgrade to the new version

### Regression Verification

```bash
# Desktop builds should be unaffected
pnpm check          # Zero TypeScript errors
pnpm tauri dev      # Normal startup
```

## Future: Submit to Official Homebrew Cask

Once the moraya repository meets all of the following conditions, a PR can be submitted to `Homebrew/homebrew-cask`:

| Condition | Requirement |
|-----------|-------------|
| GitHub Stars | ≥ 75 (third-party submission) or ≥ 225 (self-submission by repo owner) |
| Code Signing | Enable Apple Developer signing (uncomment APPLE_* env vars in release.yml) |
| Notarization | Pass Apple Notarization (no Gatekeeper warnings) |

The self-hosted Tap and the official Cask can coexist without conflicts.
