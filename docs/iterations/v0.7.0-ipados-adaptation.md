# v0.7.0 iPadOS Adaptation

> 让 Moraya 在 iPad 上作为原生 App 运行，Magic Keyboard 下体验接近桌面，纯触控下通过浮动工具栏提供完整编辑能力。

## 需求背景

Moraya 当前仅支持桌面平台（macOS/Windows/Linux）。iPadOS 是所有移动平台中最接近桌面体验的目标：

- 屏幕尺寸充足（10.9"-12.9"），现有 UI 布局基本可用
- Magic Keyboard 支持 Cmd+key 快捷键，77 个编辑器快捷键几乎全部可复用
- Tauri v2 已正式支持 iOS 构建

## 关键决策

| 决策项 | 选择 | 理由 |
|--------|------|------|
| 多窗口替代 | Tab 栏切换 | 类似 VS Code 体验，iPad 不支持多 Tauri 窗口 |
| 纯触控编辑 | 浮动格式工具栏 | 类似 Bear/iA Writer，虚拟键盘上方横向滚动按钮 |
| MCP 传输 | 仅 SSE/HTTP | iOS 不支持子进程 spawn，stdio 需禁用 |
| 编辑器模式 | 横屏支持 Split，竖屏仅 Visual/Source | 竖屏空间不足以并排 |

## 功能列表

### F7.1 Tauri iOS 基础构建

**目标**：iPad 模拟器上跑通 Moraya，验证 Milkdown 编辑器基本可用。

**技术方案**：
- 执行 `pnpm tauri ios init` 生成 Xcode 项目
- 配置 `Info.plist` 设备目标为 iPad only（`UIDeviceFamily: [2]`）
- Rust 条件编译排除桌面专有模块：
  - `tray` 模块：`#[cfg(all(not(target_os = "macos"), not(target_os = "ios")))]`
  - `menu::create_menu()` + `app.set_menu()`：`#[cfg(not(target_os = "ios"))]`
  - `create_editor_window()` / 多窗口命令：`#[cfg(not(target_os = "ios"))]`
  - MCP `Command::spawn()`：`#[cfg(not(target_os = "ios"))]`
  - `fix-path-env`：iOS 不需要

**涉及文件**：
- `src-tauri/src/lib.rs` — 条件编译
- `src-tauri/src/commands/mcp.rs` — stdio disabled
- `src-tauri/Cargo.toml` — 条件依赖

### F7.2 平台检测 & TitleBar 适配

**目标**：正确识别 iPadOS，TitleBar 适配 iPad 全屏体验。

**UI 设计**：
- iPadOS UA 伪装为 macOS，需用 `navigator.maxTouchPoints > 1` 区分
- TitleBar 隐藏窗口控件（minimize/maximize/close）
- 移除 `-webkit-app-region: drag`（iPad 无窗口拖拽）
- 添加 `padding-top: env(safe-area-inset-top)` 处理 iPad 圆角

**涉及文件**：
- `src/lib/utils/platform.ts` — 新建，平台检测工具
- `src/routes/+page.svelte` — 扩展 UA 检测
- `src/lib/components/TitleBar.svelte` — iPad 样式

### F7.3 Tab 栏系统

**目标**：iPad 上用 Tab 栏支持多文件编辑，替代桌面端多窗口。

**UI 设计**：
- 位于 TitleBar 下方，编辑器上方
- 高度 36px，横向可滚动
- 每个 Tab 显示文件名 + 关闭按钮 + 未保存指示器
- 右侧 "+" 按钮新建 Tab
- 仅在 iPadOS 下显示

**数据结构**：
```typescript
interface TabItem {
  id: string;
  filePath: string | null;  // null = untitled
  fileName: string;
  content: string;
  isDirty: boolean;
}
```

**交互**：
- 点击 Tab → 切换（保存当前内容到 Tab 状态）
- 关闭 Tab → 若未保存弹出确认对话框
- 从 Sidebar 打开文件 → 复用已打开 Tab 或新建 Tab
- `Cmd+N` → 新建 Tab（iPad 上）

**涉及文件**：
- `src/lib/components/TabBar.svelte` — 新建
- `src/lib/stores/tabs-store.ts` — 新建
- `src/routes/+page.svelte` — Tab 集成
- `src/lib/components/Sidebar.svelte` — 文件打开逻辑

### F7.4 浮动格式工具栏

**目标**：无 Magic Keyboard 时，提供虚拟键盘上方的格式化按钮。

**UI 设计**：
- 位于虚拟键盘正上方，固定定位
- 横向滚动，高度 44px（Apple HIG 最小触控目标）
- 仅在 iPadOS + 虚拟键盘弹出时显示
- 有外接键盘时隐藏（快捷键已覆盖全部功能）

**按钮分组**：

| 分组 | 按钮 |
|------|------|
| 撤销 | Undo, Redo |
| 文本格式 | **B**, *I*, ~~S~~, `Code` |
| 段落 | H1/H2/H3 选择器, "> 引用, - 列表, 1. 列表 |
| 插入 | Link, Image, Table, Code Block, Math, HR |

**涉及文件**：
- `src/lib/editor/TouchToolbar.svelte` — 新建
- `src/lib/utils/platform.ts` — 键盘检测

### F7.5 触控交互适配

**目标**：替换所有仅桌面可用的交互模式。

**改造内容**：

1. **Hover → Active/Touch 反馈**
   - 全局策略：`@media (hover: none) and (pointer: coarse)` 媒体查询
   - 约 64 处 `:hover` 规则添加 `:active` 或 `:focus-visible` 替代
   - 分为功能性（按钮、文件项）和装饰性（链接下划线、滚动条）

2. **右键菜单 → 长按**
   - iPadOS WKWebView 的 `contextmenu` 事件由长按触发
   - 需验证 ProseMirror 兼容性，备选 `touchstart` + 500ms delay

3. **拖拽文件 → 禁用**
   - iPad 上不注册 `onDragDropEvent`
   - 文件通过 Sidebar 或文件对话框打开

4. **触控目标尺寸**
   - Apple HIG 最小 44×44pt
   - 调整 Sidebar 文件项、StatusBar 按钮、TabBar 关闭按钮

5. **Split 模式竖屏**
   - `window.innerWidth < 900` 时禁用 Split，仅保留 Visual/Source 切换

**涉及文件**：
- `src/lib/styles/global.css` — touch media query
- `src/lib/editor/Editor.svelte` — 长按 fallback
- `src/routes/+page.svelte` — 拖拽禁用
- 各组件 Svelte 文件 — hover → active

### F7.6 虚拟键盘处理

**目标**：解决 iOS WKWebView 键盘弹出时的 viewport 问题。

**技术方案**：
- 监听 `window.visualViewport.onresize`，动态设置 `--app-height` CSS 变量
- 主容器使用 `height: var(--app-height, 100vh)` 替代 `100vh`
- StatusBar 使用 `position: sticky; bottom: 0`
- ProseMirror `scrollIntoView()` 在 iOS 不生效时，手动 `element.scrollIntoView({ block: 'nearest' })`

**涉及文件**：
- `src/routes/+page.svelte` — viewport 监听
- `src/lib/components/StatusBar.svelte` — sticky 定位
- `src/lib/styles/variables.css` — `--app-height` 变量

### F7.7 MCP 客户端适配

**目标**：iPad 上仅保留 SSE/HTTP 传输。

**改造内容**：
- MCPPanel 中隐藏 stdio 类型选项
- MCP 客户端 stdio 分支：Rust 端返回 `Err("stdio transport not available on iPad")`
- 前端提示信息

**涉及文件**：
- `src/lib/components/ai/MCPPanel.svelte` — UI 隐藏
- `src/lib/services/mcp/mcp-client.ts` — 提示处理

## 新建文件清单

| 文件路径 | 用途 |
|---------|------|
| `src/lib/components/TabBar.svelte` | Tab 栏组件 |
| `src/lib/stores/tabs-store.ts` | 多 Tab 状态管理 |
| `src/lib/editor/TouchToolbar.svelte` | 触控格式工具栏 |
| `src/lib/utils/platform.ts` | 平台检测工具函数 |

## 修改文件清单

| 文件路径 | 改动内容 |
|---------|---------|
| `src-tauri/src/lib.rs` | iOS 条件编译（menu, tray, multi-window） |
| `src-tauri/src/commands/mcp.rs` | stdio 在 iOS 上 disabled |
| `src-tauri/Cargo.toml` | 条件依赖 |
| `src/routes/+page.svelte` | 平台检测、Tab 集成、键盘处理、拖拽禁用 |
| `src/lib/components/TitleBar.svelte` | iPad 样式适配 |
| `src/lib/components/StatusBar.svelte` | 键盘弹出时定位 |
| `src/lib/components/Sidebar.svelte` | Tab 集成、触控目标 |
| `src/lib/components/ai/MCPPanel.svelte` | 隐藏 stdio 选项 |
| `src/lib/styles/variables.css` | iPad safe-area 变量、--app-height |
| `src/lib/styles/global.css` | touch media query |
| 各组件 `:hover` 样式 | 添加 `:active` fallback |

## 测试方案

### 环境准备

| 项目 | 要求 |
|------|------|
| macOS | 必须（iOS 开发只能在 Mac 上） |
| Xcode | 最新版（含 iOS SDK、iPad 模拟器） |
| Rust iOS targets | `aarch64-apple-ios` + `aarch64-apple-ios-sim` |
| Apple 开发者账号 | 免费可用模拟器；真机/TestFlight 需付费账号（$99/年） |

```bash
# 一次性安装 Rust iOS 编译目标
rustup target add aarch64-apple-ios aarch64-apple-ios-sim

# 初始化 Tauri iOS 项目（生成 src-tauri/gen/apple/）
pnpm tauri ios init
```

### 三级测试环境

#### Level 1：iPad 模拟器（日常开发）

```bash
# 启动并选择 iPad 模拟器（交互式选择设备）
pnpm tauri ios dev --open

# 直接指定设备
pnpm tauri ios dev "iPad Pro (12.9-inch)"
pnpm tauri ios dev "iPad Air"
pnpm tauri ios dev "iPad (10th generation)"
```

- 支持 Vite HMR（前端改动秒级热更新）
- Rust 代码改动自动重编译
- Safari Web Inspector 可调试 WebView
- **限制**：无法测试 Magic Keyboard 快捷键、虚拟键盘弹出/收起、Apple Pencil、真实触控手感
- **适用于**：布局验证、功能逻辑、条件编译、Tab 系统、MCP 连接

#### Level 2：真机 iPad（体验验证）

```bash
# iPad 通过 USB 或 WiFi 连接 Mac
pnpm tauri ios dev --force-ip-prompt
# 选择 IPv6 地址（通常是 ::2 结尾的那个）
```

前置条件：
- iPad 上信任 Mac（首次连接时弹出提示）
- iPad Settings → Safari → Advanced → 开启 Web Inspector
- 首次运行时允许"本地网络"权限，然后重启 App

可测试全部真实交互：
- Magic Keyboard 快捷键
- 虚拟键盘弹出/收起 + viewport 变化
- 触控目标大小的真实手感
- 横竖屏切换、Stage Manager 多任务
- App 后台恢复
- **适用于**：触控工具栏、虚拟键盘处理、hover→active 效果、ProseMirror 兼容性

#### Level 3：TestFlight（外部测试）

```bash
# 构建 IPA
pnpm tauri ios build

# IPA 位置：src-tauri/gen/apple/build/arm64/Moraya.ipa

# 上传到 App Store Connect（通过 Xcode 或 CLI）
xcrun altool --upload-app \
  --type ios \
  --file "src-tauri/gen/apple/build/arm64/Moraya.ipa" \
  --apiKey $APPLE_API_KEY_ID \
  --apiIssuer $APPLE_API_ISSUER
```

- **适用于**：多设备兼容性、不同 iPad 型号、外部用户反馈

### 调试工具

#### Safari Web Inspector

```
Mac Safari → 设置 → 高级 → 勾选"显示网页开发者功能"
Mac Safari → 开发 → [模拟器名/iPad名] → localhost
```

提供：JS Console、DOM/元素审查、CSS 样式检查、网络请求监控、性能分析。

#### Xcode Console

查看 Rust 后端 `println!` / `eprintln!` 输出和 App crash 日志。

### 分阶段测试检查表

#### Phase 1：基础构建（模拟器）

```
[ ] pnpm tauri ios dev 启动成功，不 crash
[ ] Milkdown 编辑器渲染正常
[ ] 能打字、删除、换行
[ ] Markdown 语法实时渲染（标题、列表、代码块）
[ ] KaTeX 数学公式显示正确
[ ] cargo check 桌面端零编译错误（条件编译未破坏桌面）
[ ] pnpm check TypeScript 零错误
```

#### Phase 2-3：TitleBar + Tab 栏（模拟器）

```
[ ] TitleBar 无窗口控件（minimize/maximize/close 不显示）
[ ] TitleBar 标题正常显示
[ ] Tab 栏显示在 TitleBar 下方
[ ] 新建 Tab → 空白编辑器
[ ] 打开文件 → 新 Tab（非新窗口）
[ ] 切换 Tab → 内容正确恢复
[ ] 关闭未保存 Tab → 弹出确认
[ ] Sidebar 点击文件 → 打开为 Tab
```

#### Phase 4-5：触控交互（必须真机）

```
[ ] 虚拟键盘弹出 → 浮动工具栏出现在键盘上方
[ ] 工具栏按钮可横向滚动
[ ] Bold/Italic/Heading/List 等格式按钮全部可用
[ ] 接入 Magic Keyboard → 浮动工具栏自动隐藏
[ ] 拔掉 Magic Keyboard → 工具栏重新出现
[ ] 长按图片 → 弹出操作菜单
[ ] 所有按钮/文件项有触控反馈（无"空 hover"）
[ ] Sidebar 文件项、StatusBar 按钮触控目标 ≥ 44pt
```

#### Phase 6：虚拟键盘（必须真机）

```
[ ] 键盘弹出 → 编辑器高度自动缩减，StatusBar 可见
[ ] 键盘收起 → 布局恢复正常，无残留空白
[ ] 打字时光标始终在可视区域内
[ ] 快速弹出/收起键盘 → 无布局抖动
```

#### Phase 7：AI & MCP（模拟器）

```
[ ] AI Chat 面板可用，流式响应正常
[ ] MCP 设置中 stdio 选项不可见
[ ] MCP SSE 连接可用
[ ] MCP HTTP 连接可用
```

#### 边缘情况（真机 + 模拟器）

```
[ ] 横屏 ↔ 竖屏切换 → 布局正确响应
[ ] 竖屏下 Split 模式不可用/自动退回
[ ] 横屏下 Split 模式正常并排
[ ] App 进后台 → 恢复 → WebView 不白屏
[ ] Stage Manager 分屏模式下可用
[ ] 深色/浅色主题切换正常
[ ] 文件保存对话框正常弹出（iOS 原生文件选择器）
```

### 设备覆盖矩阵

| 设备 | 屏幕 | 测试重点 |
|------|------|---------|
| iPad Pro 12.9" | 2048×2732 | 最大屏，Split 模式、大屏布局 |
| iPad Pro 11" | 1668×2388 | 主力机型 |
| iPad Air | 1640×2360 | 中端主流 |
| iPad 10th gen | 1620×2160 | 最小屏 iPad，验证最小布局 |
| iPad mini 6th | 1488×2266 | 最紧凑，验证触控目标是否够大 |

### 测试层级总结

| 层级 | 工具 | 覆盖内容 | 何时用 |
|------|------|---------|--------|
| L1 模拟器 | `pnpm tauri ios dev --open` | 布局、逻辑、编译、Tab、MCP | 每次改代码 |
| L2 真机 | `pnpm tauri ios dev --force-ip-prompt` | 触控、键盘、横竖屏、性能 | 每个 Phase 完成时 |
| L3 TestFlight | `pnpm tauri ios build` + 上传 | 多设备兼容、外部用户 | 发布前 |
| 调试 | Safari Web Inspector + Xcode Console | JS/CSS/网络/Rust 日志 | 随时 |
