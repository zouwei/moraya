# v0.10.0 Mermaid å›¾è¡¨æ”¯æŒ

> è¿­ä»£ç‰ˆæœ¬: v0.10.0
> ä¸Šä¸€ç‰ˆæœ¬: v0.9.0
> åˆ›å»ºæ—¥æœŸ: 2026-02-13
> çŠ¶æ€: âœ… å·²å®Œæˆ

---

## ç‰ˆæœ¬æ¦‚è¦

ä¸ºä»£ç å—æ–°å¢ Mermaid å›¾è¡¨æ¸²æŸ“èƒ½åŠ›ã€‚å½“ä»£ç å—è¯­è¨€å£°æ˜ä¸º `mermaid` æ—¶ï¼Œè‡ªåŠ¨æ¸²æŸ“ä¸ºå¯è§†åŒ–å›¾è¡¨ã€‚æ”¯æŒç¼–è¾‘/é¢„è§ˆåŒæ¨¡å¼åˆ‡æ¢ï¼ŒMermaid åº“é€šè¿‡ Vite åŠ¨æ€ import æ‡’åŠ è½½ï¼Œä»…åœ¨æ–‡æ¡£åŒ…å« Mermaid ä»£ç å—æ—¶æ‰åŠ è½½ã€‚

---

## éœ€æ±‚èƒŒæ™¯

### ç›®æ ‡å›¾è¡¨ç±»å‹

| å›¾è¡¨ | Mermaid æ ‡è¯† | è¯´æ˜ |
|------|-------------|------|
| æµç¨‹å›¾ | `flowchart` / `graph` | Flowchart |
| æ—¶åºå›¾ | `sequenceDiagram` | Sequence Diagram |
| ç”˜ç‰¹å›¾ | `gantt` | Gantt Chart |
| çŠ¶æ€å›¾ | `stateDiagram-v2` | State Diagram |
| ç±»å›¾ | `classDiagram` | Class Diagram |
| ER å›¾ | `erDiagram` | Entity Relationship |
| é¥¼å›¾ | `pie` | Pie Chart |
| å¿ƒæ™ºå›¾ | `mindmap` | Mindmap |
| ç”¨æˆ·æ—…ç¨‹å›¾ | `journey` | User Journey |

### ç«å“å‚è€ƒ

- **Typora**: å†…ç½® Mermaid 11.3ï¼Œ` ```mermaid ` ä»£ç å—è‡ªåŠ¨æ¸²æŸ“ï¼Œå³é”®å¯¼å‡º SVG/PNG
- **GitHub**: æœåŠ¡ç«¯æ¸²æŸ“ Mermaid ä¸º SVG
- **HackMD**: å®¢æˆ·ç«¯æ¸²æŸ“ï¼Œé¢„è§ˆé¢æ¿å®æ—¶æ›´æ–°

---

## å…³é”®å†³ç­–

### D1: ä¸ä½¿ç”¨ `@milkdown/plugin-diagram`

| å¯¹æ¯” | `@milkdown/plugin-diagram` | è‡ªå®šä¹‰æ’ä»¶ |
|------|---------------------------|-----------|
| ç‰ˆæœ¬ | v7.7.0ï¼ˆè½ååŠå¹´ï¼‰ | é€‚é…å½“å‰ v7.18.0 |
| Mermaid ä¾èµ– | ç¡¬ä¾èµ– `mermaid ^10.9.0` | å¯ç”¨æœ€æ–° v11.12.2 |
| æ‡’åŠ è½½ | ä¸æ”¯æŒ | å®Œå…¨æ”¯æŒ `import()` |
| ä½“ç§¯æ§åˆ¶ | æ— æ³•ä¼˜åŒ– | å¯ç²¾ç»†æ§åˆ¶ |

**ç»“è®º**: è‡ªå»ºæ’ä»¶ï¼Œå¤ç”¨ v0.9.0 çš„ CodeBlockView NodeView åŸºç¡€æ¶æ„ã€‚

#### v0.9.0 å®é™…å®ç°è¦ç‚¹ï¼ˆå½±å“é›†æˆæ–¹æ¡ˆï¼‰

v0.9.0 å·²å®Œæˆçš„ CodeBlockView å®é™…å®ç°ä¸åˆå§‹è®¾è®¡æœ‰ä»¥ä¸‹å…³é”®ç»†èŠ‚ï¼Œç›´æ¥å½±å“ Mermaid é›†æˆæ–¹å¼ï¼š

| ç‰¹æ€§ | å®é™…å®ç° | å¯¹ Mermaid çš„å½±å“ |
|------|----------|-----------------|
| å·¥å…·æ å®šä½ | `position: absolute; top: 0`ï¼Œwrapper æœ‰ `padding-top: 1.5rem` | Mermaid é¢„è§ˆ/ç¼–è¾‘æŒ‰é’®éœ€åŠ å…¥åŒä¸€å·¥å…·æ  |
| å·¥å…·æ å¯è§æ€§ | é»˜è®¤ `opacity: 0`ï¼Œhover/selected/`picker-open` æ—¶æ˜¾ç¤º | Mermaid æ¨¡å¼ä¸‹å·¥å…·æ éœ€**å§‹ç»ˆå¯è§**ï¼ˆæ·»åŠ ä¸“ç”¨ CSS classï¼‰ |
| äº‹ä»¶å¤„ç† | `mousedown`ï¼ˆé clickï¼‰ï¼Œtoolbar è®¾ `contenteditable="false"` | ç¼–è¾‘/é¢„è§ˆåˆ‡æ¢æŒ‰é’®éœ€ç”¨ `mousedown` + `preventDefault()` |
| `stopEvent()` | é `<code>` å†…çš„äº‹ä»¶å‡è¢«æ‹¦æˆª | Mermaid é¢„è§ˆå®¹å™¨ä¸Šçš„ç‚¹å‡»è‡ªåŠ¨è¢«æ‹¦æˆªï¼Œä¸ä¼šå¹²æ‰° ProseMirror |
| `ignoreMutation()` | é `<code>` å†…çš„ DOM å˜æ›´å‡è¢«å¿½ç•¥ | Mermaid SVG æ’å…¥/ç§»é™¤ä¸ä¼šè§¦å‘ ProseMirror é‡è§£æï¼Œ**æ— éœ€é¢å¤–å¤„ç†** |
| è¯­è¨€æ³¨å†Œ | `mermaid` å·²åœ¨ `ALL_LANGUAGES` åˆ—è¡¨ä¸­ | è¯­è¨€é€‰æ‹©å™¨å·²å¯é€‰æ‹© Mermaidï¼Œæ— éœ€ä¿®æ”¹ |
| è¯­è¨€é€‰æ‹©å™¨ | æŒ‚è½½åˆ° wrapperï¼ˆé document.bodyï¼‰ï¼Œ`position: fixed` | ä¸å½±å“ Mermaidï¼Œä½†éœ€æ³¨æ„ wrapper å†… DOM å±‚çº§ |

### D2: ä½“ç§¯ä¼˜åŒ–ç­–ç•¥ï¼ˆVite å®æµ‹æ•°æ®ï¼‰

Mermaid v11 å®Œæ•´åŒ… ~2.7 MB minifiedï¼Œå¯¹å½“å‰ 5.25 MB DMG å½±å“è¾ƒå¤§ã€‚

#### Vite åŠ¨æ€ import + ä»£ç åˆ†å‰²

```typescript
// mermaid-renderer.ts â€” ä»…åœ¨æ£€æµ‹åˆ° mermaid ä»£ç å—æ—¶åŠ è½½
const mermaid = (await import('mermaid')).default;
```

Vite è‡ªåŠ¨å°† mermaid æ‹†åˆ†ä¸º 50 ä¸ªç‹¬ç«‹ chunkï¼ˆæ ¸å¿ƒ + d3/dagre å…±äº«ä¾èµ– + å„å›¾è¡¨ç±»å‹ï¼‰ã€‚Tauri ä»æœ¬åœ°ç£ç›˜åŠ è½½ï¼Œå»¶è¿Ÿ ~100-200msã€‚

**Vite æ„å»ºå®æµ‹ç»“æœ**ï¼š

| æŒ‡æ ‡ | æ—  Mermaid | æœ‰ Mermaid |
|------|-----------|-----------|
| æ€» JS å¤§å° | 2,388 KB | 4,729 KB (+2,341 KB) |
| chunk æ•°é‡ | 27 | 77 (+50) |
| ä¸» chunk | 1,539 KB | 1,539 KBï¼ˆä¸å˜ï¼‰ |
| `_app/` ç›®å½• | 3.6 MB | 6.0 MB (+2.4 MB) |

**ä¸» chunk ä½“ç§¯ä¸å˜** â€” Mermaid 100% ç‹¬ç«‹äºä¸» bundleã€‚

#### Mermaid å†…ç½®äºŒçº§æ‡’åŠ è½½

Mermaid v11 çš„ npm å…¥å£ `mermaid.core.mjs` (44 KB) æœ¬èº«å°±æ˜¯æ‡’åŠ è½½è°ƒåº¦å™¨ã€‚å®ƒæ³¨å†Œæ‰€æœ‰å›¾è¡¨ç±»å‹çš„æ£€æµ‹å™¨ï¼ˆdetectorï¼‰ï¼Œä½†æ¯ç§å›¾è¡¨çš„æ¸²æŸ“ä»£ç æ˜¯ç‹¬ç«‹ chunkï¼Œä»…åœ¨æ£€æµ‹åˆ°å¯¹åº”è¯­æ³•æ—¶æ‰ `dynamic import()` åŠ è½½ï¼š

| å›¾è¡¨ç±»å‹ | chunk å¤§å° | åŠ è½½æ—¶æœº |
|----------|-----------|---------|
| flowchart | ~105 KB | ä½¿ç”¨æ—¶ |
| sequenceDiagram | ~171 KB | ä½¿ç”¨æ—¶ |
| gantt | ~75 KB | ä½¿ç”¨æ—¶ |
| erDiagram | ~48 KB | ä½¿ç”¨æ—¶ |
| stateDiagram | ~20 KB | ä½¿ç”¨æ—¶ |
| pie | ~8 KB | ä½¿ç”¨æ—¶ |
| mindmap | ~40 KB | ä½¿ç”¨æ—¶ |
| journey | ~46 KB | ä½¿ç”¨æ—¶ |
| å…¶ä»– (class, C4, block ç­‰) | ~600 KB åˆè®¡ | ä½¿ç”¨æ—¶ |

**å…±äº«ä¾èµ–**ï¼ˆd3, dagre, cytoscape ç­‰ ~1,200 KBï¼‰åœ¨é¦–æ¬¡ `import('mermaid')` æ—¶åŠ è½½ã€‚

#### ~~æŒ‰éœ€å›¾è¡¨ç±»å‹ API~~ï¼ˆå·²æ’é™¤ï¼‰

ç»æ·±åº¦è°ƒç ”ç¡®è®¤ï¼š**Mermaid v11 ä¸å­˜åœ¨å¯é çš„ç”¨æˆ· API æ¥é€‰æ‹©æ€§åŠ è½½å›¾è¡¨ç±»å‹**ã€‚
- æ—  `lazyLoadedDiagrams` é…ç½®é€‰é¡¹
- `registerExternalDiagrams()` ç”¨äº**æ–°å¢**å›¾è¡¨ï¼Œæ— æ³•**å‡å°‘**å†…ç½®å›¾è¡¨
- `registerDiagram()` æ˜¯å†…éƒ¨ APIï¼Œä¸å¯¹å¤–å¯¼å‡º
- ç¼ºå°‘ `sideEffects: false` æ ‡è®°ï¼ŒVite/Rollup æ— æ³• tree-shake æœªä½¿ç”¨çš„å›¾è¡¨

ä½† Mermaid å†…éƒ¨å·²åšå¥½ä»£ç åˆ†å‰²ï¼ˆè§ä¸Šè¡¨ï¼‰ï¼Œæ— éœ€æ‰‹åŠ¨ä¼˜åŒ–ã€‚

#### KaTeX å»é‡ï¼ˆè‡ªåŠ¨ç”Ÿæ•ˆï¼‰

Mermaid å†…éƒ¨ä¾èµ– KaTeXï¼ŒMoraya å·²å®‰è£… `katex ^0.16.28`ã€‚Vite å»é‡æœºåˆ¶è‡ªåŠ¨å¤ç”¨ï¼Œå®æµ‹èŠ‚çœ ~300 KBï¼ˆé¢„ä¼° 2.7 MB â†’ å®æµ‹ 2.4 MBï¼‰ã€‚

### D3: ä½“ç§¯é¢„ä¼°ï¼ˆåŸºäº Vite å®æµ‹ï¼‰

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| ç£ç›˜å¢é‡ï¼ˆJS chunksï¼‰ | **+2.4 MB** |
| åˆå§‹åŠ è½½å¢é‡ | **0 KB** |
| é¦–æ¬¡æ¸²æŸ“åŠ è½½ï¼ˆcore + å…±äº«ä¾èµ–ï¼‰ | ~1.2 MB |
| æ¯ç§å›¾è¡¨ç±»å‹é¢å¤–åŠ è½½ | 8 - 171 KB |

**DMG ä½“ç§¯é¢„ä¼°**: 5.25 MB â†’ **~7.7 MB**ï¼ˆä»åœ¨ 10 MB ç›®æ ‡å†…ï¼‰ã€‚

#### è¿è¡Œæ—¶åŠ è½½ä½“éªŒï¼ˆTauri æœ¬åœ°ç£ç›˜ï¼‰

| åœºæ™¯ | åŠ è½½é‡ | é¢„è®¡å»¶è¿Ÿ |
|------|--------|---------|
| æ–‡æ¡£æ—  Mermaid ä»£ç å— | 0 KB | 0 ms |
| é¦–æ¬¡é‡åˆ° Mermaidï¼ˆcore + d3ï¼‰ | ~1.2 MB | ~100-200 ms |
| æ¸²æŸ“é¦–ä¸ª flowchart | +~105 KB | ~20 ms |
| æ¸²æŸ“ç¬¬äºŒç§å›¾è¡¨ç±»å‹ | +~20-171 KB | ~10-20 ms |

---

## åŠŸèƒ½è®¾è®¡

### F1: Mermaid ä»£ç å—æ¸²æŸ“

#### ç¼–è¾‘/é¢„è§ˆåŒæ¨¡å¼

v0.9.0 å·¥å…·æ å®é™…ç»“æ„ï¼š`langLabel`ï¼ˆå·¦ï¼‰+ `copyBtn`ï¼ˆå³ï¼‰ï¼Œ`justify-content: space-between`ã€‚
Mermaid æ¨¡å¼æ–°å¢ç¼–è¾‘/é¢„è§ˆåˆ‡æ¢æŒ‰é’®ï¼Œæ’å…¥ copyBtn ä¹‹å‰ã€‚å·¥å…·æ é»˜è®¤ `opacity: 0` hover æ—¶æ˜¾ç¤ºï¼Œ
Mermaid é¢„è§ˆæ¨¡å¼ä¸‹éœ€æ·»åŠ  `mermaid-preview` class ä½¿å·¥å…·æ **å§‹ç»ˆå¯è§**ã€‚

```
é¢„è§ˆæ¨¡å¼ï¼ˆé»˜è®¤ï¼Œå·¥å…·æ å§‹ç»ˆå¯è§ï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Mermaid                          [âœï¸ Edit] [ğŸ“‹]  â”‚  â† code-block-toolbar (always visible)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                    â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”                    â”‚  â† div.mermaid-preview (visible)
â”‚        â”‚ Start â”‚â”€â”€â”€â”€â–¶â”‚  End  â”‚                    â”‚    SVG æ¸²æŸ“
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                    â”‚  â† pre.code-block-pre (display:none)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¼–è¾‘æ¨¡å¼ï¼ˆç‚¹å‡»ç¼–è¾‘æŒ‰é’®ï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Mermaid                          [ğŸ‘ Preview] [ğŸ“‹] â”‚  â† code-block-toolbar (hoveræ˜¾ç¤º)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ graph LR                                          â”‚
â”‚   A[Start] --> B[End]                             â”‚  â† pre.code-block-pre (visible, contentDOM)
â”‚                                                    â”‚  â† div.mermaid-preview (display:none)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### äº¤äº’è§„åˆ™

- æ–‡æ¡£ä¸­å­˜åœ¨ ` ```mermaid ` ä»£ç å— â†’ é¦–æ¬¡æ¸²æŸ“æ—¶è§¦å‘ `import('mermaid')`
- åŠ è½½æœŸé—´æ˜¾ç¤º loading åŠ¨ç”»ï¼ˆæ—‹è½¬å›¾æ ‡ + "Loading diagram..."ï¼‰
- æ¸²æŸ“æˆåŠŸ â†’ æ˜¾ç¤º SVG å›¾è¡¨
- æ¸²æŸ“å¤±è´¥ï¼ˆè¯­æ³•é”™è¯¯ï¼‰â†’ æ˜¾ç¤ºçº¢è‰²é”™è¯¯æç¤º + åŸå§‹ä»£ç 
- ç¼–è¾‘æ¨¡å¼ï¼šä»£ç å—å¯ç›´æ¥ç¼–è¾‘ Mermaid æºç 
- åˆ‡æ¢å›é¢„è§ˆæ—¶è‡ªåŠ¨é‡æ–°æ¸²æŸ“
- ç‚¹å‡» SVG å›¾è¡¨ â†’ è¿›å…¥ç¼–è¾‘æ¨¡å¼ï¼ˆä¾¿äºä¿®æ”¹ï¼‰

### F2: ä¸»é¢˜é€‚é…

Mermaid å›¾è¡¨éœ€è·Ÿéš Moraya çš„æ˜/æš—ä¸»é¢˜åˆ‡æ¢ï¼š

```typescript
mermaid.initialize({
  startOnLoad: false,
  theme: isDarkMode ? 'dark' : 'default',
  themeVariables: {
    // æ˜ å°„ Moraya CSS å˜é‡
    primaryColor: 'var(--accent-color)',
    primaryTextColor: 'var(--text-primary)',
    primaryBorderColor: 'var(--border-color)',
    lineColor: 'var(--text-secondary)',
    secondaryColor: 'var(--bg-secondary)',
    tertiaryColor: 'var(--bg-hover)',
  },
});
```

ä¸»é¢˜åˆ‡æ¢æ—¶é‡æ–°è°ƒç”¨ `mermaid.initialize()` å¹¶é‡æ–°æ¸²æŸ“æ‰€æœ‰ Mermaid ä»£ç å—ã€‚

### F3: HTML å¯¼å‡º

å¯¼å‡º HTML æ—¶ï¼ŒMermaid ä»£ç å—éœ€æ¸²æŸ“ä¸ºå†…è” SVGï¼š

- å¯¼å‡ºå‰è°ƒç”¨ `mermaid.render()` å°†æ¯ä¸ª Mermaid ä»£ç å—è½¬æ¢ä¸º SVG
- SVG å†…è”åˆ° HTML ä¸­ï¼ˆæ— éœ€å¤–éƒ¨ JSï¼‰
- æ¸²æŸ“å¤±è´¥çš„ä»£ç å—ä¿ç•™ä¸º `<pre><code>` åŸå§‹ä»£ç 

---

## æŠ€æœ¯æ–¹æ¡ˆ

### æ¶æ„

```
src/lib/editor/plugins/
â”œâ”€â”€ code-block-view.ts           # v0.9.0 å·²æœ‰ï¼šCodeBlock NodeViewï¼ˆç›´æ¥ä¿®æ”¹ï¼‰
â”œâ”€â”€ highlight.ts                 # v0.9.0 å·²æœ‰ï¼šè¯­æ³•é«˜äº®ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰
â””â”€â”€ mermaid-renderer.ts          # æ–°å¢ï¼šMermaid æ¸²æŸ“å™¨ï¼ˆæ‡’åŠ è½½å°è£…ï¼‰

src/lib/styles/editor.css        # ä¿®æ”¹ï¼šMermaid é¢„è§ˆ/åŠ è½½/é”™è¯¯æ ·å¼
src/lib/services/export-service.ts # ä¿®æ”¹ï¼šå¯¼å‡ºæ—¶æ¸²æŸ“ Mermaid ä¸º SVG
```

> **æ³¨æ„**: `setup.ts` **æ— éœ€ä¿®æ”¹**ã€‚`mermaid-renderer.ts` æ˜¯ä¸€ä¸ªå·¥å…·æ¨¡å—ï¼Œç”± `code-block-view.ts` æŒ‰éœ€ `import()` åŠ è½½ï¼Œä¸æ˜¯ç‹¬ç«‹çš„ Milkdown æ’ä»¶ã€‚code-block-view å·²ä½œä¸º Tier 1 æ’ä»¶æ³¨å†Œã€‚

### Mermaid æ¸²æŸ“å™¨å°è£…

```typescript
// mermaid-renderer.ts
let mermaidModule: typeof import('mermaid') | null = null;
let loadingPromise: Promise<void> | null = null;

export async function ensureMermaidLoaded(): Promise<void> {
  if (mermaidModule) return;
  if (loadingPromise) return loadingPromise;

  loadingPromise = (async () => {
    const mod = await import('mermaid');
    mermaidModule = mod;
    mod.default.initialize({
      startOnLoad: false,
      theme: getCurrentTheme() === 'dark' ? 'dark' : 'default',
    });
  })();

  return loadingPromise;
}

export async function renderMermaid(
  code: string,
  id: string
): Promise<{ svg: string } | { error: string }> {
  await ensureMermaidLoaded();
  try {
    const { svg } = await mermaidModule!.default.render(id, code);
    return { svg };
  } catch (e) {
    return { error: e instanceof Error ? e.message : 'Render failed' };
  }
}
```

### CodeBlockView é›†æˆ

åœ¨ v0.9.0 çš„ `code-block-view.ts` åŸºç¡€ä¸Šä¿®æ”¹ã€‚å®é™… NodeView ç»“æ„å¦‚ä¸‹ï¼š

```
wrapper (.code-block-wrapper)                      â† dom
â”œâ”€â”€ toolbar (.code-block-toolbar, contenteditable="false")
â”‚   â”œâ”€â”€ langLabel (.code-lang-label)               â† "Mermaid"
â”‚   â”œâ”€â”€ mermaidToggleBtn (.mermaid-toggle-btn)     â† æ–°å¢ï¼šç¼–è¾‘/é¢„è§ˆåˆ‡æ¢
â”‚   â””â”€â”€ copyBtn (.code-copy-btn)
â”œâ”€â”€ pre (.code-block-pre)
â”‚   â””â”€â”€ code (.code-block-code)                    â† contentDOM
â””â”€â”€ div (.mermaid-preview)                         â† æ–°å¢ï¼šSVG æ¸²æŸ“å®¹å™¨
```

#### DOM ä¿®æ”¹ç‚¹

1. **æ–°å¢é¢„è§ˆå®¹å™¨**: åœ¨ `wrapper.appendChild(pre)` ååˆ›å»º `div.mermaid-preview`
2. **æ–°å¢åˆ‡æ¢æŒ‰é’®**: åœ¨ `toolbar.appendChild(copyBtn)` å‰æ’å…¥ `mermaidToggleBtn`
3. **åˆ‡æ¢é€»è¾‘**: ç‚¹å‡»åˆ‡æ¢æŒ‰é’®æˆ– SVG å›¾è¡¨ â†’ ç¿»è½¬ `isEditing` çŠ¶æ€

```typescript
// code-block-view.ts â€” NodeView å†…éƒ¨æ–°å¢
const mermaidPreview = document.createElement('div');
mermaidPreview.className = 'mermaid-preview';
mermaidPreview.setAttribute('contenteditable', 'false');
wrapper.appendChild(mermaidPreview);

let isEditing = false;
let isMermaid = (node.attrs.language === 'mermaid');

// ç¼–è¾‘/é¢„è§ˆåˆ‡æ¢æŒ‰é’®ï¼ˆä»… Mermaid æ—¶æ˜¾ç¤ºï¼‰
const toggleBtn = document.createElement('button');
toggleBtn.className = 'mermaid-toggle-btn';
toggleBtn.type = 'button';
toolbar.insertBefore(toggleBtn, copyBtn);

function syncMermaidMode() {
  const show = isMermaid && !isEditing;
  pre.style.display = (isMermaid && !isEditing) ? 'none' : '';
  mermaidPreview.style.display = show ? '' : 'none';
  toggleBtn.style.display = isMermaid ? '' : 'none';
  wrapper.classList.toggle('mermaid-preview-mode', show);
  toggleBtn.textContent = isEditing ? 'ğŸ‘ Preview' : 'âœï¸ Edit';
  if (show) triggerMermaidRender();
}

toggleBtn.addEventListener('mousedown', (e) => {
  e.preventDefault();
  e.stopPropagation();
  isEditing = !isEditing;
  syncMermaidMode();
  if (isEditing) view.focus();
});

// ç‚¹å‡» SVG å›¾è¡¨è¿›å…¥ç¼–è¾‘æ¨¡å¼
mermaidPreview.addEventListener('mousedown', (e) => {
  e.preventDefault();
  e.stopPropagation();
  isEditing = true;
  syncMermaidMode();
  view.focus();
});
```

#### update() æ–¹æ³•ä¿®æ”¹

```typescript
update(updatedNode) {
  if (updatedNode.type.name !== 'code_block') return false;
  node = updatedNode;
  langLabel.textContent = findLanguageLabel(updatedNode.attrs.language || '');

  // Mermaid æ£€æµ‹ä¸æ¨¡å¼åŒæ­¥
  const wasMermaid = isMermaid;
  isMermaid = (updatedNode.attrs.language === 'mermaid');
  if (isMermaid !== wasMermaid) isEditing = false; // è¯­è¨€åˆ‡æ¢æ—¶é‡ç½®
  syncMermaidMode();
  return true;
},
```

#### å·²æœ‰ NodeView æ–¹æ³•çš„å…¼å®¹æ€§

| æ–¹æ³• | æ˜¯å¦éœ€è¦ä¿®æ”¹ | è¯´æ˜ |
|------|-------------|------|
| `stopEvent()` | âŒ | å·²æ‹¦æˆªé `<code>` å…ƒç´ ä¸Šçš„äº‹ä»¶ï¼ŒMermaid é¢„è§ˆå®¹å™¨è‡ªåŠ¨è¦†ç›– |
| `ignoreMutation()` | âŒ | å·²å¿½ç•¥é `<code>` å…ƒç´ çš„ DOM å˜æ›´ï¼ŒSVG æ’å…¥/ç§»é™¤ä¸è§¦å‘é‡è§£æ |
| `selectNode()` / `deselectNode()` | âŒ | é€‰ä¸­æ ·å¼ä¸å½±å“ Mermaid |
| `destroy()` | âš ï¸ å¯é€‰ | å¯æ¸…ç† Mermaid æ¸²æŸ“ç¼“å­˜ï¼ˆå¦‚æœ‰å†…å­˜æ³„æ¼ï¼‰ |

### CSP å…¼å®¹æ€§

Mermaid æ¸²æŸ“ç”Ÿæˆ SVG å†…è” `<style>`ã€‚éœ€è¦ç¡®ä¿ CSP `style-src` åŒ…å« `'unsafe-inline'`ã€‚

å½“å‰ `tauri.conf.json` CSP:
```
"csp": "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; connect-src ipc: http://ipc.localhost; img-src 'self' asset: http://asset.localhost data: blob:"
```

`style-src 'unsafe-inline'` å·²åŒ…å«ï¼ŒMermaid SVG å†…è”æ ·å¼å¯æ­£å¸¸å·¥ä½œã€‚

---

## ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| `src/lib/editor/plugins/mermaid-renderer.ts` | æ–°å¢ | Mermaid æ‡’åŠ è½½å°è£… + æ¸²æŸ“ APIï¼ˆå·¥å…·æ¨¡å—ï¼Œé Tier 1 æ’ä»¶ï¼‰ |
| `src/lib/editor/plugins/code-block-view.ts` | ä¿®æ”¹ | Mermaid ä»£ç å—æ£€æµ‹ + é¢„è§ˆ/ç¼–è¾‘åŒæ¨¡å¼ |
| `src/lib/styles/editor.css` | ä¿®æ”¹ | Mermaid é¢„è§ˆ/loading/é”™è¯¯æ ·å¼ |
| `src/lib/services/export-service.ts` | ä¿®æ”¹ | å¯¼å‡ºæ—¶æ¸²æŸ“ Mermaid ä¸ºå†…è” SVG |
| `src/lib/i18n/locales/en.json` | ä¿®æ”¹ | `mermaid.loading`, `mermaid.error`, `mermaid.edit`, `mermaid.preview` |
| `src/lib/i18n/locales/zh-CN.json` | ä¿®æ”¹ | å¯¹åº”ä¸­æ–‡ç¿»è¯‘ |
| `package.json` | ä¿®æ”¹ | æ–°å¢ `mermaid: ^11.12.2` ä¾èµ– |

## æ–°å¢ä¾èµ–

| åŒ…å | ç‰ˆæœ¬ | ç±»å‹ | å¤§å°ï¼ˆVite å®æµ‹ï¼‰ |
|------|------|------|-----------------|
| `mermaid` | ^11.12.2 | dependencies | +2.4 MBï¼ˆ50 ä¸ªæ‡’åŠ è½½ chunkï¼Œä¸» chunk ä¸å˜ï¼‰ |

> KaTeX å»é‡å·²ç”Ÿæ•ˆï¼ˆé¢„ä¼° 2.7 MB â†’ å®æµ‹ 2.4 MBï¼‰ã€‚åˆå§‹åŠ è½½é›¶å¢é‡ã€‚

---

## éªŒè¯æ–¹æ¡ˆ

1. `pnpm check` â€” 0 TypeScript é”™è¯¯
2. `cargo check` â€” Rust ç¼–è¯‘é€šè¿‡
3. æ–°å»º ` ```mermaid ` ä»£ç å—ï¼Œè¾“å…¥æµç¨‹å›¾ä»£ç  â†’ SVG å›¾è¡¨æ­£ç¡®æ¸²æŸ“
4. æ–‡æ¡£æ—  Mermaid ä»£ç å— â†’ `mermaid` chunk æœªåŠ è½½ï¼ˆæ£€æŸ¥ Network/æ§åˆ¶å°ï¼‰
5. ç‚¹å‡»ç¼–è¾‘æŒ‰é’® â†’ åˆ‡æ¢ä¸ºä»£ç ç¼–è¾‘æ¨¡å¼ï¼Œå¯ä¿®æ”¹ Mermaid æºç 
6. åˆ‡æ¢å›é¢„è§ˆ â†’ å›¾è¡¨é‡æ–°æ¸²æŸ“
7. Mermaid è¯­æ³•é”™è¯¯ â†’ æ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œä¸å´©æºƒ
8. æš—è‰²ä¸»é¢˜ â†’ å›¾è¡¨é…è‰²æ­£ç¡®åˆ‡æ¢
9. å¯¼å‡º HTML â†’ Mermaid å›¾è¡¨æ¸²æŸ“ä¸ºå†…è” SVG
10. æµ‹è¯•å…¨éƒ¨ 9 ç§å›¾è¡¨ç±»å‹ï¼ˆflowchart, sequenceDiagram, gantt, stateDiagram-v2, classDiagram, erDiagram, pie, mindmap, journeyï¼‰
11. æ„å»ºåæ£€æŸ¥ DMG ä½“ç§¯å˜åŒ–
12. éªŒè¯åˆå§‹åŠ è½½æ€§èƒ½ä¸é€€åŒ–ï¼ˆmermaid chunk æœªåœ¨å¯åŠ¨æ—¶åŠ è½½ï¼‰

---

## å®æ–½ä¼˜å…ˆçº§

1. **P0**: mermaid-renderer.ts + code-block-view.ts Mermaid æ£€æµ‹ + æ¸²æŸ“
2. **P1**: ç¼–è¾‘/é¢„è§ˆåŒæ¨¡å¼åˆ‡æ¢
3. **P1**: ä¸»é¢˜é€‚é…ï¼ˆæ˜/æš—åˆ‡æ¢ï¼‰
4. **P2**: HTML å¯¼å‡º Mermaid â†’ SVG
5. **P2**: ä½“ç§¯ä¼˜åŒ–ï¼ˆéªŒè¯æŒ‰éœ€å›¾è¡¨ç±»å‹åŠ è½½ï¼‰
