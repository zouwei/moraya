# v0.11.0 — 文件面板增强

> 迭代版本: v0.11.0
> 上一版本: v0.10.0
> 创建日期: 2026-02-19
> 状态: ✅ 已完成

## 概述

增强侧边栏文件面板，使其从基础的文件浏览器升级为可承载本地笔记管理的工具级面板。新增目录记忆、文件实时刷新、列表/树双视图模式、右键上下文菜单等功能。

---

## 功能清单

### F1: 目录记忆

**需求**：编辑器记住上次打开的文件夹，重启后自动恢复。

**交互设计**：
- 用户打开文件夹后，路径自动持久化到设置中
- 下次启动时，自动读取并恢复上次打开的文件夹及其文件树
- 目录已被删除时静默忽略，不弹出错误
- 设置面板「通用」tab 新增复选框：「记住上次打开的文件夹」（默认开启）
- 关闭该选项后清除已保存的路径

**技术方案**：
- `settings-store.ts` 新增字段：`rememberLastFolder: boolean`（默认 true）、`lastOpenedFolder: string | null`
- `Sidebar.svelte` openFolder() 成功后写入 `lastOpenedFolder`
- `+page.svelte` onMount 时检查并恢复：invoke `read_dir_recursive` → `filesStore.setOpenFolder()`

---

### F2: 文件实时刷新

**需求**：打开的目录中有新增、删除、重命名文件时，侧边栏自动刷新。

**交互设计**：
- 打开文件夹后自动开始监听文件系统变化
- 外部创建/删除/重命名 `.md` 文件后，侧边栏在 ~1 秒内自动更新
- 切换文件夹时自动停止旧的监听并启动新的
- 关闭应用或销毁侧边栏时自动停止监听

**技术方案**：
- 新建 `src/lib/services/file-watcher.ts`，封装 Tauri FS `watch()` API
- 使用 `@tauri-apps/plugin-fs` 的 `watch(path, callback, { recursive: true })`
- 权限 `fs:allow-watch` 已在 `capabilities/default.json` 中声明
- 文件变化事件 → 500ms 防抖 → 重新 invoke `read_dir_recursive` → `filesStore.setFileTree(tree)`

---

### F3: 右键上下文菜单

**需求**：文件/文件夹/空白区域支持右键菜单，集成常用文件操作。

**交互设计**：

| 操作 | 文件 | 文件夹 | 空白区 |
|------|:---:|:---:|:---:|
| 新建文件 | ✓ | ✓ | ✓ |
| 搜索文件 | ✓ | ✓ | ✓ |
| 重命名 | ✓ | ✓ | — |
| 创建副本 | ✓ | — | — |
| 删除 | ✓ | ✓ | — |
| 复制路径 | ✓ | ✓ | — |
| 在 Finder 中显示 | ✓ | ✓ | — |

- **新建文件**：弹出输入框输入文件名，自动追加 `.md` 后缀
- **搜索文件**：展开侧边栏顶部搜索输入框
- **重命名**：弹出输入框，预填当前文件名
- **创建副本**：复制文件内容，文件名加 " copy" 后缀
- **删除**：弹出 Tauri 原生确认对话框（不可撤销警告）
- **复制路径**：复制完整文件路径到剪贴板
- **在 Finder 中显示**：在系统文件管理器中定位文件（macOS: Finder, Windows: 资源管理器）

**技术方案**：
- 新建 `FileContextMenu.svelte` 组件，复用 `ImageContextMenu.svelte` 的 backdrop + 固定定位 + 菜单样式
- 新增 3 个 Rust 命令（均需 `validate_path` 安全校验）：
  - `create_markdown_file(dir_path, file_name)` → 创建空 .md 文件
  - `rename_file(old_path, new_path)` → 重命名
  - `delete_file(path)` → 删除文件/文件夹
- 创建副本复用现有 `read_file` + `write_file` 命令
- 「在 Finder 中显示」使用 `@tauri-apps/plugin-opener` 的 `revealItemInDir()`

---

### F4: 增强文件显示

**需求**：支持列表视图和树状视图双模式切换，列表模式以笔记风格展示文件预览。

**交互设计**：

**树状视图（Tree View）**：现有模式，按文件夹层级展示。

**列表视图（List View）**：
```
┌──────────────────────────┐
│ 文件标题（去掉 .md 后缀）    │  ← 粗体
│ 首行内容预览文字...          │  ← 小字、灰色
├──────────────────────────┤
│ 另一篇文件                  │
│ 预览内容...                 │
└──────────────────────────┘
```
- 按修改时间倒序排列（最近编辑的文件在最前面）
- 文件名去掉 `.md` 后缀，显示为标题
- 下方显示文件首行内容（去掉 Markdown 标记）的前 100 个字符

**视图切换**：侧边栏 header 区域增加切换按钮（列表/树图标）

**搜索功能**：
- 侧边栏顶部可展开的搜索输入框
- 按文件名实时过滤
- 按 Escape 关闭搜索
- 可通过右键菜单「搜索」或直接点击触发

**面板宽度**：从 260px 加宽到 280px

**技术方案**：
- `files-store.ts` 新增 `sidebarViewMode: 'tree' | 'list'`、`filePreviews: FilePreview[]`
- 新增 Rust 命令 `read_file_previews(paths, max_chars)` — 批量读取文件首行预览 + 修改时间
- 搜索使用 Svelte `$derived` 响应式过滤

---

## 文件清单

| 文件 | 操作 | 功能点 |
|------|------|--------|
| `src/lib/stores/settings-store.ts` | 修改 | F1: +rememberLastFolder, +lastOpenedFolder |
| `src/lib/stores/files-store.ts` | 修改 | F4: +sidebarViewMode, +filePreviews, +FilePreview |
| `src/lib/components/Sidebar.svelte` | 重构 | F1-F4: 双模式、搜索、右键菜单、watcher |
| `src/lib/components/FileContextMenu.svelte` | 新增 | F3: 右键菜单组件 |
| `src/lib/services/file-watcher.ts` | 新增 | F2: FS watch 封装 |
| `src-tauri/src/commands/file.rs` | 修改 | F3+F4: 新增 4 个命令 |
| `src-tauri/src/lib.rs` | 修改 | 注册新命令 |
| `src/lib/components/SettingsPanel.svelte` | 修改 | F1: 记住文件夹复选框 |
| `src/routes/+page.svelte` | 修改 | F1: 启动时恢复目录 |
| `src/lib/styles/variables.css` | 修改 | F4: sidebar-width 260→280 |
| `src/lib/i18n/locales/en.json` | 修改 | 所有新翻译 key |
| `src/lib/i18n/locales/zh-CN.json` | 修改 | 所有新翻译 key |

## 实施顺序

1. **F1: 目录记忆** — 最简单，仅涉及设置和启动逻辑
2. **F2: 文件实时刷新** — 基于 F1 的启动逻辑，新增 watcher 服务
3. **F3: 右键上下文菜单** — 新增 Rust 命令 + 菜单组件
4. **F4: 增强文件显示** — 最复杂的 UI 变更，依赖 F3 的 Rust 命令

## 验证方案

1. **F1**: 打开文件夹 → 退出 → 重启 → 自动恢复 ✓ | 关闭记忆 → 不恢复 ✓ | 目录被删 → 不报错 ✓
2. **F2**: 终端 `touch new.md` → 1s 内刷新 ✓ | 外部删除 → 消失 ✓ | 外部重命名 → 更新 ✓
3. **F3**: 右键文件 → 7 项 ✓ | 右键文件夹 → 6 项 ✓ | 右键空白 → 2 项 ✓ | 每项功能正确 ✓
4. **F4**: 列表/树切换 ✓ | 列表按时间排序 + 预览 ✓ | 搜索过滤 ✓ | 宽度 280px ✓
5. **构建**: `pnpm check` 0 errors，`cargo check` 通过
