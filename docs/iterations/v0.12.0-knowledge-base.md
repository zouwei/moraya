# v0.12.0 知识库增强 (Knowledge Base Enhancement)

## 概述

增强 Moraya 的个人知识库笔记能力，支持多知识库目录切换和 AI 规则文件，适配多角色工作场景（开发、产品、运营等），实现知识库级别的 AI 写作规范自动化。

## 功能列表

| 编号 | 功能 | 描述 |
|------|------|------|
| F1 | 多知识库切换 | Sidebar 支持配置和快速切换多个知识库目录 |
| F2 | MORAYA.md AI 规则 | 每个知识库可定义 AI 写作规范文件 |

---

## F1: 多知识库切换

### 需求背景

用户工作角色是多重的（开发知识库、产品知识库、运营知识库等），当前所有目录共享一个 Sidebar，无法快速切换。

### 交互设计

#### Sidebar 知识库切换器

Sidebar 左上角标题区替换为知识库下拉菜单：

```
┌─────────────────────────────┐
│ ▾ 开发博客          🔍 ≡ 📂 │  ← 下拉按钮 + 现有操作按钮
├─────────────────────────────┤
│ ✓ 开发博客                  │  ← 下拉列表
│   产品文档                  │
│   运营知识库                │
│ ─────────────────────────── │
│   管理知识库...             │
└─────────────────────────────┘
```

- 未配置知识库时，保持原始标题显示（完全向后兼容）
- 知识库列表按最近访问时间降序排列
- 底部 "管理知识库..." 打开管理弹窗

#### 知识库管理弹窗

- 列表展示：名称、目录路径、上次访问时间
- 添加：系统文件夹选择器 → 输入知识库名称
- 重命名：内联编辑名称
- 移除：确认弹窗（提示文件夹本身不会被删除）

#### "保存为知识库" 引导

用户通过文件夹按钮打开一个不在知识库列表中的目录时，底部显示引导横幅，可一键添加为知识库。

### 技术方案

#### 数据模型

```typescript
interface KnowledgeBase {
  id: string;              // crypto.randomUUID()
  name: string;            // 用户命名
  path: string;            // 绝对目录路径
  lastAccessedAt: number;  // 最后访问时间戳
}
```

#### 持久化

- 知识库列表 → `knowledge-bases.json`（Tauri Store）
- 当前激活的知识库 ID 为内存态（每个窗口独立）
- 启动时默认激活最近使用的知识库

#### 多窗口支持

每个 Moraya 窗口可独立选择不同知识库，实现并行工作。

---

## F2: MORAYA.md AI 规则文件

### 需求背景

不同知识库有不同的文档规范。例如个人博客要求特定的 Markdown 结构、YAML frontmatter 格式等。通过在知识库根目录放置 `MORAYA.md` 规则文件，AI 对话自动遵循该规范。

### 交互设计

- 约定式配置：在知识库根目录创建 `MORAYA.md` 文件即可，无需额外设置
- AI 面板标题区显示 `MORAYA.md` 徽章，表示规则已生效
- 编辑 `MORAYA.md` 后无需重启，下次发送消息即刻生效

### 技术方案

- 每次 `sendChatMessage()` 时从知识库根目录读取 `MORAYA.md`
- 内容截断上限 40000 字符（约 10000-12000 tokens）
- 注入到 system prompt 中，位于 base identity 之后、tool rules 之前
- 文件不存在时静默跳过，不影响正常 AI 功能

### MORAYA.md 示例

```markdown
# 博客文章规范

## 文档结构
所有文章必须包含以下 YAML frontmatter：
- title: 文章标题
- date: 发布日期 (YYYY-MM-DD)
- tags: 标签数组
- description: SEO 描述 (120字以内)

## 写作风格
- 使用第一人称
- 段落简短，每段不超过 3 句
- 代码示例使用 TypeScript
- 标题层级从 H2 开始（H1 留给文章标题）
```

---

## 文件变更

### 修改文件

| 文件 | 变更 |
|------|------|
| `src/lib/stores/files-store.ts` | KnowledgeBase 类型、CRUD、持久化 |
| `src/lib/components/Sidebar.svelte` | KB 下拉切换器、保存引导 |
| `src/lib/services/ai/ai-service.ts` | MORAYA.md 读取与注入 |
| `src/lib/components/ai/AIChatPanel.svelte` | MORAYA.md 徽章 |
| `src/routes/+page.svelte` | 启动流程 KB 恢复 |
| `src/lib/components/SettingsPanel.svelte` | 知识库管理入口 |
| `src/lib/i18n/locales/en.json` | i18n 键 |
| `src/lib/i18n/locales/zh-CN.json` | 中文翻译 |

### 新增文件

| 文件 | 用途 |
|------|------|
| `src/lib/components/KnowledgeBaseManager.svelte` | 知识库管理弹窗 |

---

## 验证方案

1. 配置 3 个知识库 → 下拉切换 → 文件树正确更新
2. 添加 KB → 重启应用 → KB 列表恢复，默认选中最近使用的
3. 两个窗口各选不同 KB → 文件树独立
4. 不配置 KB → Sidebar 行为与 v0.11.x 一致
5. 创建 MORAYA.md → AI 对话生成内容遵循规则
6. 修改 MORAYA.md → 下次消息立即生效
7. 删除 MORAYA.md → AI 正常工作无报错
