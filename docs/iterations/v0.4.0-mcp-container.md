# 008 — AI 驱动的动态 MCP 服务容器 (v0.4.0)

> 迭代版本: v0.4.0
> 上一版本: v0.3.4
> 创建日期: 2026-02-10
> 状态: ✅ 已完成

---

## 版本概要

v0.4.0 让 AI 具备**自主创建 MCP 服务**的能力。AI 根据用户意图，自动生成 MCP 服务代码（工具定义 + 处理函数），在本地 Node.js 中运行，从而可以调用任意 HTTP API。用户无需手动配置，拥有更高的自主决策权。

**核心设计**: 内置轻量 MCP Runtime（~90 行 JS），AI 只需生成工具定义（JSON Schema）+ 处理函数（JS），运行时负责所有 MCP 协议细节。**零新增 npm 依赖**。

### 关键设计决策

| 决策项 | 选择 | 备选方案 |
|--------|------|----------|
| 运行时 | Node.js 18+（内置 fetch） | Deno / Python / Rust WASM |
| 触发方式 | AI 自主决策 | 用户手动触发 / 半自动推荐 |
| 生命周期 | 混合模式（默认临时，可保存持久化） | 纯临时 / 纯持久 |

---

## 功能清单

| ID | 功能 | 类型 | 优先级 | 状态 |
|----|------|------|--------|------|
| F1 | MCP Runtime（轻量 MCP 协议服务端） | 核心 | P0 | ✅ |
| F2 | Container Store（动态服务状态管理） | 服务层 | P0 | ✅ |
| F3 | Container Manager（编排核心） | 服务层 | P0 | ✅ |
| F4 | 4 个内部 AI 工具 | AI 集成 | P0 | ✅ |
| F5 | AI 系统提示词增强 | AI 集成 | P1 | ✅ |
| F6 | MCPPanel "AI 服务" Tab | 界面 | P1 | ✅ |
| F7 | Rust `check_command_exists` 命令 | 后端 | P0 | ✅ |
| F8 | Toast 通知 + 初始化集成 | 集成 | P1 | ✅ |
| F9 | i18n 国际化 | 基础 | P1 | ✅ |

---

## 架构总览

```
AI Chat → create_mcp_service tool → Container Manager
  ↓
Write definition.json + handlers.js → {appDataDir}/mcp-services/temp/{uuid}/
  ↓
Spawn: node mcp-runtime.js --dir <serviceDir>
  ↓
Connect as MCP client (reuse existing connectServer)
  ↓
Discover tools → AI can now use them
```

### 服务文件结构

```
{appDataDir}/mcp-services/
├── runtime/mcp-runtime.js       # 首次使用时从 TS 常量写入磁盘
├── temp/{uuid}/                  # 会话级临时服务
│   ├── definition.json           # 工具定义（JSON Schema）
│   └── handlers.js               # 处理函数（Node.js JavaScript）
└── saved/{name}/                 # 用户保存的持久服务
    ├── definition.json
    └── handlers.js
```

---

## F1 MCP Runtime

### 需求描述

一个自包含的 Node.js 脚本（~90 行），实现 MCP 协议 stdio 传输。它读取服务目录下的 `definition.json`（工具定义）和 `handlers.js`（处理函数），自动处理 JSON-RPC 2.0 协议。

### 技术实现

- 以 TypeScript 字符串常量形式存储（`MCP_RUNTIME_JS`），首次使用时写入磁盘
- 实现 3 个 JSON-RPC 方法：`initialize`、`tools/list`、`tools/call`
- 使用 `readline` 读取 stdin，`process.stdout.write` 输出响应
- handler 结果自动 JSON 序列化，异常自动捕获并返回错误
- 支持 `SIGTERM` / `SIGINT` 优雅关闭

### Handler 编写规范

```javascript
// handlers.js 示例
module.exports = {
  get_weather: async ({ city }) => {
    const r = await fetch(`https://api.example.com/weather?city=${city}`);
    return await r.json();
  },
  search_news: async ({ query, limit }) => {
    const r = await fetch(`https://api.example.com/news?q=${query}&limit=${limit}`);
    return await r.json();
  },
};
```

- `module.exports` 导出对象，key 为工具名，value 为 async 函数
- 使用内置 `fetch()`（Node.js 18+）调用 HTTP API
- 通过 `process.env.KEY_NAME` 访问 API 密钥
- 返回字符串或对象（对象自动 JSON.stringify）
- 抛出异常即报告失败

### 文件清单

| 文件 | 类型 | 行数 | 说明 |
|------|------|------|------|
| `src/lib/services/mcp/mcp-runtime.ts` | 新建 | 140 | MCP Runtime JS 字符串常量 |

---

## F2 Container Store

### 需求描述

Svelte writable store，管理所有动态 MCP 服务的状态，包括 Node.js 可用性检测结果。

### 数据结构

```typescript
interface DynamicService {
  id: string;                    // UUID
  name: string;
  description: string;
  status: 'starting' | 'running' | 'stopped' | 'error';
  lifecycle: 'temp' | 'saved';
  mcpServerId: string;           // 对应 mcpStore 中的 MCPServerConfig.id
  serviceDir: string;
  createdAt: number;
  tools: string[];
  env?: Record<string, string>;
  error?: string;
}

interface ContainerState {
  services: DynamicService[];
  nodeAvailable: boolean | null;
  nodeVersion: string | null;
  runtimeReady: boolean;
}
```

### Store 方法

| 方法 | 作用 |
|------|------|
| `setNodeStatus(available, version)` | 设置 Node.js 检测结果 |
| `setRuntimeReady(ready)` | 设置运行时就绪状态 |
| `addService(service)` | 添加新服务 |
| `updateService(id, updates)` | 更新服务状态（Partial） |
| `removeService(id)` | 移除服务 |
| `getState()` | 获取当前快照 |

### 文件清单

| 文件 | 类型 | 行数 | 说明 |
|------|------|------|------|
| `src/lib/services/mcp/container-store.ts` | 新建 | 58 | 动态服务状态 store |

---

## F3 Container Manager（核心编排）

### 需求描述

动态 MCP 服务的完整生命周期管理：初始化检测 → 创建启动 → 保存持久化 → 停止移除 → 退出清理。**完全复用**现有 MCP 基础设施（`mcpStore.addServer` + `connectServer` + `disconnectServer`）。

### 核心函数

| 函数 | 作用 |
|------|------|
| `initContainerManager()` | 检测 Node.js ≥18、加载已保存服务、自动重连 |
| `ensureRuntime()` | 确保 `mcp-runtime.js` 存在于磁盘，返回路径 |
| `createService(params)` | 写入文件 → spawn Node.js → connectServer → 返回 DynamicService |
| `saveService(serviceId)` | 复制 temp→saved，持久化到 Tauri store |
| `removeService(serviceId)` | disconnectServer → 删除文件 → 从 store 移除 |
| `listServices()` | 返回所有动态服务 |
| `cleanupTempServices()` | 断开并删除所有临时服务（app 退出时调用） |

### createService 核心流程

```
1. 生成 UUID（dyn-{timestamp}-{random}）
2. ensureRuntime() → 确保运行时文件存在
3. invoke('write_file') → 写入 definition.json + handlers.js
4. 构建 MCPServerConfig { transport: stdio, command: 'node', args: [runtimePath, '--dir', serviceDir] }
5. mcpStore.addServer(config) + connectServer(config) — 完全复用现有基础设施
6. 更新 containerStore → dispatch moraya:dynamic-service-created 事件
7. 返回 DynamicService
```

### 持久化

- 已保存服务持久化到 Tauri store `dynamic-mcp-services.json`
- 文件从 `temp/{uuid}/` 复制到 `saved/{name}/`
- 应用启动时从 store 加载 → 逐个 reconnect
- Reconnect 前验证服务文件是否存在，缺失则标记 error 状态

### 文件清单

| 文件 | 类型 | 行数 | 说明 |
|------|------|------|------|
| `src/lib/services/mcp/container-manager.ts` | 新建 | 300 | 生命周期编排核心 |

---

## F4 内部 AI 工具

### 需求描述

在 `internal-tools.ts` 中注册 4 个内部工具，AI 可在对话中自主调用来管理动态服务。

### 工具列表

| 工具名 | 描述 | 必需参数 |
|--------|------|----------|
| `create_mcp_service` | 创建并启动动态 MCP 服务 | name, description, tools[], handlersCode |
| `save_mcp_service` | 保存临时服务为持久化 | serviceId |
| `list_dynamic_services` | 列出所有 AI 创建的服务 | (无) |
| `remove_dynamic_service` | 停止并移除服务 | serviceId |

### create_mcp_service 参数

```typescript
{
  name: string;           // 服务名（字母数字 + 连字符）
  description: string;    // 服务描述
  tools: [{               // 工具定义数组
    name: string;         // 工具名（snake_case）
    description: string;
    inputSchema: object;  // JSON Schema
  }];
  handlersCode: string;   // Node.js JS 代码
  env?: object;           // 可选环境变量（API 密钥）
}
```

### 安全检查

- `create_mcp_service` 执行前检查 `containerStore.nodeAvailable`，Node.js 不可用时返回友好错误
- 所有 handler 用 try/catch 包裹，异常转为结构化错误返回给 AI

### 文件清单

| 文件 | 类型 | 说明 |
|------|------|------|
| `src/lib/services/ai/internal-tools.ts` | 修改 | +4 工具定义 + 4 handler 函数（+200 行） |

---

## F5 AI 系统提示词增强

### 需求描述

当 Node.js 可用时，在 AI 系统提示词中追加动态服务创建的能力说明和编码规范。

### 追加内容

```
## Dynamic MCP Service Creation

You can create MCP services on-the-fly using create_mcp_service when:
- User needs to call an HTTP API that no existing tool covers
- User asks for data from a web service

Handler code guidelines:
- Use fetch() for HTTP requests (Node.js 18+ built-in)
- Access API keys via process.env.KEY_NAME (pass via env parameter)
- Keep handlers simple and focused
- Export as: module.exports = { tool_name: async (args) => result }
```

### 文件清单

| 文件 | 类型 | 说明 |
|------|------|------|
| `src/lib/services/ai/ai-service.ts` | 修改 | 提取 `buildSystemPrompt()` 函数 + 动态追加（+40 行） |

---

## F6 MCPPanel "AI 服务" Tab

### 需求描述

在 Settings → MCP 面板的现有 4 个 tab 后添加 "AI 服务" tab，展示动态服务列表及管理操作。

### UI 布局

```
┌─────────────────────────────────────────────────────────┐
│  服务器 │ 发布 │ 同步 │ 市场 │ AI 服务 ③             │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ● Node.js v22.0.0                                     │
│                                                         │
│  ┌─────────────────────────────────────────────────────┐│
│  │  weather-api          [临时]                        ││
│  │  查询天气信息的 MCP 服务                              ││
│  │  ● running  2 tools                                 ││
│  │                     [代码] [保存] [删除]              ││
│  └─────────────────────────────────────────────────────┘│
│                                                         │
│  ┌─────────────────────────────────────────────────────┐│
│  │  github-issues        [已保存]                      ││
│  │  管理 GitHub Issues                                 ││
│  │  ● running  3 tools                                 ││
│  │                     [代码]        [删除]              ││
│  └─────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────┘
```

### 交互功能

- **Node.js 状态指示器**: 绿色圆点 + 版本号（可用）/ 红色圆点 + 安装提示（不可用）
- **服务列表**: 名称、描述、生命周期标签（临时/已保存）、状态、工具数
- **代码查看**: 点击展开 `handlers.js` 源码（懒加载 + 缓存）
- **保存操作**: 仅临时服务显示，点击调用 `saveService()`
- **删除操作**: 红色按钮，调用 `removeService()`
- **Tab 徽章**: 有服务时显示数量角标
- **空状态**: "AI 可以在对话中自动创建 MCP 服务，试试让它调用 API！"
- **深色模式**: 生命周期标签适配深色主题

### 文件清单

| 文件 | 类型 | 说明 |
|------|------|------|
| `src/lib/components/ai/MCPPanel.svelte` | 修改 | +248 行（template + script + style） |

---

## F7 Rust `check_command_exists` 命令

### 需求描述

Rust 后端新增 Tauri 命令，检测系统中是否安装了指定命令行工具，返回版本字符串。

### 实现

```rust
#[tauri::command]
pub fn check_command_exists(command: String) -> Result<String, String> {
    let output = Command::new(&command)
        .arg("--version")
        .stdin(Stdio::null())
        .stdout(Stdio::piped())
        .stderr(Stdio::piped())
        .output()
        .map_err(|e| format!("Command '{}' not found: {}", command, e))?;
    let stdout = String::from_utf8_lossy(&output.stdout).trim().to_string();
    Ok(if !stdout.is_empty() {
        stdout
    } else {
        String::from_utf8_lossy(&output.stderr).trim().to_string()
    })
}
```

### 文件清单

| 文件 | 类型 | 说明 |
|------|------|------|
| `src-tauri/src/commands/mcp.rs` | 修改 | +19 行 |
| `src-tauri/src/lib.rs` | 修改 | +1 行（注册命令） |

---

## F8 Toast 通知 + 初始化集成

### 需求描述

在应用主页面集成容器管理器初始化，监听服务创建事件显示 Toast 通知，退出时清理临时服务。

### 集成点

| 位置 | 行为 |
|------|------|
| `onMount` | 调用 `initContainerManager()` |
| `moraya:dynamic-service-created` 事件 | 显示 Toast "AI 创建了服务「{name}」" |
| 组件卸载 | `removeEventListener` + `cleanupTempServices()` |

### 文件清单

| 文件 | 类型 | 说明 |
|------|------|------|
| `src/routes/+page.svelte` | 修改 | +28 行 |

---

## F9 i18n 国际化

### 新增 i18n Key

| Key | English | 中文 |
|-----|---------|------|
| `mcp.tabs.aiServices` | AI Services | AI 服务 |
| `mcp.aiServices.empty` | No AI-created services | 暂无 AI 创建的服务 |
| `mcp.aiServices.hint` | AI can create MCP services during chat... | AI 可以在对话中自动创建 MCP 服务... |
| `mcp.aiServices.nodeRequired` | Node.js 18+ required | 需要 Node.js 18+ |
| `mcp.aiServices.checkingNode` | Checking Node.js... | 正在检测 Node.js... |
| `mcp.aiServices.temp` | Temp | 临时 |
| `mcp.aiServices.saved` | Saved | 已保存 |
| `mcp.aiServices.viewCode` | Code | 代码 |
| `mcp.aiServices.tools` | {count} tools | {count} 个工具 |
| `mcp.aiServices.serviceCreated` | AI created service "{name}"... | AI 创建了服务「{name}」... |
| `mcp.aiServices.serviceSaved` | Service "{name}" saved | 服务「{name}」已保存 |
| `mcp.aiServices.serviceRemoved` | Service "{name}" removed | 服务「{name}」已移除 |

### 文件清单

| 文件 | 类型 | 说明 |
|------|------|------|
| `src/lib/i18n/locales/en.json` | 修改 | +12 key |
| `src/lib/i18n/locales/zh-CN.json` | 修改 | +12 key |

---

## 错误处理

| 场景 | 处理方式 |
|------|----------|
| Node.js 未安装 | `create_mcp_service` 返回错误提示，UI 显示安装引导 |
| Node.js < 18 | 版本检测不通过，同上 |
| Handler 语法错误 | Node.js 启动失败，stderr 返回给 AI |
| 服务运行中崩溃 | `mcp_send_request` 检测 EOF，报错给 AI |
| 已保存服务文件被删 | reconnect 时检测，标记为 error 状态 |
| 临时服务 — 退出 app | `cleanupTempServices()` 自动清理 |

---

## 新增文件总览

| 文件路径 | 行数 | 功能 |
|----------|------|------|
| `src/lib/services/mcp/mcp-runtime.ts` | 140 | MCP Runtime JS 字符串常量 |
| `src/lib/services/mcp/container-store.ts` | 58 | 动态服务状态 Store |
| `src/lib/services/mcp/container-manager.ts` | 300 | 生命周期编排核心 |

**共计 3 个新文件，498 行代码**

## 修改文件总览

| 文件路径 | 修改内容 |
|----------|----------|
| `src-tauri/src/commands/mcp.rs` | +`check_command_exists` 命令（+19 行） |
| `src-tauri/src/lib.rs` | 注册新命令（+1 行） |
| `src/lib/services/ai/internal-tools.ts` | +4 工具定义 + 4 handler 函数（+200 行） |
| `src/lib/services/ai/ai-service.ts` | `buildSystemPrompt()` 重构 + 动态提示词（+40 行） |
| `src/lib/components/ai/MCPPanel.svelte` | AI 服务 Tab（+248 行） |
| `src/lib/i18n/locales/en.json` | +12 i18n key |
| `src/lib/i18n/locales/zh-CN.json` | +12 i18n key |
| `src/routes/+page.svelte` | 初始化 + Toast + 清理（+28 行） |
| `src/lib/services/mcp/index.ts` | 导出新模块（+10 行） |

**共计 9 个修改文件**

---

## 依赖变更

### Rust

无新增依赖。

### 前端

**零新增 npm 依赖**。所有功能基于现有 Tauri 插件 + Node.js 内置能力实现。

### 包体积影响

~22-25 KB 未压缩 / ~8-10 KB gzipped（仅 3 个新 TS 文件）。

---

## 代码统计

| 指标 | 数值 |
|------|------|
| 文件变更总数 | 12 |
| 新增文件 | 3 |
| 修改文件 | 9 |
| 新增代码行 | ~860 |
| 新增 Svelte 组件 Tab | 1 |
| 新增 TypeScript 服务 | 3 |
| 新增 Rust 命令 | 1 |
| 新增内部 AI 工具 | 4 |
| 新增 i18n key | 12 × 2 |

---

## 验证方案

1. `pnpm check` — 零 TypeScript 错误 ✅
2. `cargo check` — Rust 编译通过 ✅
3. 端到端测试：
   - 在 AI 对话中说 "帮我查询北京天气"
   - AI 应自主创建天气 API MCP 服务
   - 验证 Toast 通知出现
   - 验证 MCPPanel "AI 服务" Tab 显示新服务
   - 验证工具调用结果正确返回
4. 保存/删除测试：
   - 保存临时服务 → 生命周期标签变为"已保存"
   - 重启 app → 验证已保存服务自动重连
   - 删除服务 → 验证文件清理
5. 代码查看测试：点击"代码" → 展开 handlers.js 源码
6. 错误场景：
   - Node.js 未安装 → AI 工具返回安装引导
   - Handler 语法错误 → 服务状态标记 error，错误信息显示
7. 退出清理：关闭 app → 临时服务自动清理，已保存服务保留

---

## 与 v0.3.4 的对比

| 维度 | v0.3.4 | v0.4.0 |
|------|--------|--------|
| MCP 服务 | 手动配置已有服务 | + AI 自主创建动态服务 |
| AI 能力 | 调用已有 MCP 工具 | + 自主生成工具代码 |
| AI 工具 | 1 个（add_mcp_server） | 5 个（+ create/save/list/remove） |
| MCP 面板 | 4 Tab | 5 Tab（+ AI 服务） |
| 依赖 | — | 需 Node.js 18+（可选，无则优雅降级） |
