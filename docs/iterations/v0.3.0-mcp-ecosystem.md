# v0.3.0 MCP 生态增强

## 概述

将 Moraya 的 MCP 基础设施从"骨架"升级为完整可用的生态系统。核心改进：让 AI 聊天能调用 MCP 工具，完善 stdio 传输 UI、内置预设服务器、知识库同步、发布扩展。后续增量补充：AI 对话式 MCP 配置、JSON 导入、服务器编辑、编辑器内容同步、对话体验优化、多模型配置管理。

## 功能列表

| ID | 功能 | 优先级 | 状态 |
|----|------|--------|------|
| F1 | AI + MCP 工具集成 | P0 | 已完成 |
| F2 | stdio 传输 UI 支持 | P1 | 已完成 |
| F3 | 内置 MCP Server 预设 | P1 | 已完成 |
| F4 | 知识库同步完善 | P2 | 已完成 |
| F5 | MCP 发布扩展 | P2 | 已完成 |
| F6 | AI 对话式 MCP 配置 | P1 | 已完成 |
| F7 | MCPPanel JSON 导入 | P1 | 已完成 |
| F8 | MCP 服务器配置编辑 | P1 | 已完成 |
| F9 | 编辑器内容同步 | P0 | 已完成 |
| F10 | AI 对话体验优化 | P1 | 已完成 |
| F11 | AI 多模型配置管理 | P1 | 待实施 |

---

## F1: AI + MCP 工具集成

### 需求

AI 聊天中自动注入已连接 MCP Server 的工具列表，LLM 返回 tool_use 时自动调用 MCP 工具并将结果反馈给 LLM，形成完整的工具调用循环。

### 交互设计

1. 用户在 MCP 面板连接一个或多个 MCP Server
2. AI 聊天 Header 显示 badge："N tools"
3. 用户发送消息后，AI 可能请求调用工具
4. 聊天区显示工具调用过程：工具名 + 参数（可折叠）
5. 工具结果以灰色 code block 展示
6. AI 基于工具结果继续回复

### 技术方案

- 扩展 `ChatMessage` 类型支持 `role: 'tool'` 和工具调用字段
- 新建 `tool-bridge.ts` 转换 MCP 工具格式到各 LLM Provider 格式
- 修改各 Provider 函数支持 `tools` 参数和解析 `tool_use` 响应
- `sendChatMessage` 实现工具执行循环（最多 10 轮）
- 工具调用轮次用非流式请求，最终文本用流式

---

## F2: stdio 传输 UI 支持

### 需求

MCPPanel 的添加服务器表单支持 stdio 传输类型，让用户能配置本地进程类型的 MCP Server（如 `npx @modelcontextprotocol/server-filesystem`）。

### 交互设计

1. 传输类型下拉增加 "stdio (Local Process)" 选项
2. 选择 stdio 后显示：command 输入框 + args 输入框
3. 服务器列表显示传输类型标签

---

## F3: 内置 MCP Server 预设

### 需求

提供常用 MCP Server 预设，一键添加：Filesystem、Fetch、Git、Memory。

### 交互设计

1. Servers tab 顶部显示"快速添加"区域
2. 展示未添加的预设卡片
3. 点击即自动添加配置
4. 已添加的预设自动隐藏

---

## F4: 知识库同步完善

### 需求

将 Sync tab 从 stub 升级为可用功能。

### 交互设计

1. "新建同步配置"表单：选择 MCP Server、路径、方向
2. 同步状态指示（上次同步时间、文件数）
3. "立即同步"按钮

---

## F5: MCP 发布扩展

### 需求

通过 MCP Server 发现发布能力，统一发布接口。

### 交互设计

1. 自动从连接的 MCP Server 发现 publish 类工具
2. Publish tab 展示可用发布目标
3. 点击发布，展示结果

---

## F6: AI 对话式 MCP 配置

### 需求

用户在 AI 对话中通过自然语言安装和配置 MCP Server。例如输入"帮我安装 PostgreSQL MCP Server"，AI 自动调用内置工具完成配置和连接。

### 交互设计

1. 用户在 AI 聊天中描述需要的 MCP 服务
2. AI 识别意图，调用内置工具 `add_mcp_server`
3. 聊天区显示工具调用过程
4. 配置完成后，MCP 面板自动出现新服务器并连接
5. AI 回复成功信息，包含发现的工具数量

### 技术方案

- 新建 `src/lib/services/ai/internal-tools.ts`，定义内置工具列表
- `INTERNAL_TOOLS` 包含 `add_mcp_server` 工具，输入参数：`name`、`transport_type`、`command`、`args`、`env`、`url`
- `isInternalTool(name)` 判断是否为内置工具
- `executeInternalTool(tc)` 执行内置工具：构建 `MCPServerConfig` → `mcpStore.addServer()` → `connectServer()`
- `ai-service.ts` 工具列表合并：`[...INTERNAL_TOOLS, ...mcpToolsToToolDefs(mcpTools)]`
- 工具执行循环中按 `isInternalTool()` 分流：内置走本地执行，其余走 MCP `callTool`

---

## F7: MCPPanel JSON 导入

### 需求

在设置面板 MCP 添加表单中支持粘贴 Claude Desktop 格式的 JSON 配置，一键添加 MCP Server。

### 交互设计

1. 添加服务器表单顶部新增模式切换 tab：「表单」/「JSON 导入」
2. JSON 模式显示 textarea，含 placeholder 示例
3. 粘贴 JSON 后点击「添加」，自动解析并添加服务器
4. 解析错误时显示红色错误提示

### 支持的 JSON 格式

1. **Claude Desktop 格式**：`{ "mcpServers": { "name": { "command": "npx", "args": [...] } } }`
2. **单服务器带 name**：`{ "name": "postgres", "command": "npx", "args": [...] }`
3. **单服务器最简**：`{ "command": "npx", "args": ["-y", "@.../server-postgres", ...] }` — 从 args 自动推断名称

### 技术方案

- MCPPanel.svelte 新增状态：`addMode`、`jsonInput`、`jsonError`
- `parseMCPJSON(data)` 解析 3 种格式
- `buildTransport(sc)` 根据 `command`/`url` 构建 transport
- `inferServerName(sc)` 从 `@modelcontextprotocol/server-xxx` 提取名称

---

## F8: MCP 服务器配置编辑

### 需求

已添加的 MCP 服务器支持编辑配置，修改名称、传输类型、命令参数等。典型场景：AI 安装的服务器使用默认连接参数，用户需要修改为实际配置（如数据库连接字符串）。

### 交互设计

1. 服务器列表每项新增「编辑」按钮
2. 点击编辑后，服务器项替换为内联编辑表单（与添加表单相同字段）
3. 编辑表单预填当前配置
4. 保存时自动断开重连（如原本已连接）
5. 可点击「取消」放弃修改

### 技术方案

- 新增编辑状态：`editingServerId`、`editName`、`editTransport`、`editCommand`、`editArgs`、`editUrl`
- `startEdit(server)` 填充当前配置到编辑字段
- `handleSaveEdit()` 构建更新后的 `MCPServerConfig`，调用 `mcpStore.addServer()`（按 id 替换）
- 如原先已连接，先 `disconnectServer()` 再 `connectServer()` 重连

---

## F9: 编辑器内容同步

### 需求

AI 通过 MCP 工具（`write_file`、`edit_file`）写入当前打开的文件后，编辑器自动刷新显示最新内容，而非停留在空白或旧内容。

### 问题根因

`editorStore.setContent()` 只更新 Svelte store，不会反向同步到 Milkdown 编辑器。Milkdown 的 `defaultValue` 仅在初始化时读取一次。

### 技术方案

- `ai-service.ts` 工具执行后检测是否写入了当前文件
- 写入后通过 Tauri IPC 重新读取文件内容
- 派发自定义 DOM 事件 `window.dispatchEvent(new CustomEvent('moraya:file-synced', { detail: { content } }))`
- `+page.svelte` 监听该事件，更新 `content` 状态并调用 `milkdownEditor.action(replaceAll(content))` 刷新编辑器

---

## F10: AI 对话体验优化

### 需求

1. **文字可选择复制**：AI 回复内容支持鼠标选择局部文字进行复制
2. **输入框弹性高度**：输入框随内容自动扩展高度，最高 5 行，发送后恢复 1 行

### 问题根因

1. AI 面板使用 `no-select` 全局禁止选择，`.message-content` 未覆盖
2. textarea 设置 `rows={1}` 和 `resize: none`，无自动扩展逻辑

### 技术方案

1. `.message-content` 和 `.tool-output` 添加 `user-select: text` + `cursor: text`，覆盖面板级 `no-select`
2. textarea 绑定 ref（`inputEl`），`oninput` 触发 `autoResizeInput()`：
   - 重置 `height: auto` 后取 `scrollHeight`，限制不超过 `maxInputHeight`（5 行高度）
   - 超出后 `overflow-y: auto` 显示滚动条
3. `handleSend()` 和 `handleCommand()` 调用 `resetInputHeight()` 恢复默认高度

---

## F11: AI 多模型配置管理

### 需求

当前 AI 对话和 AI 图像生成均为单模型配置，切换模型需要重新填写全套参数（Provider、API Key、Base URL、Model 等），摩擦成本高。改为多模型配置模式：用户可挂载多个模型配置，设置一个默认配置，运行时按默认配置调用，支持随时切换。

### 典型场景

| 场景 | 适合的模型 |
|------|-----------|
| 深度写作 / 复杂推理 | Claude Opus |
| 日常对话 / 快速问答 | DeepSeek / GPT-4o |
| 离线 / 隐私场景 | Ollama 本地模型 |
| 图片理解 | Gemini |
| 低成本批量 | Haiku / GPT-4o-mini |
| AI 图像生成 | DALL-E 3 / Grok |

### 交互设计

#### 设置面板 — AI 对话模型

1. 标题下方显示已配置模型列表，每项显示：`Provider 图标` + `模型名` + `默认` 标签（如适用）
2. 每项右侧操作按钮：「默认」「编辑」「删除」
3. 点击「编辑」展开内联编辑表单（与当前添加表单相同字段：Provider、API Key、Base URL、Model、Max Tokens、Temperature）
4. 列表底部「+ 添加模型」按钮，点击展开空白表单
5. 「测试连接」按钮保留在每个模型配置的编辑表单中
6. 至少保留一个配置，最后一个不可删除

#### 设置面板 — AI 图像生成模型

1. 同样改为模型列表，每项显示：`Provider` + `模型名` + `默认` 标签
2. 每项右侧操作按钮：「默认」「编辑」「删除」
3. 编辑表单字段：Provider、API Key、Base URL、Model、默认比例、默认尺寸档位
4. 列表底部「+ 添加模型」按钮

#### AI 聊天面板 — 模型切换

1. 聊天 Header 区域（现有 badge 旁）增加模型切换下拉
2. 下拉显示所有已配置模型，当前激活项高亮
3. 切换后立即生效，后续对话使用新模型
4. 下拉项格式：`Provider / Model`（如 `Claude / claude-opus-4-6`）

### 数据模型变更

#### AI 对话配置

```typescript
// 新增 id 字段
interface AIProviderConfig {
  id: string;                // crypto.randomUUID()
  provider: AIProvider;
  apiKey: string;
  baseUrl?: string;
  model: string;
  maxTokens?: number;
  temperature?: number;
}

// AIState 变更
interface AIState {
  // ... 现有字段保留 ...
  providerConfig: AIProviderConfig | null;    // 删除，改为下面两个
  providerConfigs: AIProviderConfig[];        // 所有已配置模型
  activeConfigId: string | null;              // 当前激活配置的 id
}
```

#### AI 图像生成配置

```typescript
// 新增 id 字段
interface ImageProviderConfig {
  id: string;                // crypto.randomUUID()
  provider: ImageProvider;
  baseURL: string;
  apiKey: string;
  model: string;
  defaultRatio: ImageAspectRatio;
  defaultSizeLevel: ImageSizeLevel;
}

// Settings 变更
interface Settings {
  // ... 现有字段保留 ...
  imageProviderConfig: ImageProviderConfig;           // 删除，改为下面两个
  imageProviderConfigs: ImageProviderConfig[];         // 所有已配置模型
  activeImageConfigId: string | null;                  // 当前激活配置的 id
}
```

### 存储迁移

应用启动时自动检测旧格式并迁移：

```typescript
// ai-config.json 迁移
const saved = await store.get<any>('providerConfig');
if (saved && !saved.id) {
  // 旧格式：单对象，无 id → 迁移为数组
  saved.id = crypto.randomUUID();
  await store.set('providerConfigs', [saved]);
  await store.set('activeConfigId', saved.id);
  await store.delete('providerConfig');
  await store.save();
}

// settings.json 迁移
if (settings.imageProviderConfig && !settings.imageProviderConfigs) {
  const old = settings.imageProviderConfig;
  old.id = crypto.randomUUID();
  settings.imageProviderConfigs = [old];
  settings.activeImageConfigId = old.id;
  delete settings.imageProviderConfig;
}
```

### 技术方案

#### Store 层改造

**`ai-service.ts`**：
- `AIState` 新增 `providerConfigs: AIProviderConfig[]` 和 `activeConfigId: string | null`
- 移除 `providerConfig`，改为 `getActiveConfig()` 计算属性
- 新增方法：
  - `addProviderConfig(config)` — 添加配置到数组
  - `updateProviderConfig(config)` — 按 id 更新配置
  - `removeProviderConfig(id)` — 移除配置（如为激活项则自动切换到第一个）
  - `setActiveConfig(id)` — 设置激活配置
  - `getActiveConfig(): AIProviderConfig | null` — 从数组中查找激活配置
- `persistAIConfig()` 改为持久化 `providerConfigs` + `activeConfigId`
- `initAIStore()` 加入迁移逻辑
- `sendChatMessage()` 和 `executeAICommand()` 使用 `getActiveConfig()` 获取当前配置

**`settings-store.ts`**：
- `Settings` 新增 `imageProviderConfigs` 和 `activeImageConfigId`
- 移除 `imageProviderConfig`
- `initSettingsStore()` 加入迁移逻辑

#### UI 层改造

**`AISettings.svelte`**：
- AI 对话区域：从单表单改为模型列表 + 内联编辑/添加
- AI 图像区域：同样改为模型列表 + 内联编辑/添加
- 每个配置项：显示卡片 → 点击编辑展开表单 → 保存/取消
- 「设为默认」按钮调用 `aiStore.setActiveConfig(id)` / `settingsStore.update({ activeImageConfigId: id })`

**`AIChatPanel.svelte`**：
- Header 区域增加模型切换下拉
- 下拉数据源：`aiStore` 的 `providerConfigs`
- 切换调用 `aiStore.setActiveConfig(id)`

#### 兼容性

- `sendAIRequest(config, request)` 和 `streamAIRequest(config, request)` 的 `providers.ts` 不需要改动，它们已经接收 `AIProviderConfig` 参数
- `tool-bridge.ts`、`internal-tools.ts` 不需要改动
- `image-service.ts` 调用方需要从 `settingsStore` 取 active 配置传入

### 验证方案

1. **AI 对话多模型**：设置中添加 2+ 个不同 Provider 的模型 → 聊天面板下拉切换 → 对话正常 → 切换后新消息使用新模型
2. **AI 图像多模型**：设置中添加 2+ 个图像模型 → 默认切换 → 生成图片使用对应模型
3. **存储迁移**：旧版单配置用户升级后 → 自动出现在列表中且为默认 → 无感迁移
4. **边界**：删除最后一个配置时提示不可删除 → 新增配置后可正常使用
5. **构建验证**：`pnpm check` 0 errors

---

## 实施顺序

F2 → F1 → F3 → F4 → F5 → F6 → F7 → F8 → F9 → F10 → F11

## 涉及文件

| 文件 | 改动类型 | 关联功能 |
|------|----------|----------|
| 文件 | 改动类型 | 关联功能 |
|------|----------|----------|
| `src/lib/services/ai/types.ts` | 扩展类型（AIProviderConfig 加 id、ImageProviderConfig 加 id） | F1, F11 |
| `src/lib/services/ai/tool-bridge.ts` | **新建** | F1 |
| `src/lib/services/ai/providers.ts` | 添加工具支持 | F1 |
| `src/lib/services/ai/ai-service.ts` | 工具执行循环 + 内置工具 + 文件同步 + 多配置管理 | F1, F6, F9, F11 |
| `src/lib/services/ai/internal-tools.ts` | **新建** | F6 |
| `src/lib/services/ai/index.ts` | 更新导出 | F1, F6, F11 |
| `src/lib/components/ai/AIChatPanel.svelte` | 工具调用 UI + 文字选择 + 输入框弹性 + 模型切换下拉 | F1, F10, F11 |
| `src/lib/components/ai/AISettings.svelte` | 多模型列表 + 内联编辑 + 设为默认 | F11 |
| `src/lib/components/ai/MCPPanel.svelte` | stdio UI + 预设 + 同步 + 发布 + JSON 导入 + 编辑 | F2-F5, F7, F8 |
| `src/lib/stores/settings-store.ts` | 多图像模型配置 + 迁移逻辑 | F11 |
| `src/lib/services/mcp/presets.ts` | **新建** | F3 |
| `src/lib/services/mcp/types.ts` | 扩展 SyncConfig | F4 |
| `src/lib/services/mcp/mcp-manager.ts` | 同步逻辑 + 发布发现 | F4, F5 |
| `src/lib/services/mcp/index.ts` | 更新导出 | F3-F5 |
| `src/routes/+page.svelte` | 编辑器内容同步事件监听 | F9 |
| `src/lib/i18n/locales/en.json` | i18n 键 | F2-F8, F11 |
| `src/lib/i18n/locales/zh-CN.json` | i18n 键 | F2-F8, F11 |

**新建文件**：3 个（`tool-bridge.ts`、`internal-tools.ts`、`presets.ts`）
**修改文件**：14 个
