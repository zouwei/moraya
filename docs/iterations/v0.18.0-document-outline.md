# v0.18.0 — 文档大纲（Document Outline）

## 背景

当前 Sidebar 承载了本地知识库（文件树）功能，无法同时展示文档大纲。用户在长文档编辑时需要快速定位到指定章节，缺乏目录导航能力。

本迭代在**编辑器内容区域左侧**添加文档大纲面板，与内容区域视觉融合（透明无边框），保持现有 Sidebar 知识库功能不变。

## 功能需求

### F1：大纲面板

- **位置**：编辑器内容区域左侧，与 `.editor-root` 并列
- **样式**：背景透明、无边框，完全融入编辑器内容区域
- **内容**：提取文档中的 H1–H6 标题，按层级缩进展示
- **交互**：
  - 点击大纲项 → 平滑滚动到对应标题位置
  - 当前可见标题在大纲中高亮
  - 标题文本过长时截断（单行省略）

### F2：显隐控制

- **快捷键**：`Cmd+Shift+O`（macOS）/ `Ctrl+Shift+O`（Windows/Linux）
- **菜单项**：View 菜单 → "Toggle Outline"（`CheckMenuItem`，与 Toggle Sidebar / Toggle AI Panel 同组）
- **模式限制**：
  - ✅ Visual 模式 — 可见
  - ✅ Source 模式 — 可见
  - ❌ Split 模式 — 强制隐藏（split 模式下空间已被两栏占满）
- **持久化**：`showOutline` 存入 settings-store，切换模式/重启后保留用户偏好

### F3：自适应布局

大纲面板嵌入 `.editor-wrapper` 内部，与 `.editor-root` 组成 flex 布局：

```
.editor-wrapper (overflow-y: auto)
  └── .outline-content-row (display: flex, max-width, margin: 0 auto)
        ├── .outline-panel (width: 150px, flex-shrink: 0, position: sticky)
        └── .editor-root (flex: 1, max-width: editorLineWidth)
```

**宽度自适应规则**（假设 editorLineWidth=800px, outlineWidth=150px）：

| 可用宽度 | 大纲 | 内容区 | 效果 |
|---------|------|--------|------|
| ≥ 950px | 150px | 800px | 两者满宽，整体居中 |
| < 950px | 150px | 自适应压缩 | 大纲固定，内容区弹性缩小 |
| < 500px | 自动隐藏 | 100% | 极窄屏幕保障内容可读 |

**CSS 实现要点**：
- 外层容器 `max-width: min(editorLineWidth + 150px, 100%); margin: 0 auto`
- 大纲 `flex-shrink: 0; width: 150px`
- 内容区 `flex: 1; min-width: 0; max-width: editorLineWidth`
- 大纲未显示时，布局退回原有单列居中（无多余空间占用）

### F4：标题数据提取

**可视化模式**：遍历 ProseMirror document tree，提取 `heading` 节点的 `level` 属性和文本内容。通过 Milkdown `editorViewCtx` 获取 `view.state.doc`。

**源码模式**：正则匹配 markdown 内容中的 `^#{1,6} (.+)$` 行。

**更新策略**：
- 使用防抖（300ms）在内容变化时更新大纲
- 可视化模式下可监听 ProseMirror transaction（`docChanged`）
- 源码模式下监听 textarea `input` 事件

### F5：滚动联动

**点击大纲 → 滚动编辑器**：
- 可视化模式：通过 ProseMirror `view.coordsAtPos()` 获取标题位置，滚动 `.editor-wrapper`
- 源码模式：计算标题所在行号，滚动 textarea 到对应行

**滚动编辑器 → 高亮大纲**：
- 监听 `.editor-wrapper` 的 scroll 事件（RAF 节流）
- 找到当前视口顶部最近的标题，在大纲中标记为 active

## UI 设计

### 大纲面板视觉

```
┌─ .outline-panel ──────────┐
│  Introduction              │  ← H1, 无缩进
│    Background              │  ← H2, 缩进 1 级
│    Goals                   │  ← H2
│      Sub-goal A            │  ← H3, 缩进 2 级
│  Implementation            │  ← H1
│    Phase 1              ← │  ← 当前可见标题，高亮
│    Phase 2                 │
└────────────────────────────┘
```

- 字体：`var(--font-size-xs)`（12px）
- 文字颜色：`var(--text-secondary)`，active 项用 `var(--text-primary)`
- active 项左侧 2px 竖线指示器，颜色 `var(--accent-color)`
- 层级缩进：每级 `12px` padding-left
- 行高紧凑：`1.6`
- hover 效果：文字颜色变为 `var(--text-primary)`
- 无背景色、无边框、无阴影

### 大纲面板宽度

- 固定 150px，不可拖拽调整
- 内部文本超长时 `text-overflow: ellipsis` 截断

## 文件修改清单

| 文件 | 修改点 |
|------|--------|
| `src/lib/components/OutlinePanel.svelte` | **新建** — 大纲组件 |
| `src/lib/editor/Editor.svelte` | 嵌入 OutlinePanel，调整 flex 布局 |
| `src/lib/editor/SourceEditor.svelte` | 嵌入 OutlinePanel，调整 flex 布局 |
| `src/routes/+page.svelte` | 添加大纲显隐状态、快捷键 `Cmd+Shift+O`、split 模式隐藏逻辑 |
| `src/lib/stores/settings-store.ts` | 新增 `showOutline: boolean` 字段 |
| `src-tauri/src/menu.rs` | View 菜单新增 "Toggle Outline" CheckMenuItem |
| `src-tauri/src/lib.rs` | 处理 `view_outline` 菜单事件 |
| `src/lib/i18n/locales/en.json` | 新增大纲相关翻译 key |
| `src/lib/i18n/locales/zh-CN.json` | 对应中文翻译 |

## 实施顺序

1. **settings-store** — 新增 `showOutline` 字段（默认 `false`）
2. **OutlinePanel.svelte** — 实现大纲组件（标题提取、层级展示、点击滚动、active 高亮）
3. **Editor.svelte** — 嵌入大纲，调整内部 flex 布局
4. **SourceEditor.svelte** — 同上
5. **+page.svelte** — 快捷键绑定、split 模式隐藏、状态联动
6. **menu.rs + lib.rs** — 原生菜单项
7. **i18n** — 翻译 key

## 验证方案

1. `pnpm check` — 0 TS 错误
2. Visual 模式下打开大纲，验证标题层级正确展示
3. Source 模式下打开大纲，验证标题提取正确
4. 点击大纲项，编辑器滚动到对应标题
5. 滚动编辑器，大纲当前项高亮跟随
6. 切换到 Split 模式，大纲自动隐藏
7. 切回 Visual/Source 模式，大纲恢复之前状态
8. `Cmd+Shift+O` 切换大纲显隐
9. View 菜单 "Toggle Outline" 勾选状态同步
10. 窄屏（< 500px 内容区宽度）大纲自动隐藏
11. 编辑标题后大纲 300ms 内更新
12. 重启应用后大纲显隐状态保持
