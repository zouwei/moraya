# 009 — RSS 订阅源自动更新 (v0.5.0)

> 迭代版本: v0.5.0
> 上一版本: v0.4.0
> 创建日期: 2026-02-10
> 状态: 已完成

---

## 版本概要

v0.5.0 为发布工作流增加 **RSS 订阅源自动更新**能力。用户在发布文章到 GitHub 仓库时，系统自动拉取目标仓库的 `feed.xml`，追加/更新当前文章条目，推送回仓库。**零新增 npm 依赖**，RSS 2.0 XML 通过纯 TypeScript 字符串模板生成与正则解析。

### 关键设计决策

| 决策项 | 选择 | 备选方案 |
|--------|------|----------|
| RSS 配置粒度 | 每个 PublishTarget 独立配置 | 全局统一配置 |
| XML 处理 | 纯字符串模板 + 正则（零依赖） | xml2js / fast-xml-parser |
| 更新策略 | 增量更新（按 guid 去重） | 全量重建 |
| 失败处理 | 非阻塞（toast 提示，不影响文章发布） | 阻塞式错误 |

---

## 功能清单

| ID | 功能 | 类型 | 优先级 | 状态 |
|----|------|------|--------|------|
| F1 | RSS Feed 核心模块（XML 生成/解析/合并） | 服务层 | P0 | ✅ |
| F2 | GitHub RSS 发布编排 | 服务层 | P0 | ✅ |
| F3 | Custom API RSS 推送 | 服务层 | P1 | ✅ |
| F4 | 类型定义扩展（RSSConfig） | 基础 | P0 | ✅ |
| F5 | 发布目标设置 RSS 配置 UI | 界面 | P0 | ✅ |
| F6 | 发布流程集成 | 集成 | P0 | ✅ |
| F7 | i18n 国际化 | 基础 | P1 | ✅ |
| F8 | GitHub API 工具函数导出 | 基础 | P0 | ✅ |

---

## 架构总览

```
用户点击发布 → 文章发布到 GitHub 仓库（已有流程）
  ↓ 发布成功后
检查 target.rss.enabled
  ↓ 已启用
GET feed.xml（GitHub Contents API）→ 解析已有条目
  ↓
构建新 RSSItem（title, link, excerpt, pubDate, content:encoded）
  ↓
upsertRSSItem → 按 guid 去重、排序、截断到 maxItems
  ↓
buildRSSFeed → 生成 RSS 2.0 XML
  ↓
PUT feed.xml（GitHub Contents API）→ 推送回仓库
```

---

## F1 RSS Feed 核心模块

### 需求描述

纯 TypeScript 实现的 RSS 2.0 生成器与解析器，零外部依赖。

### 技术实现

| 函数 | 作用 |
|------|------|
| `buildRSSFeed(config, items)` | 生成完整 RSS 2.0 XML 字符串 |
| `parseRSSItems(xml)` | 从已有 feed.xml 解析 `<item>` 条目 |
| `upsertRSSItem(existingItems, newItem, maxItems)` | 按 guid 去重、按 pubDate 排序、截断 |
| `toRFC2822Date(date)` | 生成 RSS 标准日期格式 |
| `escapeXml(str)` | XML 特殊字符转义 |

### RSSItem 数据结构

```typescript
interface RSSItem {
  title: string;
  link: string;           // 文章 URL（siteUrl + slug）
  description: string;    // 摘要
  pubDate: string;        // RFC 2822 日期
  guid: string;           // 唯一标识（同 link）
  contentEncoded?: string; // 完整 HTML 内容
  author?: string;
}
```

### XML 输出格式

```xml
<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"
  xmlns:content="http://purl.org/rss/1.0/modules/content/"
  xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>My Blog</title>
    <link>https://myblog.com</link>
    <description>Articles about tech</description>
    <language>zh-CN</language>
    <lastBuildDate>Mon, 10 Feb 2026 12:00:00 +0000</lastBuildDate>
    <atom:link href="https://myblog.com/feed.xml" rel="self" type="application/rss+xml"/>
    <generator>Moraya</generator>
    <item>
      <title>文章标题</title>
      <link>https://myblog.com/my-article</link>
      <description>文章摘要...</description>
      <pubDate>Mon, 10 Feb 2026 12:00:00 +0000</pubDate>
      <guid isPermaLink="true">https://myblog.com/my-article</guid>
      <author>作者名</author>
      <content:encoded><![CDATA[<p>完整 HTML 内容...</p>]]></content:encoded>
    </item>
  </channel>
</rss>
```

### 文件清单

| 文件 | 类型 | 行数 | 说明 |
|------|------|------|------|
| `src/lib/services/publish/rss-feed.ts` | 新建 | 148 | RSS 核心（生成/解析/合并） |

---

## F2 GitHub RSS 发布编排

### 需求描述

在文章成功发布到 GitHub 仓库后，自动更新该仓库的 `feed.xml`。

### 核心流程

1. 检查 `target.rss?.enabled` 和 `target.rss.siteUrl`
2. 通过 `getFileContent()` 读取现有 feed.xml（不存在则空列表）
3. `parseRSSItems()` 解析已有条目
4. 构建新 RSSItem：
   - `title` = SEO 标题 / 首标题 / 文件名
   - `link` = `${siteUrl}/${slug}`
   - `description` = 摘要 / meta description
   - `contentEncoded` = `markdownToHtmlBody(markdown)`（复用 export-service）
5. `upsertRSSItem()` 合并（按 guid 去重）
6. `buildRSSFeed()` 生成 XML
7. `putFile()` 推送到 `rss.feedPath`（默认 `feed.xml`）

### 文件清单

| 文件 | 类型 | 行数 | 说明 |
|------|------|------|------|
| `src/lib/services/publish/rss-publisher.ts` | 新建 | 91 | RSS 发布编排 |

---

## F3 Custom API RSS 推送

### 需求描述

对于 Custom API 发布目标，若配置了 RSS Feed 端点，发布时 POST 文章数据到该端点，由服务端处理 RSS 生成。

### 请求格式

```json
POST /rss-endpoint
Content-Type: application/json

{
  "title": "文章标题",
  "slug": "article-slug",
  "description": "meta description",
  "excerpt": "摘要",
  "tags": "tag1, tag2",
  "content": "Markdown 原文",
  "date": "2026-02-10"
}
```

---

## F4 类型定义扩展

### 新增类型

```typescript
/** GitHub 发布目标的 RSS 配置 */
interface RSSConfig {
  enabled: boolean;
  feedPath: string;           // 默认 "feed.xml"
  siteUrl: string;            // "https://myblog.com"
  feedTitle: string;
  feedDescription: string;
  language: string;           // "en" | "zh-CN"
  authorName: string;
  maxItems: number;           // 默认 20
  includeFullContent: boolean; // 默认 true
}

/** Custom API 发布目标的 RSS 配置（简化版） */
interface CustomAPIRSSConfig {
  enabled: boolean;
  feedEndpoint: string;
}
```

### 修改的类型

- `GitHubTarget` 新增 `rss?: RSSConfig`
- `CustomAPITarget` 新增 `rss?: CustomAPIRSSConfig`

### 文件清单

| 文件 | 类型 | 说明 |
|------|------|------|
| `src/lib/services/publish/types.ts` | 修改 | +RSSConfig, +CustomAPIRSSConfig, 扩展 Target 接口 |

---

## F5 发布目标设置 RSS 配置 UI

### 需求描述

在 Settings → 发布目标编辑表单中，文件命名规则之后添加 RSS 配置区域。

### GitHub 目标 UI

```
─── RSS FEED ───────────────────────────
[x] 生成 RSS 订阅源
    发布时自动更新 feed.xml

站点 URL:     [https://myblog.com          ]
Feed 标题:    [我的博客                     ]
Feed 描述:    [关于...                      ]
作者:         [张三                         ]
语言:         [zh-CN                        ]
Feed 文件路径: [feed.xml                     ]
最大条目数:    [====o=========] 20
[x] 在 Feed 中包含完整文章内容
```

### Custom API 目标 UI

```
─── RSS FEED ───────────────────────────
[x] 生成 RSS 订阅源
RSS Feed 接口: [https://api.example.com/rss  ]
```

### 向后兼容

编辑已有目标时，若 `rss` 字段不存在，自动初始化为默认值（`enabled: false`）。

### 文件清单

| 文件 | 类型 | 说明 |
|------|------|------|
| `src/lib/components/PublishSettings.svelte` | 修改 | +RSS 配置表单 + CSS |

---

## F6 发布流程集成

### 需求描述

在 `handlePublishConfirm` 中，文章发布成功后自动调用 RSS 更新。

### 集成方式

```typescript
// 发布成功后
if (result.success && target.type === 'github' && target.rss?.enabled) {
  try {
    const { updateGitHubRSSFeed } = await import('$lib/services/publish/rss-publisher');
    await updateGitHubRSSFeed(target, variables, content);
  } catch (rssErr) {
    showToast(`RSS 更新失败: ${rssErr.message}`, 'error');
  }
}
```

- **懒加载**：RSS 模块仅在需要时 import
- **非阻塞**：RSS 更新失败只 toast 提示，不影响文章发布成功状态

### 文件清单

| 文件 | 类型 | 说明 |
|------|------|------|
| `src/routes/+page.svelte` | 修改 | handlePublishConfirm +RSS 更新 |

---

## F7 i18n 国际化

### 新增 i18n Key

| Key | English | 中文 |
|-----|---------|------|
| `publish.rssSection` | RSS Feed | RSS 订阅 |
| `publish.rssEnable` | Generate RSS Feed | 生成 RSS 订阅源 |
| `publish.rssEnableHint` | Automatically update feed.xml when publishing | 发布时自动更新 feed.xml |
| `publish.rssFeedPath` | Feed File Path | Feed 文件路径 |
| `publish.rssSiteUrl` | Site URL | 站点 URL |
| `publish.rssFeedTitle` | Feed Title | Feed 标题 |
| `publish.rssFeedDescription` | Feed Description | Feed 描述 |
| `publish.rssLanguage` | Language | 语言 |
| `publish.rssAuthorName` | Author | 作者 |
| `publish.rssMaxItems` | Max Items in Feed | Feed 最大条目数 |
| `publish.rssIncludeFullContent` | Include full article content in feed | 在 Feed 中包含完整文章内容 |
| `publish.rssFeedEndpoint` | RSS Feed Endpoint | RSS Feed 接口 |
| `publish.rssUpdateFailed` | RSS feed update failed | RSS 订阅源更新失败 |

### 文件清单

| 文件 | 类型 | 说明 |
|------|------|------|
| `src/lib/i18n/locales/en.json` | 修改 | +18 key |
| `src/lib/i18n/locales/zh-CN.json` | 修改 | +18 key |

---

## F8 GitHub API 工具函数导出

### 需求描述

将 `github-publisher.ts` 中原本 module-private 的工具函数导出，供 RSS 发布模块复用。

### 导出的函数

| 函数 | 作用 |
|------|------|
| `parseGitHubUrl(repoUrl)` | 从 GitHub URL 解析 owner/repo |
| `getFileSha(owner, repo, path, branch, token)` | 获取文件 SHA（更新时需要） |
| `putFile(owner, repo, path, content, message, branch, token)` | 创建/更新文件 |
| `getFileContent(owner, repo, path, branch, token)` | **新增** — 获取并 base64 解码文件内容 |

### 文件清单

| 文件 | 类型 | 说明 |
|------|------|------|
| `src/lib/services/publish/github-publisher.ts` | 修改 | 导出 3 函数 + 新增 getFileContent |
| `src/lib/services/publish/index.ts` | 修改 | 增加 RSS 相关导出 |

---

## 错误处理

| 场景 | 处理方式 |
|------|----------|
| RSS 未启用 | 静默跳过，不执行任何操作 |
| siteUrl 未填写 | 静默跳过（enabled 但 siteUrl 为空） |
| feed.xml 不存在 | 创建新 feed（空条目列表） |
| feed.xml 读取失败 | 抛出异常，toast 提示 |
| feed.xml 推送 409 冲突 | 抛出异常，toast 提示 |
| Custom API 端点返回错误 | 抛出异常，toast 提示 |
| 所有 RSS 错误 | **非阻塞** — 不影响文章发布成功状态 |

---

## 新增文件总览

| 文件路径 | 行数 | 功能 |
|----------|------|------|
| `src/lib/services/publish/rss-feed.ts` | 148 | RSS 2.0 生成/解析/合并 |
| `src/lib/services/publish/rss-publisher.ts` | 91 | RSS 发布编排 |

**共计 2 个新文件，239 行代码**

## 修改文件总览

| 文件路径 | 修改内容 |
|----------|----------|
| `src/lib/services/publish/types.ts` | +RSSConfig, +CustomAPIRSSConfig, 扩展 Target 接口 |
| `src/lib/services/publish/github-publisher.ts` | 导出 3 函数 + 新增 getFileContent |
| `src/lib/services/publish/index.ts` | 增加 RSS 相关导出 |
| `src/lib/components/PublishSettings.svelte` | +RSS 配置表单 + CSS |
| `src/routes/+page.svelte` | handlePublishConfirm +RSS 更新调用 |
| `src/lib/i18n/locales/en.json` | +18 i18n key |
| `src/lib/i18n/locales/zh-CN.json` | +18 i18n key |

**共计 7 个修改文件**

---

## 依赖变更

### 前端

**零新增 npm 依赖**。RSS 2.0 XML 通过纯 TypeScript 字符串模板生成，解析通过正则实现。

### 包体积影响

~2-3 KB minified（2 个新 TS 文件，纯字符串操作）。

---

## 代码统计

| 指标 | 数值 |
|------|------|
| 文件变更总数 | 9 |
| 新增文件 | 2 |
| 修改文件 | 7 |
| 新增代码行 | ~239 |
| 新增 i18n key | 18 × 2 |

---

## 验证方案

1. `pnpm check` — 零新增 TypeScript 错误 ✅
2. 端到端测试：
   - 配置一个 GitHub target，启用 RSS，填写站点信息
   - 发布一篇文章 → 检查仓库中是否生成了 `feed.xml`
   - 再发布另一篇 → 检查 `feed.xml` 是否包含两个 `<item>`
   - 重新发布同一篇文章（相同 slug）→ 检查是否更新而非重复
3. RSS 格式验证：将 feed.xml URL 粘贴到 RSS 阅读器（Feedly / Inoreader）验证解析正确
4. 向后兼容：已有 PublishTarget 无 `rss` 字段 → 编辑时自动初始化默认值
5. 非阻塞验证：RSS 更新失败时 → toast 错误提示，文章发布仍显示成功

---

## 与 v0.4.0 的对比

| 维度 | v0.4.0 | v0.5.0 |
|------|--------|--------|
| 发布工作流 | 文章发布到 GitHub / Custom API | + 自动更新 RSS 订阅源 |
| GitHub Publisher | 创建/更新文章文件 | + 读取/更新 feed.xml |
| 发布目标设置 | 仓库 + Front Matter + 文件命名 | + RSS 配置区域 |
| 依赖 | — | 零新增 |
