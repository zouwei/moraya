# Moraya 核心平台 (v0.1.0)

> 迭代版本: v0.1.0
> 上一版本: —（初始版本）
> 创建日期: 2026-01
> 状态: ✅ 已完成

---

## 版本概要

v0.1.0 是 Moraya 的基础平台版本，从零搭建了一个完整的 AI Markdown 编辑器。涵盖 4 个阶段（Phase 1–4），建立了**核心编辑器引擎**、**多供应商 AI 集成**、**MCP 协议生态**和**编辑器增强**四大支柱，奠定了所有后续迭代的技术基础。

### 技术栈

| 层 | 技术 | 版本 |
|------|---------|---------|
| 运行时 | Tauri v2 | >=2.9,<2.10 |
| 后端 | Rust | 2021 edition |
| 前端 | Svelte 5 + SvelteKit (SPA) | ^5.0.0 / ^2.9.0 |
| 编辑器 | Milkdown v7 (ProseMirror) | ^7.18.0 |
| 数学渲染 | KaTeX | ^0.16.28 |
| 构建工具 | Vite | ^6.0.3 |
| 包管理 | pnpm | 10.x |
| 语言 | TypeScript (strict) | ~5.6.2 |

### 安装包大小

| 平台 | 格式 | 大小 |
|------|------|------|
| macOS | DMG | ~2.8 MB |
| macOS | App Bundle | ~4.7 MB |

---

## Phase 1 — 核心编辑器

### 功能清单

| 编号 | 功能 | 类型 | 状态 |
|------|------|------|------|
| P1.1 | WYSIWYG Markdown 编辑 | 编辑器核心 | ✅ |
| P1.2 | 数学公式渲染 (LaTeX/KaTeX) | 编辑器核心 | ✅ |
| P1.3 | 文件操作 (新建/打开/保存/另存) | 文件系统 | ✅ |
| P1.4 | 文件浏览器侧边栏 | UI | ✅ |
| P1.5 | 设置面板 (通用/编辑器/外观) | UI | ✅ |
| P1.6 | 导出 (HTML/LaTeX) | 导出 | ✅ |
| P1.7 | 主题系统 (亮色/暗色/跟随系统) | 外观 | ✅ |
| P1.8 | 无边框窗口 + macOS 红绿灯 | 平台 | ✅ |

### 技术要点

- **编辑器引擎**: Milkdown v7 — 基于 ProseMirror 的 Markdown-native WYSIWYG，输入 `# ` 即渲染为标题
- **Commonmark + GFM**: 支持标准 Markdown、表格、任务列表、删除线
- **KaTeX 公式**: 行内 `$...$` 和块级 `$$...$$` 数学公式实时渲染
- **SPA 架构**: SvelteKit + adapter-static，无 SSR（Tauri 无 Node.js 服务端）
- **Tauri IPC**: 文件 I/O 通过 Rust commands，前端 invoke 调用
- **CSS 变量主题**: `data-theme` 属性 + `prefers-color-scheme` 媒体查询

---

## Phase 2 — AI 集成

### 功能清单

| 编号 | 功能 | 类型 | 状态 |
|------|------|------|------|
| P2.1 | 多供应商 LLM API 适配器 | AI 后端 | ✅ |
| P2.2 | SSE/ReadableStream 流式响应 | AI 后端 | ✅ |
| P2.3 | AI 聊天面板 (340px 右侧边栏) | AI UI | ✅ |
| P2.4 | AI 快捷命令 (/write, /summarize 等) | AI 交互 | ✅ |
| P2.5 | 插入/替换/复制操作按钮 | AI 交互 | ✅ |
| P2.6 | AI 供应商设置 (Settings → AI tab) | 设置 | ✅ |
| P2.7 | 连通性测试 (Test Connection) | 设置 | ✅ |

### 支持的 AI 供应商

| 供应商 | 协议 | 认证方式 |
|--------|------|---------|
| Anthropic Claude | Messages API, SSE | `x-api-key` header |
| OpenAI | Chat Completions, SSE | `Authorization: Bearer` |
| Google Gemini | generateContent API | `?key=` query param |
| DeepSeek | OpenAI-compatible | `Authorization: Bearer` |
| Ollama | 本地 localhost:11434, NDJSON | 无需 Key |
| Custom API | OpenAI-compatible | 可选 `Authorization: Bearer` |

### 技术要点

- **统一 Provider 接口**: 所有供应商共享 `sendChatStream()` 抽象，内部按协议分发
- **流式输出**: SSE (`EventSource`) 和 `ReadableStream` 两种方式，逐 chunk 推送到聊天面板
- **10 个快捷命令**: `/write`, `/continue`, `/outline`, `/summarize`, `/translate`, `/improve`, `/fix-grammar`, `/simplify`, `/expand`, `/explain`
- **上下文感知**: 选中文本自动作为 AI 命令上下文

---

## Phase 3 — MCP 生态

### 功能清单

| 编号 | 功能 | 类型 | 状态 |
|------|------|------|------|
| P3.1 | MCP 客户端 — stdio 传输 | MCP 核心 | ✅ |
| P3.2 | MCP 客户端 — SSE 传输 | MCP 核心 | ✅ |
| P3.3 | MCP 客户端 — HTTP 传输 | MCP 核心 | ✅ |
| P3.4 | MCP Server 管理面板 | MCP UI | ✅ |
| P3.5 | 连接/断开/状态监控 | MCP 管理 | ✅ |
| P3.6 | Tools/Resources 列表展示 | MCP 管理 | ✅ |

### 三种传输方式

| 传输 | 机制 | 适用场景 |
|------|------|---------|
| stdio | Rust 后端 `MCPProcessManager` 管理子进程 | 本地 CLI 工具 (npx, uvx) |
| SSE | EventSource 接收 + POST 发送 | 远程 HTTP MCP server |
| HTTP | 无状态 JSON-RPC POST | 简单 API 服务 |

### 技术要点

- **Rust MCPProcessManager**: stdio 子进程生命周期管理，stdin/stdout JSON-RPC 通信
- **JSON-RPC 2.0**: 标准协议，`method`, `params`, `id` 三字段
- **Settings → MCP tab**: 可视化管理 MCP server 配置
- **自动重连**: SSE 传输断线自动重连

---

## Phase 4 — 编辑器增强

### 功能清单

| 编号 | 功能 | 类型 | 状态 |
|------|------|------|------|
| P4.1 | 源码模式 (Source Mode) | 编辑模式 | ✅ |
| P4.2 | 对比模式 (Split Mode) | 编辑模式 | ✅ |
| P4.3 | 三模式切换 (Cmd+/ / Cmd+Shift+/) | 编辑模式 | ✅ |
| P4.4 | 表格浮动工具栏 | 编辑器增强 | ✅ |
| P4.5 | 原生菜单系统 (File/Edit/Paragraph/Format/View/Help) | 平台集成 | ✅ |
| P4.6 | 国际化 (English / 简体中文) | i18n | ✅ |
| P4.7 | Split 模式滚动同步 | 编辑模式 | ✅ |
| P4.8 | CheckMenuItem 模式指示 | 平台集成 | ✅ |

### 三种编辑模式

| 模式 | 快捷键 | 描述 |
|------|--------|------|
| Visual | 默认 | Milkdown WYSIWYG 实时渲染 |
| Source | `Cmd+/` | 原始 Markdown 等宽字体编辑 |
| Split | `Cmd+Shift+/` | 左右对比，源码 + 可视化同步 |

### 原生菜单结构

| 菜单 | 内容 |
|------|------|
| **File** | New, Open, Save, Save As, Export, Close |
| **Edit** | Undo, Redo, Cut, Copy, Paste, Select All, Find, Replace |
| **Paragraph** | H1-H6, Table, Code Block, Math Block, Quote, Lists, HR |
| **Format** | Bold, Italic, Strikethrough, Code, Link, Image |
| **View** | Visual/Source/Split Mode, Sidebar, AI Panel, Zoom |
| **Help** | About, Changelog, Feedback |

### 技术要点

- **SourceEditor**: 纯 `<textarea>` 等宽编辑，JS 自动高度调整（`field-sizing: content` 在 WKWebView 不支持）
- **Split 模式**: 黄金比例 38.2% / 61.8% 布局，`mouseenter` 判定活跃面板进行滚动同步
- **Rust 原生菜单**: Tauri v2 menu API，`CheckMenuItem` 实现模式切换勾选
- **i18n 系统**: 自定义响应式 `t()` 函数，支持 "Follow System" 通过 `navigator.language` 检测
- **CSS 假光标**: macOS WKWebView 空段落 focus 时通过 CSS `::before` 模拟光标（仅 `.platform-macos`）

---

## 核心架构

```
┌────────────────────────────────────────┐
│         Tauri WebView (Frontend)       │
│   Svelte 5 + Milkdown + TypeScript    │
│                                        │
│  ┌───────────┐ ┌───────┐ ┌──────────┐ │
│  │  Editor   │ │  AI   │ │ Settings │ │
│  │(Milkdown) │ │ Panel │ │  Panel   │ │
│  │ + Source  │ │       │ │ (tabbed) │ │
│  └─────┬─────┘ └──┬────┘ └────┬─────┘ │
│        │          │           │        │
│  ┌─────┴──────────┴───────────┴──────┐ │
│  │       Services & Stores           │ │
│  │  (file, AI, MCP, settings, i18n)  │ │
│  └───────────────┬───────────────────┘ │
│                  │ Tauri IPC (invoke)  │
└──────────────────┼─────────────────────┘
                   │
┌──────────────────┼─────────────────────┐
│         Rust Backend (Tauri)           │
│                                        │
│  ┌────────────┐ ┌──────────┐ ┌──────┐ │
│  │ File I/O   │ │ MCP Proc │ │ Menu │ │
│  │ Commands   │ │ Manager  │ │      │ │
│  └────────────┘ └──────────┘ └──────┘ │
└────────────────────────────────────────┘
```

---

## 关键设计决策

1. **SPA 模式**: SvelteKit + `adapter-static`，`fallback: "index.html"`，Tauri 无 Node.js 服务端
2. **无边框窗口**: `TitleBarStyle::Overlay` + macOS 红绿灯，`data-tauri-drag-region` 拖拽
3. **Milkdown v7**: Markdown-native WYSIWYG，优于 TipTap/ProseMirror-raw 的 Markdown 体验
4. **Svelte 5 Runes**: `$state()`, `$derived()`, `$effect()`, `$props()` — 不使用 Svelte 4 旧语法
5. **CSP**: 初始为 `null`（后续 v0.6.0 收紧）
6. **导出**: 内置 Markdown→HTML/LaTeX，高级格式 (PDF/DOCX) 预留 pandoc 接口

---

## 主要文件结构

| 文件 | 职责 |
|------|------|
| `src-tauri/src/lib.rs` | App 启动：插件、commands、窗口、菜单事件 |
| `src-tauri/src/menu.rs` | 原生菜单定义 |
| `src-tauri/src/commands/file.rs` | 文件 I/O commands |
| `src-tauri/src/commands/mcp.rs` | MCP stdio 进程管理 |
| `src/routes/+page.svelte` | 主页面：布局、菜单处理、快捷键 |
| `src/lib/editor/Editor.svelte` | Milkdown WYSIWYG 编辑器 |
| `src/lib/editor/SourceEditor.svelte` | 源码模式编辑器 |
| `src/lib/editor/setup.ts` | Milkdown 初始化（plugins、onChange） |
| `src/lib/components/TitleBar.svelte` | 无边框标题栏 |
| `src/lib/components/StatusBar.svelte` | 状态栏（字数、模式） |
| `src/lib/components/Sidebar.svelte` | 文件浏览器 |
| `src/lib/components/SettingsPanel.svelte` | 设置面板（General/Editor/Appearance/AI/MCP） |
| `src/lib/components/ai/AIChatPanel.svelte` | AI 聊天面板 |
| `src/lib/services/ai/providers.ts` | LLM API 适配器 |
| `src/lib/services/ai/ai-service.ts` | AI 编排、流式处理 |
| `src/lib/services/mcp/mcp-client.ts` | MCP 客户端（SSE/HTTP/stdio） |
| `src/lib/services/mcp/mcp-manager.ts` | MCP 连接管理 |
| `src/lib/stores/editor-store.ts` | 编辑器状态 |
| `src/lib/stores/settings-store.ts` | 设置状态 |
| `src/lib/i18n/i18n.ts` | 国际化引擎 |
| `src/lib/styles/variables.css` | CSS 变量（主题） |
| `src/lib/styles/editor.css` | 编辑器风格样式 |
