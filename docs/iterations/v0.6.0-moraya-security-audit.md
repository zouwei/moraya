# Moraya 开源项目安全评估报告

**项目**: [zouwei/moraya](https://github.com/zouwei/moraya)  
**版本**: v0.3.3 (截至 2026-02-08)  
**技术栈**: Tauri v2 + Svelte 5 + Rust + TypeScript  
**评估日期**: 2026-02-10  
**评估范围**: 基于 GitHub 仓库公开信息（README、项目结构、架构图、功能描述）

> ⚠️ **重要声明**: 由于网络限制，本评估基于仓库 README 完整内容、项目结构树和架构描述进行推断分析，未能逐行审计源代码。以下标注 **[需源码确认]** 的条目建议在获取源码后进一步验证。

---

## 一、项目概览

Moraya 是一个基于 Rust + Tauri v2 的 AI Markdown 编辑器，核心特性包括：

- 多 AI 供应商集成（Claude、OpenAI、Gemini、DeepSeek、Ollama）
- MCP 协议客户端（stdio / SSE / HTTP 三种传输方式）
- 本地文件 I/O 操作
- 多语言支持

**值得注意的是**：贡献者列表显示 `@claude`（AI）为项目第二贡献者，说明大量代码由 AI 生成，这本身带来代码质量和安全审查一致性的潜在风险。

---

## 二、🔴 高风险项

### 2.1 API Key 存储安全 — 高风险

**问题描述**：

项目支持 6 种 AI 供应商，其中 5 种需要用户输入 API Key（Claude、OpenAI、Gemini、DeepSeek、Custom API）。这些 Key 通过前端 Settings Panel 输入后，需要被持久化存储。

**架构分析**：

根据项目结构，设置数据流为：

```
Settings Panel (Svelte) → stores/ (状态管理) → 持久化存储
```

在 Tauri v2 应用中，常见的持久化方案有三种：

| 方案 | 存储位置 | 加密 | 风险等级 |
|------|---------|------|---------|
| WebView localStorage | SQLite (WebKit数据目录) | ❌ 明文 | 🔴 高 |
| Tauri Store Plugin | JSON 文件 (~/.config/moraya/) | ❌ 明文 | 🔴 高 |
| 系统 Keychain/Credential Store | OS 安全存储 | ✅ OS级加密 | 🟢 低 |

**[需源码确认]** 具体使用了哪种方案。但从以下线索推断，**大概率是前两种（明文存储）**：

1. 项目 README 中没有提及任何安全存储或加密措施
2. Rust 后端代码中仅包含 `file.rs`（文件 I/O），未见 keychain 相关命令
3. Tauri v2 没有内置加密存储插件，接入 Keychain 需要额外 Rust crate

**风险**：
- 任何有文件系统读取权限的进程/恶意软件可直接读取 API Key
- 备份工具可能将配置文件（含明文 Key）上传到云端
- 如果用户分享 macOS 的 Time Machine 备份，Key 随之泄露

**建议**：
- 使用系统级安全存储（macOS Keychain / Windows Credential Manager / Linux Secret Service）
- 至少对 Key 进行对称加密后再存储，密钥派生自硬件标识
- 在设置界面中掩码显示 Key（仅显示后 4 位）

---

### 2.2 API Key 网络传输安全 — 中高风险

**问题描述**：

AI 请求是从 **前端 WebView** 直接发起到各 AI 供应商 API 的（根据架构图，AI Panel 在前端层，且服务层标注为 `services/ai/`）。这意味着：

```
WebView (JavaScript) → fetch() → https://api.openai.com/v1/...
                    └─ Header: Authorization: Bearer sk-xxx...
```

**风险**：
- **CSP 配置不当** 可能允许注入脚本窃取 Key **[需源码确认 tauri.conf.json 中的 CSP]**
- 前端 JavaScript 内存中的 API Key 可被浏览器扩展（如果存在）或 DevTools 访问
- 如果 CSP 允许 `connect-src *`，恶意注入的脚本可将 Key 发送到任意服务器

**更安全的架构**：
- API 调用应通过 Rust 后端中转（Tauri IPC → Rust HTTP client → AI API）
- Key 仅存在于 Rust 进程内存中，不暴露给 WebView

---

### 2.3 应用未代码签名 — 高风险

**README 原文**：
> The app is not code-signed. If you see "Moraya is damaged and can't be opened", run `xattr -cr /Applications/Moraya.app`

**风险**：
- **供应链攻击**：用户无法验证下载的二进制文件是否被篡改
- **Gatekeeper 绕过**：`xattr -cr` 命令移除所有安全扩展属性，用户养成了对 Moraya 以及潜在的其他应用执行此命令的习惯
- **社会工程**：攻击者可分发修改版 Moraya（含后门），用户因习惯了绕过 Gatekeeper 而不会警觉
- GitHub Release 页面的二进制文件完整性仅依赖于 GitHub 账户安全

**建议**：
- 获取 Apple Developer ID 进行代码签名和公证
- 至少在 Release 中提供 SHA256 校验和
- 考虑使用 GitHub Actions + Tauri 的自动签名流程

---

## 三、🟡 中风险项

### 3.1 MCP 协议 — stdio 传输安全

**问题描述**：

MCP stdio 传输方式会在本地 **启动子进程** 并通过 stdin/stdout 通信。根据项目结构，MCP 进程管理在 Rust 后端：

```
Rust Backend → MCP Proc Manager → spawn(child_process)
```

**风险**：
- **[需源码确认]** 如果用户可配置任意可执行文件路径作为 MCP server，等同于 **远程代码执行**
- 子进程继承父进程的权限和环境变量
- 恶意 MCP server 配置（来自导入的配置文件或社会工程）可执行任意命令

**建议**：
- 限制可执行文件路径到白名单目录
- 显示明确的安全警告（"您正在启动外部程序"）
- 沙盒化 MCP 子进程

### 3.2 Tauri 权限范围 — 需审查

**文件**: `src-tauri/capabilities/default.json`

Tauri v2 使用 capabilities 文件定义 WebView 可以调用的后端功能范围。

**[需源码确认]** 关键检查点：
- `fs` 权限范围是否过大（是否允许读写整个文件系统）
- `shell` 权限是否开放（用于 MCP stdio）
- `http` 权限的域名白名单是否合理
- 是否启用了不必要的插件

**常见风险配置示例**：
```json
// 🔴 危险 - 允许访问任意路径
{ "identifier": "fs:default", "allow": [{ "path": "**" }] }

// 🟢 安全 - 限制到特定目录
{ "identifier": "fs:read", "allow": [{ "path": "$DOCUMENT/**" }] }
```

### 3.3 CSP (Content Security Policy) 配置

**文件**: `src-tauri/tauri.conf.json`

**[需源码确认]** 核心检查点：
- `script-src` 是否包含 `'unsafe-inline'` 或 `'unsafe-eval'`
- `connect-src` 是否为 `*`（允许连接任意域名）
- 是否允许加载外部资源

对于需要连接多个 AI API 的应用，CSP 的 `connect-src` 需要包含：
```
https://api.anthropic.com
https://api.openai.com
https://generativelanguage.googleapis.com
https://api.deepseek.com
http://localhost:11434  (Ollama)
```

如果为了兼容"自定义 API endpoint"而设置 `connect-src: *`，则任何 XSS 漏洞都可导致 Key 外泄。

### 3.4 文件 I/O 安全

**Rust 后端命令**：
- `read_file` — 读取文件
- `write_file` — 写入文件
- `read_dir_recursive` — 递归读取目录

**[需源码确认]** 风险点：
- 是否有路径遍历（path traversal）保护？如 `../../etc/passwd`
- 写入操作是否限制在用户工作目录内？
- `read_dir_recursive` 是否有深度/数量限制？

---

## 四、🟢 低风险项（但值得关注）

### 4.1 依赖安全

| 层 | 包管理器 | 风险 |
|----|---------|------|
| Frontend | pnpm (pnpm-lock.yaml) | 需检查 `pnpm audit` |
| Backend | Cargo (Cargo.lock) | 需检查 `cargo audit` |

**建议**：定期运行依赖审计，启用 GitHub Dependabot。

### 4.2 AI 生成代码质量

项目有两位贡献者：`@zouwei` 和 `@claude`（AI）。AI 生成的代码可能存在：
- 安全模式的不一致应用
- 对边界情况处理不足
- 过度信任用户输入

**建议**：对 AI 生成的安全关键代码进行人工审查。

### 4.3 GitHub Actions CI/CD

存在 `.github/workflows/` 目录，**[需源码确认]** 是否在 CI 流程中泄露 secrets（如签名密钥、API keys）。

---

## 五、综合评估矩阵

| # | 风险项 | 严重度 | 可能性 | 确认状态 |
|---|--------|--------|--------|---------|
| 1 | API Key 明文本地存储 | 🔴 高 | 🔴 高 | 需源码确认 |
| 2 | API Key 前端直接发送（非后端中转） | 🟡 中 | 🔴 高 | 架构图推断 |
| 3 | 应用未代码签名 | 🔴 高 | 🟡 中 | ✅ 已确认 |
| 4 | MCP stdio 可能允许任意进程执行 | 🔴 高 | 🟡 中 | 需源码确认 |
| 5 | Tauri 权限范围可能过大 | 🟡 中 | 🟡 中 | 需源码确认 |
| 6 | CSP 可能对 connect-src 过于宽松 | 🟡 中 | 🟡 中 | 需源码确认 |
| 7 | 文件路径遍历 | 🟡 中 | 🟢 低 | 需源码确认 |
| 8 | 依赖链安全 | 🟡 中 | 🟡 中 | 需审计 |

---

## 六、Key 上传风险专项分析

针对你特别关注的"是否有上传 Key 的安全逻辑"：

### 是否会将 Key 上传到远程服务器？

**从可观察信息分析，暂未发现明确的 Key 上传行为**，理由如下：

1. **无自有后端服务**：项目是纯客户端 Tauri 桌面应用，官网 moraya.app 返回 403，未见活跃的服务端
2. **无遥测/分析代码迹象**：README 未提及任何数据收集声明
3. **AI 调用直连供应商**：API Key 直接发送到对应供应商的官方 endpoint

**但无法排除的风险**：
- **[需源码确认]** 是否有隐藏的遥测或数据上报逻辑
- **[需源码确认]** `connect-src` CSP 是否限制了出站连接域名
- 如果未限制，理论上前端代码可以将 Key 发送到任意服务器
- GitHub Release 的二进制文件未签名，无法保证与源码一致

### 确认 Key 安全的推荐步骤

```bash
# 1. 克隆源码并自行编译（不使用预编译二进制）
git clone https://github.com/zouwei/moraya.git
cd moraya

# 2. 全局搜索可疑的网络请求
grep -rn "fetch\|axios\|http\|XMLHttpRequest" src/lib/services/
grep -rn "telemetry\|analytics\|tracking\|beacon" src/

# 3. 检查 API Key 是否只发送到合法 endpoint
grep -rn "apiKey\|api_key\|Authorization\|Bearer" src/

# 4. 检查 Tauri CSP 和权限配置
cat src-tauri/tauri.conf.json | grep -A5 "csp"
cat src-tauri/capabilities/default.json

# 5. 检查本地存储方式
grep -rn "localStorage\|store\|persist\|save.*key\|keychain" src/

# 6. 运行依赖审计
pnpm audit
cd src-tauri && cargo audit

# 7. 抓包验证（运行时检查所有出站请求）
# macOS: 使用 Charles Proxy 或 mitmproxy 监控
# 确认所有请求只发往已知的 AI API 域名
```

---

## 七、总结与建议

### 整体评价

Moraya 是一个功能设计合理的 AI Markdown 编辑器，但在安全层面存在多个需要关注的点。**对于个人使用**，在自行编译并验证出站请求后，风险可控。**对于企业/团队使用**，建议在以下问题解决前谨慎采用：

### 优先修复建议

1. **🔴 P0** — 实现系统级安全存储（Keychain）存放 API Key
2. **🔴 P0** — 实现代码签名，或至少提供 SHA256 校验和
3. **🟡 P1** — 将 AI API 调用移至 Rust 后端（Key 不经过 WebView）
4. **🟡 P1** — 审查并收紧 Tauri capabilities 和 CSP
5. **🟡 P2** — 添加 MCP server 启动安全提示
6. **🟢 P3** — 建立依赖审计自动化流程
