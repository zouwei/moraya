# v0.13.0 AI è§†è§‰è¾“å…¥ï¼ˆVision Inputï¼‰

> è¿­ä»£ç‰ˆæœ¬: v0.13.0
> ä¸Šä¸€ç‰ˆæœ¬: v0.12.0
> åˆ›å»ºæ—¥æœŸ: 2026-02-24
> çŠ¶æ€: âœ… å·²å®Œæˆ

---

## ç‰ˆæœ¬æ¦‚è¦

ä¸º AI èŠå¤©é¢æ¿æ·»åŠ å›¾ç‰‡è¾“å…¥èƒ½åŠ›ï¼Œæ”¯æŒæˆªå›¾æé—®ã€å›¾ç‰‡åˆ†æã€OCR ç­‰å¤šæ¨¡æ€äº¤äº’åœºæ™¯ã€‚é€‚é… Claudeã€OpenAIã€Geminiã€Ollama å››ä¸ªä¸»æµæä¾›å•†çš„è§†è§‰ API æ ¼å¼ï¼Œè‡ªåŠ¨å‹ç¼©å¤§å›¾ä»¥èŠ‚çœ tokensã€‚

---

## éœ€æ±‚èƒŒæ™¯

### å½“å‰ç°çŠ¶

| èƒ½åŠ› | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| AI æ–‡æœ¬å¯¹è¯ | âœ… | å¤šæä¾›å•†æµå¼å¯¹è¯ï¼ŒTool Use æ”¯æŒ |
| å›¾ç‰‡æ’å…¥ç¼–è¾‘å™¨ | âœ… | ç²˜è´´ã€æ‹–æ‹½ã€æ–‡ä»¶é€‰æ‹©æ’å…¥ Markdown |
| å›¾ç‰‡ base64 è½¬æ¢ | âœ… | blob URLã€readAsDataURL åŸºç¡€è®¾æ–½å®Œæ•´ |
| **AI å›¾ç‰‡è¾“å…¥** | âŒ | èŠå¤©ä»…æ”¯æŒçº¯æ–‡æœ¬ï¼Œæ— æ³•ä¼ å›¾ |
| **å¤šæ¨¡æ€ API é€‚é…** | âŒ | å„æä¾›å•† API æ ¼å¼æœªå®ç° |

### æä¾›å•†è§†è§‰èƒ½åŠ›

| æä¾›å•† | è§†è§‰æ”¯æŒ | å¤‡æ³¨ |
|--------|----------|------|
| Claude | âœ… | claude-opus-4-6, claude-sonnet-4-6, claude-3-5-haiku |
| OpenAI | âœ… | gpt-4o, gpt-4o-mini |
| Gemini | âœ… | gemini-2.0-flash, gemini-1.5-pro |
| Ollama | âœ… | llava, bakllava ç­‰è§†è§‰æ¨¡å‹ |
| DeepSeek | âŒ | ä¸æ”¯æŒå›¾ç‰‡è¾“å…¥ |

### ç›®æ ‡

- èŠå¤©è¾“å…¥åŒºæ”¯æŒå›¾ç‰‡é™„åŠ ï¼ˆæŒ‰é’®ã€ç²˜è´´ã€æ‹–æ‹½ï¼‰
- å·²é™„å›¾ç‰‡æ˜¾ç¤ºç¼©ç•¥å›¾é¢„è§ˆï¼Œå¯ç§»é™¤
- å‘é€åæ¶ˆæ¯ä¸­å±•ç¤ºå›¾ç‰‡ç¼©ç•¥å›¾ï¼Œå¯æ”¾å¤§æŸ¥çœ‹
- è‡ªåŠ¨é€‚é…å„æä¾›å•†çš„å¤šæ¨¡æ€æ¶ˆæ¯æ ¼å¼
- å¤§å›¾è‡ªåŠ¨å‹ç¼©ï¼ŒèŠ‚çœ API tokens
- ä¿®å¤æµå¼è¯·æ±‚æ¶ˆæ¯æ„å»ºä¸¢å¤±å­—æ®µçš„é—®é¢˜

---

## åŠŸèƒ½è®¾è®¡

### F1: æ•°æ®æ¨¡å‹æ‰©å±•

#### æ–°å¢ `ImageAttachment` æ¥å£

```typescript
export interface ImageAttachment {
  id: string;           // crypto.randomUUID()
  mimeType: string;     // "image/jpeg", "image/png", etc.
  base64: string;       // base64 ç¼–ç æ•°æ®ï¼ˆæ—  data: å‰ç¼€ï¼‰
  previewUrl?: string;  // blob URLï¼Œä»…ç”¨äº UI å±•ç¤º
}
```

#### `ChatMessage` æ‰©å±•

```typescript
export interface ChatMessage {
  // ...existing fields...
  images?: ImageAttachment[];  // ä»… user æ¶ˆæ¯ä½¿ç”¨
}
```

**è®¾è®¡å†³ç­–**ï¼š`content` ä¿æŒ `string` ä¸å˜ï¼Œæ–°å¢ç‹¬ç«‹ `images` å­—æ®µï¼Œé¿å…ä¿®æ”¹æ‰€æœ‰æ¶ˆè´¹ `content` çš„ä»£ç ã€‚

---

### F2: å›¾ç‰‡é™„åŠ  UI

#### è¾“å…¥æ–¹å¼

1. **ğŸ“ æŒ‰é’®**ï¼šè¾“å…¥åŒº textarea å·¦ä¾§æ–°å¢å›¾ç‰‡æŒ‰é’®ï¼Œç‚¹å‡»æ‰“å¼€ç³»ç»Ÿæ–‡ä»¶é€‰æ‹©å™¨
2. **Cmd+V ç²˜è´´**ï¼šæ£€æµ‹ `clipboardData.items` ä¸­çš„ `image/*`ï¼Œæœ‰åˆ™æ‹¦æˆªæ·»åŠ å›¾ç‰‡
3. **æ‹–æ‹½**ï¼šè¾“å…¥åŒºåŸŸç›‘å¬ `drop` äº‹ä»¶ï¼Œæ£€æµ‹ `dataTransfer.files` ä¸­çš„å›¾ç‰‡

#### çº¦æŸ

- æ¯æ¡æ¶ˆæ¯æœ€å¤š 5 å¼ å›¾ç‰‡
- è¶…é™æ—¶æç¤º "æœ€å¤šé™„åŠ  5 å¼ å›¾ç‰‡"
- å‘é€æ¡ä»¶ï¼šæ–‡æœ¬ æˆ– å›¾ç‰‡ è‡³å°‘æœ‰ä¸€é¡¹ï¼ˆçº¯å›¾ç‰‡å¯å‘é€ï¼‰

---

### F3: ç¼©ç•¥å›¾é¢„è§ˆæ¡

è¾“å…¥åŒºä¸Šæ–¹æ˜¾ç¤ºå·²é™„å›¾ç‰‡çš„ç¼©ç•¥å›¾é¢„è§ˆæ¡ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€ image-preview-strip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â† ä»…åœ¨æœ‰å›¾ç‰‡æ—¶æ˜¾ç¤º
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”        â”‚ â”‚
â”‚  â”‚ â”‚ img1 â”‚ â”‚ img2 â”‚ â”‚ img3 â”‚        â”‚ â”‚  â† 48x48px ç¼©ç•¥å›¾
â”‚  â”‚ â”‚  [x] â”‚ â”‚  [x] â”‚ â”‚  [x] â”‚        â”‚ â”‚  â† hover æ˜¾ç¤ºç§»é™¤æŒ‰é’®
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€ input-row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ [ğŸ“]  [textarea...         ] [â¤] â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- ç¼©ç•¥å›¾ 48x48pxï¼Œ`object-fit: cover`ï¼Œåœ†è§’
- hover æ—¶æ˜¾ç¤ºå³ä¸Šè§’ Ã— ç§»é™¤æŒ‰é’®
- æ°´å¹³æ’åˆ—ï¼Œè¶…å‡ºæ—¶æ¨ªå‘æ»šåŠ¨

---

### F4: æ¶ˆæ¯å›¾ç‰‡å±•ç¤º

ç”¨æˆ·æ¶ˆæ¯ä¸­ä»¥ç¼©ç•¥å›¾æ˜¾ç¤ºå·²å‘é€çš„å›¾ç‰‡ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ You                               â”‚
â”‚ "è¿™æ®µä»£ç æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ"             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”               â”‚  â† 64x64px ç¼©ç•¥å›¾
â”‚ â”‚ img1 â”‚ â”‚ img2 â”‚               â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                         12:34 PM â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- ç‚¹å‡»ç¼©ç•¥å›¾ â†’ å…¨å±é®ç½©æ”¾å¤§æŸ¥çœ‹ï¼ˆlightboxï¼‰
- å›¾ç‰‡ src ä¼˜å…ˆä½¿ç”¨ `previewUrl`ï¼ˆblob URLï¼‰ï¼Œé™çº§ä½¿ç”¨ `data:{mimeType};base64,...` URL
- ESC æˆ–ç‚¹å‡»é®ç½©å…³é—­ lightbox

---

### F5: Provider é€‚é…

å„æä¾›å•†çš„å¤šæ¨¡æ€æ¶ˆæ¯æ ¼å¼ä¸åŒï¼Œéœ€åœ¨ `buildXxxMessages` å‡½æ•°ä¸­å¤„ç† `images` å­—æ®µï¼š

| Provider | æ ¼å¼ | å¤‡æ³¨ |
|----------|------|------|
| **Claude** | `content: [{ type: "image", source: { type: "base64", media_type, data } }, { type: "text", text }]` | images æ”¾åœ¨ text å‰é¢ |
| **OpenAI** | `content: [{ type: "image_url", image_url: { url: "data:mime;base64,..." } }, { type: "text", text }]` | data URL æ ¼å¼ |
| **Gemini** | `parts: [{ inlineData: { mimeType, data } }, { text }]` | å·²ä½¿ç”¨æ•°ç»„ç»“æ„ |
| **Ollama** | `content: "text", images: ["base64"]` | images æ˜¯ç‹¬ç«‹å­—æ®µ |
| **DeepSeek** | ä¸æ”¯æŒè§†è§‰ | API æŠ¥é”™ç”±ç°æœ‰ error handling æ•è· |

#### ä¿®æ”¹ç‚¹

- `buildClaudeMessages()`ï¼šå½“ `msg.images?.length > 0` æ—¶æ„å»º content æ•°ç»„
- `buildOpenAIMessages()`ï¼šå½“ `msg.images?.length > 0` æ—¶æ„å»º content æ•°ç»„
- `buildGeminiContents()`ï¼šåœ¨ parts ä¸­æ·»åŠ  inlineData é¡¹
- æ–°å¢ `buildOllamaMessages()`ï¼šOllama åŸç”Ÿ API å°† images ä½œä¸ºæ¶ˆæ¯çº§ `images: string[]` å­—æ®µ

---

### F6: æµå¼è¯·æ±‚ä¿®å¤ï¼ˆæ†ç»‘ä¿®å¤ï¼‰

**é—®é¢˜**ï¼š`streamClaude` å’Œ `streamOpenAICompatible` ä½¿ç”¨ç®€åŒ–çš„ `.map(m => ({ role, content }))` æ„å»ºæ¶ˆæ¯ï¼Œä¸¢å¤±äº† `toolCalls`ã€`toolCallId` å’Œ `images` å­—æ®µã€‚

**ä¿®å¤**ï¼š
- `streamClaude` â†’ æ”¹ç”¨ `buildClaudeMessages(chatMessages)`
- `streamOpenAICompatible` â†’ æ”¹ç”¨ `buildOpenAIMessages(request.messages)`

---

### F7: å›¾ç‰‡å‹ç¼©

æ–°å¢ `image-utils.ts` å·¥å…·æ¨¡å—ï¼š

```typescript
export async function compressImage(
  blob: Blob, maxDimension?: number, quality?: number
): Promise<{ blob: Blob; mimeType: string }>

export async function blobToBase64(blob: Blob): Promise<string>
```

**å‹ç¼©ç­–ç•¥**ï¼š
- é•¿è¾¹ >1568px æ—¶é€šè¿‡ Canvas ç¼©æ”¾ï¼ˆ1568 æ˜¯ Claude æ¨èçš„æœ€å¤§è¾¹é•¿ï¼‰
- è½¬ä¸º JPEG 80%ï¼ˆGIF è·³è¿‡å‹ç¼©ï¼Œä¿ç•™åŠ¨ç”»ï¼‰
- åŸå›¾ <1MB ä¸”å°ºå¯¸åˆè§„åˆ™ä¿æŒåŸæ ¼å¼ä¸å˜

---

### F8: i18n

æ–°å¢ç¿»è¯‘ keyï¼š

| Key | English | ä¸­æ–‡ |
|-----|---------|------|
| `ai.attachImage` | Attach image | é™„åŠ å›¾ç‰‡ |
| `ai.attachImageMax` | Maximum {max} images | æœ€å¤š {max} å¼ å›¾ç‰‡ |
| `ai.removeImage` | Remove image | ç§»é™¤å›¾ç‰‡ |
| `ai.closePreview` | Close preview | å…³é—­é¢„è§ˆ |

---

## æŠ€æœ¯è¦ç‚¹

### AI Service å±‚

`sendChatMessage` ç­¾åæ‰©å±•ï¼Œæ¥æ”¶ `images` å‚æ•°ã€‚æ„å»º API è¯·æ±‚æ—¶ä»…ä¿ç•™æœ€è¿‘ 5 æ¡æ¶ˆæ¯çš„ `images`ï¼Œæ›´æ—©çš„æ¶ˆæ¯å‰¥ç¦»å›¾ç‰‡ï¼ˆèŠ‚çœ tokensï¼‰ï¼Œä¸å½±å“ UI å±•ç¤ºã€‚

### Rust Proxy

**æ— éœ€ä¿®æ”¹**ã€‚`ai_proxy_fetch`/`ai_proxy_stream` å°† JSON body åŸæ ·è½¬å‘ï¼Œbase64 å›¾ç‰‡æ•°æ®åµŒåœ¨ JSON çš„ messages ä¸­ã€‚

### å†…å­˜ç®¡ç†

- å¾…å‘é€å›¾ç‰‡ï¼šblob URL ç”¨äºé¢„è§ˆï¼Œå‘é€åç”± ChatMessage æŒæœ‰
- æ¸…ç©ºèŠå¤©æ—¶éå† chatHistory è°ƒç”¨ `URL.revokeObjectURL`
- ç»„ä»¶é”€æ¯æ—¶æ¸…ç†æœªå‘é€çš„ pending images

---

## æ–‡ä»¶å˜æ›´æ¸…å•

### ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶ | å˜æ›´ |
|------|------|
| `src/lib/services/ai/types.ts` | æ–°å¢ `ImageAttachment` æ¥å£ï¼Œ`ChatMessage` æ·»åŠ  `images?` å­—æ®µ |
| `src/lib/services/ai/index.ts` | å¯¼å‡º `ImageAttachment` ç±»å‹ |
| `src/lib/services/ai/providers.ts` | 4 ä¸ª `buildXxxMessages` å¤„ç† images + æ–°å¢ `buildOllamaMessages` + 2 ä¸ª stream å‡½æ•°ä¿®å¤ |
| `src/lib/services/ai/ai-service.ts` | `sendChatMessage` æ¥æ”¶ images å‚æ•° + å†å²å›¾ç‰‡è£å‰ª |
| `src/lib/components/ai/AIChatPanel.svelte` | å›¾ç‰‡æŒ‰é’®ã€ç²˜è´´/æ‹–æ‹½ã€é¢„è§ˆæ¡ã€æ¶ˆæ¯å›¾ç‰‡å±•ç¤ºã€lightbox |
| `src/lib/i18n/locales/en.json` | æ–°å¢å›¾ç‰‡ç›¸å…³ç¿»è¯‘ key |
| `src/lib/i18n/locales/zh-CN.json` | å¯¹åº”ä¸­æ–‡ç¿»è¯‘ |

### æ–°å¢æ–‡ä»¶

| æ–‡ä»¶ | ç”¨é€” |
|------|------|
| `src/lib/services/ai/image-utils.ts` | å›¾ç‰‡å‹ç¼© + blobToBase64 |

### æ— éœ€ä¿®æ”¹

| æ–‡ä»¶ | åŸå›  |
|------|------|
| `src-tauri/src/commands/ai_proxy.rs` | JSON body åŸæ ·è½¬å‘ |
| `src-tauri/tauri.conf.json` | æ— éœ€æ–°æƒé™ |
| `src-tauri/capabilities/default.json` | å·²æœ‰ `dialog:open` |

---

## å®æ–½é¡ºåº

| é˜¶æ®µ | å†…å®¹ | ä¾èµ– |
|------|------|------|
| **A** | `types.ts` + `index.ts` â€” æ•°æ®æ¨¡å‹ | æ—  |
| **B** | `image-utils.ts` â€” å‹ç¼©å·¥å…· | æ—  |
| **C** | `providers.ts` â€” 4 ä¸ª buildMessages + buildOllamaMessages + 2 ä¸ª stream ä¿®å¤ | A |
| **D** | `ai-service.ts` â€” sendChatMessage æ‰©å±• + å†å²è£å‰ª | A |
| **E** | `AIChatPanel.svelte` â€” å®Œæ•´ UI | A, B, D |
| **F** | i18n + éªŒè¯ | E |

---

## éªŒè¯æ–¹æ¡ˆ

1. ç‚¹å‡»ğŸ“æŒ‰é’® â†’ æ–‡ä»¶é€‰æ‹©å™¨ â†’ å›¾ç‰‡å‡ºç°åœ¨é¢„è§ˆæ¡
2. Cmd+V ç²˜è´´æˆªå›¾ â†’ å›¾ç‰‡å‡ºç°åœ¨é¢„è§ˆæ¡
3. æ‹–æ‹½å›¾ç‰‡æ–‡ä»¶åˆ°è¾“å…¥åŒº â†’ å›¾ç‰‡å‡ºç°åœ¨é¢„è§ˆæ¡
4. ç¼©ç•¥å›¾ Ã— æŒ‰é’®ç§»é™¤å›¾ç‰‡
5. è¶…è¿‡ 5 å¼ æ—¶ä¸å…è®¸æ·»åŠ 
6. å‘é€åç”¨æˆ·æ¶ˆæ¯ä¸­æ˜¾ç¤ºå›¾ç‰‡ç¼©ç•¥å›¾ï¼Œç‚¹å‡»å¯æ”¾å¤§
7. Claude: å›¾ç‰‡ + æ–‡å­— â†’ æ­£ç¡®è§†è§‰åˆ†æå›å¤
8. OpenAI (GPT-4o): åŒä¸Š
9. Gemini: åŒä¸Š
10. DeepSeek: é™„å›¾å‘é€ â†’ API æŠ¥é”™æ­£ç¡®å±•ç¤º
11. ç²˜è´´çº¯æ–‡æœ¬æ—¶ä¸è§¦å‘å›¾ç‰‡é€»è¾‘
12. IME è¾“å…¥ä¸­ç²˜è´´æˆªå›¾ä¸å½±å“ç»„åˆæ–‡å­—
13. å¤§å›¾ï¼ˆ4000x3000pxï¼‰è¢«å‹ç¼©åæ­£å¸¸å‘é€
14. çº¯å›¾ç‰‡æ— æ–‡å­—å¯å‘é€
15. `pnpm check` 0 errors
