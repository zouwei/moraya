# Moraya å®‰å…¨æ¶æ„å‡çº§ (v0.6.0)

> è¿­ä»£ç‰ˆæœ¬: v0.6.0
> ä¸Šä¸€ç‰ˆæœ¬: v0.5.4
> åˆ›å»ºæ—¥æœŸ: 2026-02-10
> çŠ¶æ€: âœ… å·²å®Œæˆ
> å‰ç½®æ–‡æ¡£: [å®‰å…¨è¯„ä¼°æŠ¥å‘Š](v0.6.0-moraya-security-audit.md)

---

## ç‰ˆæœ¬æ¦‚è¦

åŸºäºç¬¬ä¸‰æ–¹å®‰å…¨è¯„ä¼° + æºç éªŒè¯ï¼Œå¯¹ Moraya è¿›è¡Œç³»ç»Ÿæ€§å®‰å…¨æ¶æ„å‡çº§ã€‚æ ¸å¿ƒç›®æ ‡ï¼š**API Key å…¨é“¾è·¯ä¿æŠ¤**ï¼ˆå­˜å‚¨åŠ å¯† + åç«¯ä¸­è½¬ + CSP æ”¶ç´§ï¼‰ï¼ŒåŒæ—¶åŠ å›º MCP å¯åŠ¨å®‰å…¨å’Œæ–‡ä»¶è·¯å¾„æ ¡éªŒã€‚

### ç¬¬ä¸€è½®é£é™©æ¸…å•ï¼ˆç¬¬ä¸‰æ–¹è¯„ä¼° + æºç éªŒè¯ï¼‰

| # | é£é™©é¡¹ | ä¸¥é‡åº¦ | æºç ç¡®è®¤çŠ¶æ€ | æœ¬ç‰ˆæœ¬å¤„ç† |
|---|--------|--------|-------------|-----------|
| 1 | API Key æ˜æ–‡å­˜å‚¨ï¼ˆTauri Store â†’ `ai-config.json`ï¼‰ | ğŸ”´ é«˜ | âœ… å·²ç¡®è®¤ | âœ… F1 |
| 2 | API Key å‰ç«¯ç›´å‘ï¼ˆWebView `fetch()` æºå¸¦ Keyï¼‰ | ğŸ”´ é«˜ | âœ… å·²ç¡®è®¤ | âœ… F2 |
| 3 | CSP å®Œå…¨ç¦ç”¨ï¼ˆ`"csp": null`ï¼‰ | ğŸ”´ é«˜ | âœ… å·²ç¡®è®¤ | âœ… F3 |
| 4 | MCP stdio ä»»æ„è¿›ç¨‹æ‰§è¡Œï¼ˆæ— ç™½åå•/ç¡®è®¤ï¼‰ | ğŸŸ¡ ä¸­ | âœ… å·²ç¡®è®¤ | âœ… F4 |
| 5 | æ–‡ä»¶è·¯å¾„éå†ï¼ˆè‡ªå®šä¹‰ command æ— æ ¡éªŒï¼‰ | ğŸŸ¡ ä¸­ | âœ… å·²ç¡®è®¤ | âœ… F5 |
| 6 | Tauri capabilities è¿‡å®½ï¼ˆ`fs:scope-home` + `http://**`ï¼‰ | ğŸŸ¡ ä¸­ | âœ… å·²ç¡®è®¤ | âœ… F3 |
| 7 | åº”ç”¨æœªä»£ç ç­¾å | ğŸ”´ é«˜ | âœ… å·²ç¡®è®¤ | ğŸ”œ åç»­ç‰ˆæœ¬ |
| 8 | ä¾èµ–é“¾å®‰å…¨ | ğŸŸ¡ ä¸­ | å¾…å®¡è®¡ | ğŸ”œ åç»­ç‰ˆæœ¬ |

### ç¬¬äºŒè½®é£é™©æ¸…å•ï¼ˆæºç å±‚é¢æ·±åº¦å®¡è®¡ï¼‰

| # | é£é™©é¡¹ | ä¸¥é‡åº¦ | æºç ä½ç½® | æœ¬ç‰ˆæœ¬å¤„ç† |
|---|--------|--------|---------|-----------|
| 9 | MCP åŠ¨æ€æœåŠ¡ï¼šAI ç”Ÿæˆ JS ç» `require()` ç›´æ¥æ‰§è¡Œï¼Œæ— æ²™ç›’ | ğŸ”´ ä¸¥é‡ | `mcp-runtime.ts:31`, `container-manager.ts:125` | âœ… F4 |
| 10 | `check_command_exists` æ¥å—ä»»æ„å‘½ä»¤å‚æ•°æ‰§è¡Œ | ğŸ”´ ä¸¥é‡ | `mcp.rs:176-192` | âœ… F4 |
| 11 | MCP å­è¿›ç¨‹ `kill()` åæœª `wait()`ï¼Œäº§ç”Ÿåƒµå°¸è¿›ç¨‹ | ğŸ”´ é«˜ | `mcp.rs:145-175` | âœ… F4 |
| 12 | `dock.rs` unsafe ObjC FFI æ—  NULL æ£€æŸ¥ | ğŸ”´ é«˜ | `dock.rs:10-80` | âœ… F9 |
| 13 | Export HTML æ³¨å…¥ï¼ˆ`innerHTML` èµ‹å€¼æœªè½¬ä¹‰ï¼‰ | ğŸŸ¡ ä¸­ | `export-service.ts:263` | âœ… F7 |
| 14 | Rust é”™è¯¯ä¿¡æ¯æ³„éœ²æ–‡ä»¶ç³»ç»Ÿè·¯å¾„ | ğŸŸ¡ ä¸­ | `file.rs`, `mcp.rs` | âœ… F8 |
| 15 | MCP å“åº”æ— ç¼“å†²åŒºé™åˆ¶ï¼ˆè¡Œè¯»å–æ— ä¸Šé™ï¼‰ | ğŸŸ¡ ä¸­ | `mcp.rs:101-135` | âœ… F4 |
| 16 | MCP ç¯å¢ƒå˜é‡æœªè¿‡æ»¤ï¼ˆ`LD_PRELOAD` ç­‰å¯æ³¨å…¥ï¼‰ | ğŸŸ¡ ä¸­ | `mcp.rs:36-79` | âœ… F4 |
| 17 | `Math.random()` ç”¨äºå®‰å…¨ç›¸å…³ ID ç”Ÿæˆ | ğŸŸ¢ ä½ | `mcp-client.ts`, `ai-service.ts` | âœ… F4 |

---

## åŠŸèƒ½æ¸…å•

| ID | åŠŸèƒ½ | ç±»å‹ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|----|------|------|--------|------|
| F1 | API Key ç³»ç»Ÿ Keychain å®‰å…¨å­˜å‚¨ | åç«¯ | P0 | âœ… å·²å®Œæˆ |
| F2 | AI è°ƒç”¨ Rust åç«¯ä¸­è½¬ï¼ˆæµå¼ï¼‰ | åç«¯ + å‰ç«¯ | P0 | âœ… å·²å®Œæˆ |
| F3 | CSP æ”¶ç´§ + Tauri capabilities ç²¾ç®€ | é…ç½® | P0 | âœ… å·²å®Œæˆ |
| F4 | MCP å…¨é¢å®‰å…¨åŠ å›º | åç«¯ + å‰ç«¯ | P1 | âœ… å·²å®Œæˆ |
| F5 | æ–‡ä»¶è·¯å¾„æ ¡éªŒåŠ å›º | åç«¯ | P1 | âœ… å·²å®Œæˆ |
| F6 | å®‰å…¨è§„èŒƒæ–‡æ¡£ï¼ˆé¢å‘åç»­è¿­ä»£ï¼‰ | æ–‡æ¡£ | P2 | âœ… å·²å®Œæˆ |
| F7 | Export HTML æ³¨å…¥é˜²æŠ¤ | å‰ç«¯ | P1 | âœ… å·²å®Œæˆ |
| F8 | é”™è¯¯ä¿¡æ¯è„±æ• | åç«¯ | P2 | âœ… å·²å®Œæˆ |
| F9 | Unsafe FFI å®‰å…¨åŠ å›ºï¼ˆdock.rsï¼‰ | åç«¯ | P2 | âœ… å·²å®Œæˆ |

---

## F1: API Key ç³»ç»Ÿ Keychain å®‰å…¨å­˜å‚¨

### ç°çŠ¶

```
AISettings (Svelte) â†’ ai-service.ts â†’ Tauri Store plugin â†’ ai-config.json (æ˜æ–‡ JSON)
```

API Key ä»¥æ˜æ–‡ä¿å­˜åœ¨ `~/.config/moraya/ai-config.json`ï¼Œä»»ä½•æœ‰æ–‡ä»¶è¯»å–æƒé™çš„è¿›ç¨‹å¯ç›´æ¥è·å–ã€‚

### æ–¹æ¡ˆ

ä½¿ç”¨ Rust `keyring` crate æ¥å…¥æ“ä½œç³»ç»ŸåŸç”Ÿå®‰å…¨å­˜å‚¨ï¼š

| å¹³å° | åº•å±‚å­˜å‚¨ | åŠ å¯†æ–¹å¼ |
|------|---------|---------|
| macOS | Keychain Services | AES-256 (ç¡¬ä»¶å®‰å…¨èŠ¯ç‰‡) |
| Windows | Credential Manager | DPAPI |
| Linux | Secret Service (GNOME Keyring / KWallet) | ç”¨æˆ·ç™»å½•å¯†é’¥é“¾ |

### æŠ€æœ¯è§„æ ¼

#### Rust ä¾§

**æ–°å¢ä¾èµ–**ï¼š
```toml
# src-tauri/Cargo.toml
keyring = { version = "3", features = ["apple-native", "windows-native", "linux-native"] }
```

**æ–°å¢ Tauri commands**ï¼ˆ`src-tauri/src/commands/keychain.rs`ï¼‰ï¼š

```rust
const SERVICE_NAME: &str = "com.moraya.app";

#[tauri::command]
pub fn keychain_set(key: String, value: String) -> Result<(), String>;

#[tauri::command]
pub fn keychain_get(key: String) -> Result<Option<String>, String>;

#[tauri::command]
pub fn keychain_delete(key: String) -> Result<(), String>;
```

Key å‘½åè§„åˆ™ï¼š`ai-key:{configId}`ï¼Œä¾‹å¦‚ `ai-key:abc123`ã€‚

#### å‰ç«¯ä¾§

**ä¿®æ”¹ `ai-service.ts`**ï¼š
- `persistAIConfigs()`: ä¿å­˜é…ç½®æ—¶ï¼Œ`apiKey` å­—æ®µå†™å…¥ Keychainï¼ˆé€šè¿‡ IPCï¼‰ï¼ŒTauri Store ä¸­ä»…ä¿å­˜ `apiKey: "***"` å ä½ç¬¦
- `loadAIConfigs()`: åŠ è½½é…ç½®æ—¶ï¼Œä» Keychain å–å›çœŸå® Key å¡«å…¥å†…å­˜å¯¹è±¡

**ä¿®æ”¹ `image-service.ts`**ï¼š
- å›¾ç‰‡ç”Ÿæˆé…ç½®çš„ `apiKey` åŒç†è¿ç§»

**æ•°æ®è¿ç§»**ï¼š
- é¦–æ¬¡å¯åŠ¨æ£€æµ‹ï¼šå¦‚æœ Tauri Store ä¸­ `apiKey` ä¸æ˜¯ `"***"`ï¼Œè¯´æ˜æ˜¯æ—§ç‰ˆæ˜æ–‡å­˜å‚¨
- è‡ªåŠ¨å°†æ—§ Key è¿å…¥ Keychainï¼ŒStore ä¸­æ›¿æ¢ä¸º `"***"`
- è¿ç§»å®Œæˆååˆ é™¤æ—§æ˜æ–‡æ–‡ä»¶ä¸­çš„ Key

### é¢„ä¼°åŒ…å¤§å°å½±å“

`keyring` crate è°ƒç”¨ç³»ç»ŸåŸç”Ÿ APIï¼Œä¸å¼•å…¥é¢å¤–åŠ å¯†åº“ï¼ˆ`ring` å·²åœ¨ä¾èµ–æ ‘ä¸­ï¼‰ã€‚é¢„ä¼°å¢é‡ **< 100 KB**ã€‚

---

## F2: AI è°ƒç”¨ Rust åç«¯ä¸­è½¬ï¼ˆæµå¼ï¼‰

### ç°çŠ¶

```
WebView (JS) â†’ fetch() [å¸¦ API Key] â†’ https://api.openai.com/...
```

API Key æš´éœ²åœ¨ WebView JavaScript å†…å­˜å’Œ HTTP è¯·æ±‚å¤´ä¸­ã€‚

### æ–¹æ¡ˆ

æ‰€æœ‰ AI API è°ƒç”¨æ”¹ä¸º Rust åç«¯ä¸­è½¬ï¼ŒKey æ°¸ä¸è¿›å…¥ WebViewï¼š

```
å‰ç«¯ â†’ invoke("ai_request", { configId, messages })
           â†“
Rust â†’ Keychain å– Key â†’ reqwest è¯·æ±‚ AI API
           â†“
     Tauri Event é€ chunk æ¨é€ç»™å‰ç«¯
```

### æŠ€æœ¯è§„æ ¼

#### æ–°å¢ Rust commandsï¼ˆ`src-tauri/src/commands/ai_proxy.rs`ï¼‰

**éæµå¼è¯·æ±‚**ï¼ˆè¿é€šæ€§æµ‹è¯•ï¼‰ï¼š
```rust
#[tauri::command]
pub async fn ai_test_connection(
    config_id: String,
    // å‰ç«¯ä¼ é€’ provider / baseUrl / model ç­‰éæ•æ„Ÿå­—æ®µ
    // Key ç”± Rust ä» Keychain è·å–
) -> Result<bool, String>;
```

**æµå¼è¯·æ±‚**ï¼ˆèŠå¤© + å›¾ç‰‡ç”Ÿæˆï¼‰ï¼š
```rust
#[tauri::command]
pub async fn ai_chat_stream(
    app: AppHandle,
    window: Window,
    request_id: String,  // å‰ç«¯ç”Ÿæˆçš„è¯·æ±‚æ ‡è¯†
    config_id: String,
    messages: Vec<ChatMessage>,
    // ...å…¶ä»–éæ•æ„Ÿå‚æ•°
) -> Result<(), String> {
    // 1. ä» Keychain è·å– Key
    // 2. æ ¹æ® provider æ„å»ºè¯·æ±‚ (reqwest)
    // 3. æµå¼è¯»å–å“åº”ï¼Œé€ chunk å‘é€ Tauri Event
    //    window.emit("ai:stream:{request_id}", chunk)?;
    // 4. å®Œæˆåå‘é€ "ai:stream-end:{request_id}"
}
```

**å›¾ç‰‡ç”Ÿæˆ**ï¼š
```rust
#[tauri::command]
pub async fn ai_generate_image(
    config_id: String,
    prompt: String,
    size: Option<String>,
) -> Result<ImageGenerationResult, String>;
```

#### å‰ç«¯ä¾§æ”¹é€ 

**`providers.ts` é‡æ„**ï¼š
- ç§»é™¤æ‰€æœ‰ `fetch()` è°ƒç”¨å’Œ `Authorization` header æ„å»º
- `sendChatStream()` æ”¹ä¸º `invoke("ai_chat_stream")` + `listen("ai:stream:{id}")`
- `testAIConnection()` æ”¹ä¸º `invoke("ai_test_connection")`

**`image-service.ts` é‡æ„**ï¼š
- `generateImage()` æ”¹ä¸º `invoke("ai_generate_image")`
- `testImageConnection()` æ”¹ä¸º `invoke("ai_test_image_connection")`

#### éœ€è¦æ”¯æŒçš„ Provider åè®®

| Provider | åè®®å·®å¼‚ | Rust ä¾§å¤„ç† |
|----------|---------|-------------|
| Claude | `x-api-key` header, `messages` API, SSE `event: content_block_delta` | ä¸“ç”¨ handler |
| OpenAI / DeepSeek / Custom | `Authorization: Bearer` header, SSE `data: {...}` | é€šç”¨ OpenAI-compatible handler |
| Gemini | `?key=` query param, `generateContent` API | ä¸“ç”¨ handler |
| Ollama | æ—  Keyï¼Œ`localhost:11434`, NDJSON stream | ä¸“ç”¨ handler |
| DashScope (é˜¿é‡Œäº‘) | `Authorization: Bearer`, éæ ‡å‡† `/services/.../text-generation/generation` | DashScope adapter |

#### é¢„ä¼°åŒ…å¤§å°å½±å“

**0 KB** â€” `reqwest` (v0.12 + stream feature) å’Œ `tokio` å·²åœ¨ä¾èµ–ä¸­ã€‚ä»…æ–°å¢ Rust æºç ã€‚

---

## F3: CSP æ”¶ç´§ + Tauri Capabilities ç²¾ç®€

### ç°çŠ¶

- `tauri.conf.json`: `"csp": null`ï¼ˆå®Œå…¨ç¦ç”¨ï¼‰
- `default.json`: `http://**`ã€`https://**`ï¼ˆå…è®¸è¿æ¥ä»»æ„åŸŸåï¼‰
- `fs:scope-home`ï¼ˆå…è®¸è®¿é—®æ•´ä¸ª Home ç›®å½•ï¼‰

### æ–¹æ¡ˆ

#### CSP é…ç½®ï¼ˆF2 å®Œæˆåç”Ÿæ•ˆï¼‰

```json
// src-tauri/tauri.conf.json
{
  "app": {
    "security": {
      "csp": "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' blob: data: https:; connect-src ipc: http://ipc.localhost; font-src 'self' data:"
    }
  }
}
```

å…³é”®ç‚¹ï¼š
- `script-src 'self'` â€” ç¦æ­¢å†…è”è„šæœ¬æ³¨å…¥
- `connect-src ipc: http://ipc.localhost` â€” å‰ç«¯ä»…å…è®¸ Tauri IPC é€šä¿¡ï¼Œä¸å…è®¸ç›´è¿å¤–éƒ¨ API
- `img-src` ä¿ç•™ `https:` â€” ç¼–è¾‘å™¨éœ€è¦æ˜¾ç¤ºè¿œç¨‹å›¾ç‰‡
- `style-src 'unsafe-inline'` â€” Svelte ç»„ä»¶éœ€è¦å†…è”æ ·å¼

#### Tauri Capabilities ç²¾ç®€

```json
// src-tauri/capabilities/default.json
{
  "permissions": [
    // ... ä¿ç•™ core:default, core:tray, core:window æƒé™ä¸å˜ ...

    // fs: ç§»é™¤ scope-homeï¼Œæ”¹ä¸ºæ›´ç²¾ç¡®çš„èŒƒå›´
    "fs:default",
    "fs:allow-read-file",
    "fs:allow-write-file",
    "fs:allow-create",
    "fs:allow-write",
    "core:resources:allow-close",
    "fs:allow-exists",
    "fs:allow-read-dir",
    "fs:allow-mkdir",
    "fs:allow-rename",
    "fs:allow-remove",
    "fs:allow-stat",
    "fs:allow-watch",
    "fs:scope-desktop",
    "fs:scope-document",
    "fs:scope-download",
    // æ³¨æ„ï¼šç§»é™¤ "fs:scope-home"ï¼Œä»…ä¿ç•™ desktop/document/download

    "dialog:default",
    // ... dialog æƒé™ä¸å˜ ...

    "store:default",
    "opener:default",

    // http: ç§»é™¤å®½æ³›çš„ http://** https://**
    // F2 å®Œæˆåå‰ç«¯ä¸å†éœ€è¦ç›´è¿å¤–éƒ¨ API
    // ä»…ä¿ç•™ Ollama æœ¬åœ°è¿æ¥ï¼ˆå¦‚æœä»éœ€å‰ç«¯ç›´è¿çš„åœºæ™¯ï¼‰
    {
      "identifier": "http:default",
      "allow": [
        { "url": "http://localhost:*/**" },
        { "url": "http://127.0.0.1:*/**" }
      ]
    }
  ]
}
```

> **æ³¨æ„**ï¼š`fs:scope-home` ç§»é™¤åï¼Œç”¨æˆ·é€šè¿‡ File > Open å¯¹è¯æ¡†é€‰æ‹©çš„æ–‡ä»¶ä»ç„¶å¯ä»¥è®¿é—®ï¼ˆTauri dialog æ’ä»¶è‡ªåŠ¨æˆäºˆä¸´æ—¶ scopeï¼‰ã€‚Sidebar ç›®å½•æµè§ˆå—é™äº desktop/document/downloadã€‚å¦‚æœç”¨æˆ·éœ€è¦è®¿é—®å…¶ä»–ç›®å½•ï¼Œé€šè¿‡ dialog é€‰æ‹©å³å¯ã€‚

---

## F4: MCP å…¨é¢å®‰å…¨åŠ å›º

### ç°çŠ¶

MCP æ¨¡å—å­˜åœ¨å¤šä¸ªå®‰å…¨é—®é¢˜ï¼š
1. **å¯åŠ¨æ— ç¡®è®¤**ï¼šç”¨æˆ·ç‚¹å‡»è¿æ¥ stdio MCP server ç›´æ¥æ‰§è¡Œ `Command::new(&command)`ï¼Œæ— å®‰å…¨æç¤º
2. **å‘½ä»¤æ³¨å…¥**ï¼š`check_command_exists` æ¥å—ä»»æ„å­—ç¬¦ä¸²ä½œä¸ºå‘½ä»¤æ‰§è¡Œï¼ˆ`mcp.rs:176-192`ï¼‰
3. **åƒµå°¸è¿›ç¨‹**ï¼š`kill()` å­è¿›ç¨‹åæœªè°ƒç”¨ `wait()`ï¼Œå¯¼è‡´åƒµå°¸è¿›ç¨‹ï¼ˆ`mcp.rs:145-175`ï¼‰
4. **ç¼“å†²åŒºæ— é™åˆ¶**ï¼š`mcp_send_request` è¡Œè¯»å–æ— é•¿åº¦ä¸Šé™ï¼Œæ¶æ„ server å¯æ¶ˆè€—å†…å­˜ï¼ˆ`mcp.rs:101-135`ï¼‰
5. **ç¯å¢ƒå˜é‡æ³¨å…¥**ï¼šå­è¿›ç¨‹ç»§æ‰¿çˆ¶è¿›ç¨‹æ‰€æœ‰ç¯å¢ƒå˜é‡ï¼Œå¯è¢«åˆ©ç”¨æ³¨å…¥ `LD_PRELOAD` ç­‰ï¼ˆ`mcp.rs:36-79`ï¼‰
6. **åŠ¨æ€æœåŠ¡æ— æ²™ç›’**ï¼šAI ç”Ÿæˆçš„ `handlers.js` ç» `require()` ç›´æ¥æ‰§è¡Œï¼Œæ— ä»»ä½•é™åˆ¶ï¼ˆ`mcp-runtime.ts:31`ï¼‰

### æ–¹æ¡ˆ

#### 4.1 å¯åŠ¨å®‰å…¨ç¡®è®¤ï¼ˆå‰ç«¯ï¼‰

åœ¨ç”¨æˆ·ç‚¹å‡»"è¿æ¥"å¯åŠ¨ stdio ç±»å‹ MCP server æ—¶ï¼Œå¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†ï¼š

```
âš ï¸ å®‰å…¨æç¤º

å³å°†å¯åŠ¨å¤–éƒ¨ç¨‹åºï¼š
  å‘½ä»¤: npx -y @anthropic/mcp-server-github
  å‚æ•°: --token ghp_xxx...

MCP Server å°†ä»¥å½“å‰ç”¨æˆ·æƒé™è¿è¡Œï¼Œå¯ä»¥è®¿é—®æœ¬åœ°æ–‡ä»¶å’Œç½‘ç»œã€‚
è¯·ç¡®è®¤æ­¤ MCP Server æ¥è‡ªå¯ä¿¡æ¥æºã€‚

[å–æ¶ˆ]  [ç¡®è®¤å¯åŠ¨]
```

**å®ç°è¦ç‚¹**ï¼š
- ä»… `stdio` ç±»å‹çš„ MCP server éœ€è¦ç¡®è®¤ï¼ˆSSE/HTTP æ˜¯ç½‘ç»œè¿æ¥ï¼Œé£é™©è¾ƒä½ï¼‰
- ä½¿ç”¨ Tauri `dialog:ask` åŸç”Ÿç¡®è®¤æ¡†ï¼ˆé HTML å¼¹çª—ï¼Œé¿å…è¢« JS ç»•è¿‡ï¼‰
- é…ç½®å¯¼å…¥/åŒæ­¥æ—¶ä¹Ÿæ˜¾ç¤ºå®‰å…¨è­¦å‘Š
- å¯æ·»åŠ "ä¿¡ä»»æ­¤ serverï¼Œä¸å†æç¤º"é€‰é¡¹ï¼ˆå­˜å‚¨åˆ° Tauri Storeï¼‰

#### 4.2 å‘½ä»¤å‚æ•°æ ¡éªŒï¼ˆRustï¼‰

`check_command_exists` å’Œ `mcp_connect_stdio` ä¸­å¯¹ `command` å‚æ•°è¿›è¡Œæ ¡éªŒï¼š

```rust
fn validate_command(command: &str) -> Result<(), String> {
    // ä»…å…è®¸ç®€å•çš„å¯æ‰§è¡Œæ–‡ä»¶åï¼ˆå­—æ¯ã€æ•°å­—ã€è¿å­—ç¬¦ã€ä¸‹åˆ’çº¿ã€ç‚¹ï¼‰
    let re = regex::Regex::new(r"^[a-zA-Z0-9._-]+$").unwrap();
    if !re.is_match(command) {
        return Err("Invalid command: must be a simple executable name".to_string());
    }
    // æ‹’ç» shell å…ƒå­—ç¬¦
    if command.contains(|c: char| ";|&><$`\\(){}[]!#~".contains(c)) {
        return Err("Invalid command: shell metacharacters not allowed".to_string());
    }
    Ok(())
}
```

#### 4.3 åƒµå°¸è¿›ç¨‹ä¿®å¤ï¼ˆRustï¼‰

`mcp_disconnect` ä¸­ `kill()` åå¿…é¡»è°ƒç”¨ `wait()`ï¼š

```rust
// ä¿®æ”¹ mcp_disconnect ä¸­çš„è¿›ç¨‹æ¸…ç†é€»è¾‘
if let Some(mut child) = process_entry.process {
    let _ = child.kill();
    let _ = child.wait();  // å›æ”¶å­è¿›ç¨‹ï¼Œé˜²æ­¢åƒµå°¸
}
```

#### 4.4 å“åº”ç¼“å†²åŒºé™åˆ¶ï¼ˆRustï¼‰

`mcp_send_request` ä¸­å¯¹è¡Œè¯»å–æ·»åŠ é™åˆ¶ï¼š

```rust
const MAX_LINE_LENGTH: usize = 64 * 1024;  // 64 KB
const MAX_ITERATIONS: usize = 1000;

let mut line = String::new();
let mut iterations = 0;
loop {
    line.clear();
    iterations += 1;
    if iterations > MAX_ITERATIONS {
        return Err("MCP response exceeded iteration limit".to_string());
    }
    let bytes_read = reader.read_line(&mut line)
        .map_err(|e| format!("Read error: {}", e))?;
    if bytes_read == 0 { break; }
    if line.len() > MAX_LINE_LENGTH {
        return Err("MCP response line exceeded size limit".to_string());
    }
    // ... å¤„ç†é€»è¾‘ ...
}
```

#### 4.5 ç¯å¢ƒå˜é‡è¿‡æ»¤ï¼ˆRustï¼‰

`mcp_connect_stdio` ä¸­è¿‡æ»¤å±é™©ç¯å¢ƒå˜é‡ï¼š

```rust
const BLOCKED_ENV_VARS: &[&str] = &[
    "LD_PRELOAD", "LD_LIBRARY_PATH",
    "DYLD_INSERT_LIBRARIES", "DYLD_LIBRARY_PATH", "DYLD_FRAMEWORK_PATH",
];

let mut command = Command::new(&validated_command);
// ä¸ç»§æ‰¿å…¨éƒ¨ç¯å¢ƒå˜é‡ï¼Œåªä¼ é€’å®‰å…¨å˜é‡ + ç”¨æˆ·é…ç½®çš„ env
command.env_clear();
for (key, value) in std::env::vars() {
    if !BLOCKED_ENV_VARS.iter().any(|blocked| key.starts_with(blocked)) {
        command.env(&key, &value);
    }
}
// æ·»åŠ ç”¨æˆ·é…ç½®çš„ç¯å¢ƒå˜é‡
for (key, value) in &env_vars {
    if !BLOCKED_ENV_VARS.iter().any(|blocked| key.starts_with(blocked)) {
        command.env(key, value);
    }
}
```

#### 4.6 åŠ¨æ€ MCP æœåŠ¡å®‰å…¨ç¡®è®¤ï¼ˆå‰ç«¯ï¼‰

AI åˆ›å»ºåŠ¨æ€ MCP æœåŠ¡æ—¶ï¼Œæ‰§è¡Œ `handlers.js` å‰æ˜¾ç¤ºç¡®è®¤ï¼š

```
âš ï¸ AI æœåŠ¡å®‰å…¨æç¤º

AI å·²ç”Ÿæˆä¸€ä¸ª MCP æœåŠ¡ï¼Œéœ€è¦æ‰§è¡Œè‡ªåŠ¨ç”Ÿæˆçš„ä»£ç ï¼š
  æœåŠ¡å: weather-service
  å·¥å…·: get_weather, get_forecast

æ­¤ä»£ç å°†åœ¨æœ¬åœ° Node.js è¿›ç¨‹ä¸­è¿è¡Œã€‚
è¯·ç¡®è®¤æ˜¯å¦ä¿¡ä»»æ­¤ AI ç”Ÿæˆçš„æœåŠ¡ä»£ç ã€‚

[æŸ¥çœ‹ä»£ç ]  [å–æ¶ˆ]  [ç¡®è®¤è¿è¡Œ]
```

ä¿®æ”¹ `container-manager.ts`ï¼Œåœ¨ `connectServer` å‰å¢åŠ ç”¨æˆ·ç¡®è®¤æ­¥éª¤ã€‚

---

## F5: æ–‡ä»¶è·¯å¾„æ ¡éªŒåŠ å›º

### ç°çŠ¶

`src-tauri/src/commands/file.rs` ä¸­çš„ `read_file`ã€`write_file`ã€`write_file_binary` ç›´æ¥ä½¿ç”¨ `std::fs` æ“ä½œç”¨æˆ·ä¼ å…¥çš„è·¯å¾„ï¼Œæ— è·¯å¾„éå†ä¿æŠ¤ã€‚è™½ç„¶ Tauri capabilities é™åˆ¶äº† fs æ’ä»¶è°ƒç”¨èŒƒå›´ï¼Œä½†è‡ªå®šä¹‰ command ç»•è¿‡äº†è¯¥æœºåˆ¶ã€‚

### æ–¹æ¡ˆ

åœ¨ Rust ä¾§ `file.rs` ä¸­æ·»åŠ è·¯å¾„æ ¡éªŒå‡½æ•°ï¼š

```rust
use std::path::{Path, PathBuf};

/// æ ¡éªŒè·¯å¾„å®‰å…¨æ€§ï¼š
/// 1. è§„èŒƒåŒ–è·¯å¾„ï¼ˆè§£æ .. å’Œç¬¦å·é“¾æ¥ï¼‰
/// 2. ç¡®ä¿æœ€ç»ˆè·¯å¾„åœ¨å…è®¸çš„ç›®å½•èŒƒå›´å†…
fn validate_path(path: &str) -> Result<PathBuf, String> {
    let canonical = std::fs::canonicalize(path)
        .or_else(|_| {
            // æ–‡ä»¶å¯èƒ½ä¸å­˜åœ¨ï¼ˆå†™å…¥åœºæ™¯ï¼‰ï¼Œæ ¡éªŒçˆ¶ç›®å½•
            let parent = Path::new(path).parent()
                .ok_or("Invalid path")?;
            let canonical_parent = std::fs::canonicalize(parent)
                .map_err(|e| format!("Invalid path: {}", e))?;
            Ok(canonical_parent.join(Path::new(path).file_name().unwrap_or_default()))
        })
        .map_err(|e: String| e)?;

    // å…è®¸çš„ç›®å½•ï¼šHome åŠå…¶å­ç›®å½•
    let home = dirs::home_dir()
        .ok_or("Cannot determine home directory")?;

    if !canonical.starts_with(&home) {
        return Err(format!("Access denied: path outside home directory"));
    }

    Ok(canonical)
}
```

åœ¨æ¯ä¸ªæ–‡ä»¶æ“ä½œ command å…¥å£è°ƒç”¨ `validate_path()`ï¼š

```rust
#[tauri::command]
pub fn read_file(path: String) -> Result<String, String> {
    let safe_path = validate_path(&path)?;
    fs::read_to_string(&safe_path).map_err(|e| format!("Failed to read file: {}", e))
}
```

**æ–°å¢ä¾èµ–**ï¼š
```toml
dirs = "5"  # è·å– Home ç›®å½•è·¯å¾„ï¼ˆè·¨å¹³å°ï¼‰
```

---

## F6: å®‰å…¨è§„èŒƒæ–‡æ¡£ï¼ˆé¢å‘åç»­è¿­ä»£ï¼‰ âœ… å·²å®Œæˆ

å·²å°†å®‰å…¨ç¼–ç è§„èŒƒå†™å…¥ `.claude/CLAUDE.md` çš„ `## Security Coding Standards` ç« èŠ‚ï¼Œæ¶µç›– 10 ä¸ªå­ç±»åˆ«ï¼š

1. Credentials & Secrets â€” Keychain å­˜å–è§„èŒƒ
2. Network Requests & API Calls â€” åç«¯ä¸­è½¬è§„èŒƒ
3. File System Operations â€” è·¯å¾„æ ¡éªŒè§„èŒƒ
4. Process Execution & MCP â€” å¯åŠ¨ç¡®è®¤ã€å‘½ä»¤æ ¡éªŒã€åƒµå°¸è¿›ç¨‹ã€ç¼“å†²åŒºé™åˆ¶ã€ç¯å¢ƒå˜é‡è¿‡æ»¤
5. HTML & XSS Prevention â€” innerHTML / {@html} / URL åè®®æ ¡éªŒ
6. Error Handling & Information Disclosure â€” é”™è¯¯ä¿¡æ¯è„±æ•
7. Unsafe Code (Rust) â€” SAFETY æ³¨é‡Šã€NULL æ£€æŸ¥ã€CString å¤„ç†
8. Tauri Configuration â€” CSP / HTTP scope / devtools
9. Dependencies & Supply Chain â€” ç‰ˆæœ¬å›ºå®šã€å®¡è®¡ã€Actions SHA å›ºå®š
10. Randomness & IDs â€” crypto.randomUUID vs Math.random é€‚ç”¨åœºæ™¯

---

## F7: Export HTML æ³¨å…¥é˜²æŠ¤

### ç°çŠ¶

`export-service.ts` ä¸­ä½¿ç”¨ `innerHTML = doc.body.innerHTML` å°† Markdown è½¬æ¢ä¸º HTML å¯¼å‡ºã€‚å¦‚æœ Markdown ä¸­åŒ…å«æ¶æ„ HTML ç‰‡æ®µï¼ˆå¦‚ `<script>` æˆ– `<img onerror=...>`ï¼‰ï¼Œå°†è¢«åŸæ ·ä¿ç•™åœ¨å¯¼å‡ºæ–‡ä»¶ä¸­ã€‚

### æ–¹æ¡ˆ

**ä¿®æ”¹ `export-service.ts`**ï¼š

```typescript
// æ·»åŠ  HTML è½¬ä¹‰å·¥å…·å‡½æ•°
function escapeHtml(str: string): string {
  return str
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

// URL åè®®ç™½åå•æ ¡éªŒ
function isValidImageSrc(src: string): boolean {
  const protocol = src.trim().toLowerCase();
  return protocol.startsWith('http://') ||
         protocol.startsWith('https://') ||
         protocol.startsWith('data:image/') ||
         protocol.startsWith('/') ||
         protocol.startsWith('./');
}
```

**å¤„ç†æ–¹å¼**ï¼š
- Markdown â†’ HTML è½¬æ¢åï¼Œå¯¹è¾“å‡º DOM è¿›è¡Œéå†æ¸…ç†
- ç§»é™¤ `<script>` æ ‡ç­¾
- ç§»é™¤äº‹ä»¶å±æ€§ï¼ˆ`onerror`, `onload`, `onclick` ç­‰ï¼‰
- æ ¡éªŒ `<img>` å’Œ `<a>` çš„ `src`/`href` åè®®ï¼ˆæ‹’ç» `javascript:`, `vbscript:`, `data:text/html`ï¼‰

---

## F8: é”™è¯¯ä¿¡æ¯è„±æ•

### ç°çŠ¶

Rust commands çš„é”™è¯¯ä¿¡æ¯ç›´æ¥å°† `std::io::Error` è½¬ä¸ºå­—ç¬¦ä¸²è¿”å›å‰ç«¯ï¼ŒåŒ…å«å®Œæ•´çš„æ–‡ä»¶ç³»ç»Ÿè·¯å¾„å’Œ OS é”™è¯¯ç ï¼š

```rust
// å½“å‰: æ³„éœ²è·¯å¾„ä¿¡æ¯
fs::read_to_string(&path).map_err(|e| format!("Failed to read file: {}", e))
// è¾“å‡º: "Failed to read file: No such file or directory (os error 2): /Users/xxx/.config/moraya/..."
```

### æ–¹æ¡ˆ

**ä¿®æ”¹ `file.rs`** ä¸­æ‰€æœ‰ `.map_err()` è°ƒç”¨ï¼š

```rust
fn sanitize_io_error(e: std::io::Error) -> String {
    match e.kind() {
        std::io::ErrorKind::NotFound => "File not found".to_string(),
        std::io::ErrorKind::PermissionDenied => "Permission denied".to_string(),
        std::io::ErrorKind::AlreadyExists => "File already exists".to_string(),
        _ => "Operation failed".to_string(),
    }
}

#[tauri::command]
pub fn read_file(path: String) -> Result<String, String> {
    let safe_path = validate_path(&path)?;
    fs::read_to_string(&safe_path).map_err(sanitize_io_error)
}
```

**ä¿®æ”¹ `mcp.rs`**ï¼š
- MCP å­è¿›ç¨‹ stderr è¾“å‡ºæˆªæ–­åˆ° 200 å­—ç¬¦
- ç§»é™¤ stderr ä¸­çš„æ–‡ä»¶è·¯å¾„ä¿¡æ¯

---

## F9: Unsafe FFI å®‰å…¨åŠ å›ºï¼ˆdock.rsï¼‰

### ç°çŠ¶

`dock.rs` ä½¿ç”¨ `unsafe` å—è°ƒç”¨ macOS Objective-C APIï¼ˆ`msg_send!`ï¼‰è®¾ç½® Dock å›¾æ ‡è¡Œä¸ºï¼Œå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š
- `msg_send!` è¿”å›å€¼æœªåš NULL æ£€æŸ¥
- ç¼ºå°‘ `// SAFETY:` æ³¨é‡Š
- `CString` æ„å»ºä½¿ç”¨ `.unwrap()` å¯èƒ½ panic

### æ–¹æ¡ˆ

**ä¿®æ”¹ `dock.rs`**ï¼š

```rust
#[cfg(target_os = "macos")]
pub fn setup_dock(app: &tauri::App) -> Result<(), Box<dyn std::error::Error>> {
    use cocoa::appkit::NSApp;
    use cocoa::base::{id, nil};
    use objc::msg_send;

    unsafe {
        // SAFETY: NSApp is always non-null after application launch
        let app_instance: id = NSApp();
        if app_instance == nil {
            return Err("Failed to get NSApp instance".into());
        }

        // SAFETY: setActivationPolicy: is a valid NSApplication selector
        let _: () = msg_send![app_instance, setActivationPolicy: 0i64];

        // ... å…¶ä»– ObjC è°ƒç”¨åŒæ ·æ·»åŠ  NULL æ£€æŸ¥å’Œ SAFETY æ³¨é‡Š ...
    }
    Ok(())
}
```

**æ”¹åŠ¨è¦ç‚¹**ï¼š
- æ‰€æœ‰ `msg_send!` è¿”å› `id` ç±»å‹çš„è°ƒç”¨ï¼Œæ£€æŸ¥æ˜¯å¦ä¸º `nil`
- æ‰€æœ‰ `unsafe` å—æ·»åŠ  `// SAFETY:` æ³¨é‡Š
- `CString::new()` æ”¹ç”¨ `.map_err()` è¿”å› `Result` è€Œé `.unwrap()`
- å°†æ•´ä¸ªå‡½æ•°ç­¾åæ”¹ä¸ºè¿”å› `Result`ï¼Œç”± `lib.rs` å¤„ç†é”™è¯¯

---

## å®æ–½é¡ºåº

```
F1 (Keychain å­˜å‚¨) â†’ F2 (åç«¯ä¸­è½¬) â†’ F3 (CSP æ”¶ç´§) â†’ F4 (MCP å®‰å…¨åŠ å›º) / F5 (è·¯å¾„æ ¡éªŒ) â†’ F7 (Export é˜²æŠ¤) / F8 (é”™è¯¯è„±æ•) / F9 (FFI åŠ å›º)
```

**ä¾èµ–å…³ç³»**ï¼š
- F1 â†’ F2ï¼šåç«¯ä¸­è½¬éœ€è¦ä» Keychain å– Keyï¼Œæ‰€ä»¥ F1 å…ˆè¡Œ
- F2 â†’ F3ï¼šCSP æ”¶ç´§å‰ææ˜¯å‰ç«¯ä¸å†ç›´è¿å¤–éƒ¨ API
- F4ã€F5 ç›¸äº’ç‹¬ç«‹ï¼Œå¯å¹¶è¡Œ
- F7ã€F8ã€F9 ç›¸äº’ç‹¬ç«‹ï¼Œå¯å¹¶è¡Œ
- F6 âœ… å·²å®Œæˆ

---

## ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | æ”¹åŠ¨ç±»å‹ | å…³è”åŠŸèƒ½ |
|------|---------|---------|
| `src-tauri/Cargo.toml` | ä¿®æ”¹ | F1 (keyring), F5 (dirs) |
| `src-tauri/src/commands/mod.rs` | ä¿®æ”¹ | F1, F2 â€” æ³¨å†Œæ–°æ¨¡å— |
| `src-tauri/src/commands/keychain.rs` | **æ–°å»º** | F1 â€” Keychain CRUD |
| `src-tauri/src/commands/ai_proxy.rs` | **æ–°å»º** | F2 â€” AI è¯·æ±‚ä¸­è½¬ + æµå¼æ¨é€ |
| `src-tauri/src/commands/file.rs` | ä¿®æ”¹ | F5 â€” è·¯å¾„æ ¡éªŒ; F8 â€” é”™è¯¯è„±æ• |
| `src-tauri/src/commands/mcp.rs` | ä¿®æ”¹ | F4 â€” å‘½ä»¤æ ¡éªŒã€åƒµå°¸è¿›ç¨‹ã€ç¼“å†²åŒºã€ç¯å¢ƒå˜é‡; F8 â€” é”™è¯¯è„±æ• |
| `src-tauri/src/lib.rs` | ä¿®æ”¹ | F1, F2 â€” æ³¨å†Œæ–° commands; F9 â€” é”™è¯¯å¤„ç† |
| `src-tauri/src/dock.rs` | ä¿®æ”¹ | F9 â€” NULL æ£€æŸ¥ã€SAFETY æ³¨é‡Šã€Result è¿”å› |
| `src-tauri/tauri.conf.json` | ä¿®æ”¹ | F3 â€” CSP é…ç½® |
| `src-tauri/capabilities/default.json` | ä¿®æ”¹ | F3 â€” æƒé™ç²¾ç®€ |
| `src/lib/services/ai/providers.ts` | ä¿®æ”¹ | F2 â€” ç§»é™¤ fetchï¼Œæ”¹ç”¨ invoke |
| `src/lib/services/ai/ai-service.ts` | ä¿®æ”¹ | F1 â€” Key å­˜å–æ”¹ä¸º IPC; F2 â€” æµå¼æ¥æ”¶æ”¹ä¸º Event |
| `src/lib/services/ai/image-service.ts` | ä¿®æ”¹ | F2 â€” å›¾ç‰‡ç”Ÿæˆæ”¹ä¸º invoke |
| `src/lib/services/export-service.ts` | ä¿®æ”¹ | F7 â€” HTML æ¸…ç† + URL åè®®æ ¡éªŒ |
| `src/lib/services/mcp/container-manager.ts` | ä¿®æ”¹ | F4 â€” åŠ¨æ€æœåŠ¡å¯åŠ¨ç¡®è®¤ |
| `src/lib/components/ai/AISettings.svelte` | ä¿®æ”¹ | F1 â€” Key ä¿å­˜/è¯»å–; F2 â€” è¿é€šæ€§æµ‹è¯• |
| `src/lib/components/ai/MCPPanel.svelte` | ä¿®æ”¹ | F4 â€” å¯åŠ¨ç¡®è®¤å¼¹çª— |
| `.claude/CLAUDE.md` | âœ… å·²ä¿®æ”¹ | F6 â€” å®‰å…¨è§„èŒƒï¼ˆå·²å®Œæˆï¼‰ |
| `src/lib/i18n/locales/en.json` | ä¿®æ”¹ | F4 â€” å®‰å…¨æç¤ºæ–‡æ¡ˆ; F7 â€” å¯¼å‡ºæç¤º |
| `src/lib/i18n/locales/zh-CN.json` | ä¿®æ”¹ | F4 â€” å®‰å…¨æç¤ºæ–‡æ¡ˆ; F7 â€” å¯¼å‡ºæç¤º |

---

## éªŒè¯æ–¹æ¡ˆ

### F1 éªŒè¯
1. `cargo check` ç¼–è¯‘é€šè¿‡
2. é…ç½® AI Provider å¹¶ä¿å­˜ â†’ æ£€æŸ¥ `ai-config.json` ä¸­ `apiKey` ä¸º `"***"`
3. macOS: Keychain Access ä¸­å¯è§ `com.moraya.app` æ¡ç›®
4. é‡å¯åº”ç”¨å AI é…ç½®æ­£å¸¸åŠ è½½ï¼ŒKey æ­£ç¡®æ¢å¤
5. æ—§ç‰ˆå‡çº§ï¼šæ˜æ–‡ Key è‡ªåŠ¨è¿ç§»åˆ° Keychain

### F2 éªŒè¯
1. AI èŠå¤©åŠŸèƒ½æ­£å¸¸ï¼Œæµå¼è¾“å‡ºæ— å»¶è¿Ÿæ„Ÿ
2. å›¾ç‰‡ç”ŸæˆåŠŸèƒ½æ­£å¸¸
3. æ‰€æœ‰ 6 ç§ Provider å‡å¯æ­£å¸¸å·¥ä½œï¼ˆClaude, OpenAI, Gemini, DeepSeek, Ollama, Customï¼‰
4. è¿é€šæ€§æµ‹è¯•ï¼ˆTest Connectionï¼‰æ­£å¸¸
5. è‡ªå®šä¹‰ API endpoint æ­£å¸¸å·¥ä½œ
6. å‰ç«¯ä»£ç ä¸­ä¸å†æœ‰ `Authorization` / `x-api-key` / `Bearer` å­—ç¬¦ä¸²
7. æµè§ˆå™¨ DevTools Network é¢æ¿ä¸­æ— å¤–éƒ¨ API è¯·æ±‚ï¼ˆä»… IPCï¼‰

### F3 éªŒè¯
1. åº”ç”¨æ­£å¸¸å¯åŠ¨å’Œä½¿ç”¨
2. ç¼–è¾‘å™¨ä¸­è¿œç¨‹å›¾ç‰‡æ­£å¸¸æ˜¾ç¤ºï¼ˆ`img-src https:`ï¼‰
3. DevTools Console ä¸­æ³¨å…¥ `fetch("https://evil.com")` â†’ è¢« CSP æ‹¦æˆª
4. Sidebar å¯æµè§ˆ Desktop/Document/Download ç›®å½•
5. File > Open å¯¹è¯æ¡†å¯é€‰æ‹©ä»»æ„ç›®å½•çš„æ–‡ä»¶

### F4 éªŒè¯
1. æ·»åŠ  stdio MCP server å¹¶ç‚¹å‡»è¿æ¥ â†’ å¼¹å‡ºç¡®è®¤æ¡†
2. ç‚¹å‡»"å–æ¶ˆ" â†’ ä¸å¯åŠ¨è¿›ç¨‹
3. ç‚¹å‡»"ç¡®è®¤" â†’ æ­£å¸¸å¯åŠ¨
4. SSE/HTTP ç±»å‹ MCP server â†’ ä¸å¼¹ç¡®è®¤æ¡†
5. åŒ…å« shell å…ƒå­—ç¬¦çš„å‘½ä»¤ï¼ˆå¦‚ `; rm -rf /`ï¼‰â†’ è¢« `validate_command` æ‹’ç»
6. é•¿æ—¶é—´è¿è¡Œçš„ MCP server æ–­å¼€è¿æ¥å â†’ `ps aux` ç¡®è®¤æ— åƒµå°¸è¿›ç¨‹
7. åŠ¨æ€ MCP æœåŠ¡åˆ›å»º â†’ å¼¹å‡ºä»£ç ç¡®è®¤å¯¹è¯æ¡†ï¼Œå–æ¶ˆåˆ™ä¸æ‰§è¡Œ

### F5 éªŒè¯
1. æ­£å¸¸æ–‡ä»¶è¯»å†™ä¸å—å½±å“
2. å°è¯• `read_file("../../../etc/passwd")` â†’ è¿”å›é”™è¯¯
3. å°è¯•åŒ…å« `..` çš„è·¯å¾„ â†’ è¿”å›é”™è¯¯
4. Home ç›®å½•å†…çš„æ–‡ä»¶æ­£å¸¸è¯»å†™

### F7 éªŒè¯
1. æ­£å¸¸ Markdown å¯¼å‡º HTML â†’ å†…å®¹å®Œæ•´ï¼Œæ ¼å¼æ­£ç¡®
2. åŒ…å« `<script>alert(1)</script>` çš„ Markdown â†’ å¯¼å‡º HTML ä¸­æ—  `<script>` æ ‡ç­¾
3. åŒ…å« `<img onerror="alert(1)">` çš„ Markdown â†’ å¯¼å‡º HTML ä¸­æ—  `onerror` å±æ€§
4. åŒ…å« `[link](javascript:alert(1))` çš„ Markdown â†’ å¯¼å‡º HTML ä¸­é“¾æ¥è¢«æ¸…ç†

### F8 éªŒè¯
1. è¯»å–ä¸å­˜åœ¨çš„æ–‡ä»¶ â†’ é”™è¯¯ä¿¡æ¯ä¸º "File not found"ï¼Œä¸å«æ–‡ä»¶è·¯å¾„
2. æ— æƒé™æ“ä½œ â†’ é”™è¯¯ä¿¡æ¯ä¸º "Permission denied"ï¼Œä¸å« OS é”™è¯¯ç 
3. MCP server å¯åŠ¨å¤±è´¥ â†’ stderr ä¿¡æ¯è¢«æˆªæ–­ä¸”æ— è·¯å¾„æ³„éœ²

### F9 éªŒè¯
1. macOS æ„å»º `cargo check` é€šè¿‡
2. åº”ç”¨å¯åŠ¨å Dock å›¾æ ‡è¡Œä¸ºæ­£å¸¸ï¼ˆå•å®ä¾‹ï¼‰
3. é macOS æ„å»ºä¸å—å½±å“ï¼ˆ`#[cfg(target_os = "macos")]`ï¼‰
4. ä»£ç ä¸­æ‰€æœ‰ `unsafe` å—åŒ…å« `// SAFETY:` æ³¨é‡Š
