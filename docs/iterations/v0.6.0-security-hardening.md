# Moraya 安全架构升级 (v0.6.0)

> 迭代版本: v0.6.0
> 上一版本: v0.5.4
> 创建日期: 2026-02-10
> 状态: ✅ 已完成

---

## 版本概要

基于第三方安全评估 + 源码验证，对 Moraya 进行系统性安全架构升级。核心目标：**API Key 全链路保护**（存储加密 + 后端中转 + CSP 收紧），同时加固 MCP 启动安全和文件路径校验。

---

## 第一部分：安全评估报告

**评估对象**: [zouwei/moraya](https://github.com/zouwei/moraya) v0.3.3
**评估日期**: 2026-02-10
**评估范围**: 基于 GitHub 仓库公开信息 + 源码审计

### 一、项目概览

Moraya 是一个基于 Rust + Tauri v2 的 AI Markdown 编辑器，核心特性包括：

- 多 AI 供应商集成（Claude、OpenAI、Gemini、DeepSeek、Ollama）
- MCP 协议客户端（stdio / SSE / HTTP 三种传输方式）
- 本地文件 I/O 操作
- 多语言支持

### 二、🔴 高风险项

#### 2.1 API Key 存储安全 — 高风险

项目支持 6 种 AI 供应商，其中 5 种需要用户输入 API Key。Key 以明文保存在 Tauri Store（JSON 文件）中，任何有文件读取权限的进程可直接获取。

**建议**：使用系统级安全存储（macOS Keychain / Windows Credential Manager / Linux Secret Service）。

#### 2.2 API Key 网络传输安全 — 中高风险

AI 请求从前端 WebView 直接发起到各 AI 供应商 API，API Key 暴露在 WebView JavaScript 内存和 HTTP 请求头中。

**更安全的架构**：API 调用应通过 Rust 后端中转，Key 仅存在于 Rust 进程内存中。

#### 2.3 应用未代码签名 — 高风险

用户需要执行 `xattr -cr` 绕过 Gatekeeper，存在供应链攻击和社会工程风险。

**建议**：获取 Apple Developer ID 进行代码签名和公证。

### 三、🟡 中风险项

#### 3.1 MCP 协议 — stdio 传输安全

MCP stdio 传输会启动子进程，如果用户可配置任意可执行文件路径，等同于远程代码执行。子进程继承父进程权限和环境变量。

#### 3.2 Tauri 权限范围 — 需审查

`capabilities/default.json` 中 `fs:scope-home` 允许访问整个 Home 目录，`http://**` `https://**` 允许连接任意域名。

#### 3.3 CSP (Content Security Policy) 配置

`tauri.conf.json` 中 `"csp": null` 完全禁用 CSP，任何 XSS 漏洞都可导致 Key 外泄。

#### 3.4 文件 I/O 安全

`read_file`、`write_file`、`read_dir_recursive` 无路径遍历保护。

### 四、🟢 低风险项

- **依赖安全**：需定期运行 `pnpm audit` 和 `cargo audit`
- **AI 生成代码质量**：AI 贡献的代码需人工审查安全关键部分
- **GitHub Actions CI/CD**：需确认 CI 流程中不泄露 secrets

### 五、综合评估矩阵

| # | 风险项 | 严重度 | 可能性 | 确认状态 |
|---|--------|--------|--------|---------|
| 1 | API Key 明文本地存储 | 🔴 高 | 🔴 高 | ✅ 已确认 |
| 2 | API Key 前端直接发送 | 🟡 中 | 🔴 高 | ✅ 已确认 |
| 3 | 应用未代码签名 | 🔴 高 | 🟡 中 | ✅ 已确认 |
| 4 | MCP stdio 任意进程执行 | 🔴 高 | 🟡 中 | ✅ 已确认 |
| 5 | Tauri 权限范围过大 | 🟡 中 | 🟡 中 | ✅ 已确认 |
| 6 | CSP 完全禁用 | 🟡 中 | 🟡 中 | ✅ 已确认 |
| 7 | 文件路径遍历 | 🟡 中 | 🟢 低 | ✅ 已确认 |
| 8 | 依赖链安全 | 🟡 中 | 🟡 中 | 待审计 |

---

## 第二部分：安全加固实施

### 风险清单（源码层面深度审计）

| # | 风险项 | 严重度 | 源码位置 | 本版本处理 |
|---|--------|--------|---------|-----------|
| 1 | API Key 明文存储（Tauri Store → `ai-config.json`） | 🔴 高 | `ai-service.ts` | ✅ F1 |
| 2 | API Key 前端直发（WebView `fetch()` 携带 Key） | 🔴 高 | `providers.ts` | ✅ F2 |
| 3 | CSP 完全禁用（`"csp": null`） | 🔴 高 | `tauri.conf.json` | ✅ F3 |
| 4 | MCP stdio 任意进程执行（无白名单/确认） | 🟡 中 | `mcp.rs` | ✅ F4 |
| 5 | 文件路径遍历（自定义 command 无校验） | 🟡 中 | `file.rs` | ✅ F5 |
| 6 | Tauri capabilities 过宽（`fs:scope-home` + `http://**`） | 🟡 中 | `default.json` | ✅ F3 |
| 7 | Export HTML 注入（`innerHTML` 赋值未转义） | 🟡 中 | `export-service.ts` | ✅ F7 |
| 8 | Rust 错误信息泄露文件系统路径 | 🟡 中 | `file.rs`, `mcp.rs` | ✅ F8 |
| 9 | MCP 动态服务：AI 生成 JS 经 `require()` 直接执行 | 🔴 严重 | `mcp-runtime.ts`, `container-manager.ts` | ✅ F4 |
| 10 | `check_command_exists` 接受任意命令参数执行 | 🔴 严重 | `mcp.rs` | ✅ F4 |
| 11 | MCP 子进程 `kill()` 后未 `wait()`，产生僵尸进程 | 🔴 高 | `mcp.rs` | ✅ F4 |
| 12 | `dock.rs` unsafe ObjC FFI 无 NULL 检查 | 🔴 高 | `dock.rs` | ✅ F9 |
| 13 | MCP 响应无缓冲区限制 | 🟡 中 | `mcp.rs` | ✅ F4 |
| 14 | MCP 环境变量未过滤（`LD_PRELOAD` 等可注入） | 🟡 中 | `mcp.rs` | ✅ F4 |

---

### 功能清单

| ID | 功能 | 类型 | 优先级 | 状态 |
|----|------|------|--------|------|
| F1 | API Key 系统 Keychain 安全存储 | 后端 | P0 | ✅ 已完成 |
| F2 | AI 调用 Rust 后端中转（流式） | 后端 + 前端 | P0 | ✅ 已完成 |
| F3 | CSP 收紧 + Tauri capabilities 精简 | 配置 | P0 | ✅ 已完成 |
| F4 | MCP 全面安全加固 | 后端 + 前端 | P1 | ✅ 已完成 |
| F5 | 文件路径校验加固 | 后端 | P1 | ✅ 已完成 |
| F6 | 安全规范文档（面向后续迭代） | 文档 | P2 | ✅ 已完成 |
| F7 | Export HTML 注入防护 | 前端 | P1 | ✅ 已完成 |
| F8 | 错误信息脱敏 | 后端 | P2 | ✅ 已完成 |
| F9 | Unsafe FFI 安全加固（dock.rs） | 后端 | P2 | ✅ 已完成 |

---

### F1: API Key 系统 Keychain 安全存储

**现状**: API Key 以明文保存在 `~/.config/moraya/ai-config.json`。

**方案**: 使用 Rust `keyring` crate 接入操作系统原生安全存储：

| 平台 | 底层存储 | 加密方式 |
|------|---------|---------|
| macOS | Keychain Services | AES-256 (硬件安全芯片) |
| Windows | Credential Manager | DPAPI |
| Linux | Secret Service (GNOME Keyring / KWallet) | 用户登录密钥链 |

**技术规格**:

- 新增 Rust crate: `keyring = { version = "3", features = ["apple-native", "windows-native", "linux-native"] }`
- 新增 `src-tauri/src/commands/keychain.rs`: `keychain_set`, `keychain_get`, `keychain_delete`
- Key 命名规则: `ai-key:{configId}`
- 前端保存时 `apiKey` 写入 Keychain，Tauri Store 中仅保存 `"***"` 占位符
- 首次启动自动迁移旧版明文 Key 到 Keychain
- Debug 模式使用本地文件（避免未签名二进制触发 macOS Keychain 弹窗）

---

### F2: AI 调用 Rust 后端中转（流式）

**现状**: WebView `fetch()` 直接携带 API Key 请求外部 AI API。

**方案**: 所有 AI API 调用改为 Rust 后端中转，Key 永不进入 WebView。

```
前端 → invoke("ai_proxy_stream", { configId, messages })
         ↓
Rust → Keychain 取 Key → reqwest 请求 AI API
         ↓
   Tauri Channel 逐 chunk 推送给前端
```

**技术规格**:

- 新增 `src-tauri/src/commands/ai_proxy.rs`:
  - `ai_proxy_fetch()` — 非流式请求（连通性测试）
  - `ai_proxy_stream()` — 流式请求（聊天 + 图片生成）
  - `ai_proxy_abort()` — 取消进行中的请求
- Auth 注入逻辑: Claude 用 `x-api-key`，Gemini 用 query param，其他用 `Bearer`
- SSE 解析: 处理 Claude `content_block_delta` 和 OpenAI-compatible 格式
- 前端 `providers.ts` 移除所有 `fetch()` 调用，改用 `invoke('ai_proxy_fetch')` / `invoke('ai_proxy_stream')`

---

### F3: CSP 收紧 + Tauri Capabilities 精简

**现状**: `"csp": null`，`http://**`，`fs:scope-home`。

**方案**:

CSP 配置:
```
script-src 'self'; connect-src ipc: http://ipc.localhost http://localhost:* http://127.0.0.1:*
```

关键点:
- `script-src 'self'` — 禁止内联脚本注入
- `connect-src ipc: http://ipc.localhost` — 前端仅允许 Tauri IPC 通信
- `img-src` 保留 `https:` — 编辑器需要显示远程图片

Capabilities 精简:
- 移除 `fs:scope-home`，仅保留 `fs:scope-desktop`, `fs:scope-document`, `fs:scope-download`
- 移除宽泛的 `http://**` `https://**`
- HTTP scope 限制为 `localhost` 和 `127.0.0.1`

---

### F4: MCP 全面安全加固

**现状**: 启动无确认、命令注入、僵尸进程、缓冲区无限制、环境变量注入、动态服务无沙盒。

**方案**:

1. **启动安全确认** — stdio MCP server 启动前弹出 Tauri 原生确认框
2. **命令参数校验** — `validate_command()` 仅允许简单可执行文件名，拒绝 shell 元字符 (`;|&><$`)
3. **僵尸进程修复** — `kill()` 后必须调用 `wait()` 回收子进程
4. **响应缓冲区限制** — `MAX_LINE_LENGTH: 64KB`, `MAX_READ_ITERATIONS: 1000`
5. **环境变量过滤** — 屏蔽 `LD_PRELOAD`, `LD_LIBRARY_PATH`, `DYLD_*` 等危险变量
6. **动态服务安全确认** — AI 生成的 MCP 服务代码执行前显示确认对话框

---

### F5: 文件路径校验加固

**现状**: 自定义 Rust command 直接使用 `std::fs` 操作用户传入的路径，无路径遍历保护。

**方案**:

在 `file.rs` 中添加 `validate_path()`:
1. 规范化路径（解析 `..` 和符号链接）
2. 对 Windows UNC 前缀 `\\?\` 做 `strip_unc_prefix()`
3. 确保路径在用户 Home 目录范围内
4. `read_dir_recursive` 跳过符号链接并限制递归深度

所有文件操作 command 入口调用 `validate_path()`。

---

### F6: 安全规范文档 ✅

已将安全编码规范写入 `.claude/CLAUDE.md` 的 `## Security Coding Standards` 章节，涵盖 10 个子类别：Credentials、Network Requests、File System、Process Execution、HTML/XSS、Error Handling、Unsafe Code、Tauri Configuration、Dependencies、Randomness。

---

### F7: Export HTML 注入防护

**现状**: `export-service.ts` 使用 `innerHTML` 输出未转义的 HTML。

**方案**:
- 添加 `sanitizeHtml()`: 使用 `DOMParser` 解析 → 移除 `<script>` / `<iframe>` / `<object>` 等 → 移除事件属性 → 校验 URL 协议（拒绝 `javascript:`, `vbscript:`, `data:text/html`）
- 添加 `escapeHtml()`: 对 `&<>"'` 进行转义

---

### F8: 错误信息脱敏

**现状**: Rust command 错误信息包含完整文件路径和 OS 错误码。

**方案**:
- `file.rs`: `sanitize_io_error()` 按 `ErrorKind` 返回通用消息（"File not found" / "Permission denied" / "Operation failed"）
- `mcp.rs`: stderr 截断到 200 字符，移除文件路径字符

---

### F9: Unsafe FFI 安全加固（dock.rs）

**现状**: `msg_send!` 返回值未做 NULL 检查，缺少 SAFETY 注释，`CString` 使用 `.unwrap()`。

**方案**:
- 所有 `msg_send!` 返回 `id` 类型的调用检查 `is_null()`
- 所有 `unsafe` 块添加 `// SAFETY:` 注释
- `CString::new()` 改用 `match` / `.map_err()` 返回 `Result`

---

## 实施顺序

```
F1 (Keychain) → F2 (后端中转) → F3 (CSP 收紧) → F4 (MCP 加固) / F5 (路径校验) → F7 (Export) / F8 (错误脱敏) / F9 (FFI)
```

---

## 修改文件清单

| 文件 | 改动类型 | 关联功能 |
|------|---------|---------|
| `src-tauri/Cargo.toml` | 修改 | F1 (keyring), F5 (dirs) |
| `src-tauri/src/commands/mod.rs` | 修改 | F1, F2 — 注册新模块 |
| `src-tauri/src/commands/keychain.rs` | **新建** | F1 — Keychain CRUD |
| `src-tauri/src/commands/ai_proxy.rs` | **新建** | F2 — AI 请求中转 + 流式推送 |
| `src-tauri/src/commands/file.rs` | 修改 | F5 — 路径校验; F8 — 错误脱敏 |
| `src-tauri/src/commands/mcp.rs` | 修改 | F4 — 命令校验、僵尸进程、缓冲区、环境变量; F8 — 错误脱敏 |
| `src-tauri/src/lib.rs` | 修改 | F1, F2 — 注册新 commands; F9 — 错误处理 |
| `src-tauri/src/dock.rs` | 修改 | F9 — NULL 检查、SAFETY 注释、Result 返回 |
| `src-tauri/tauri.conf.json` | 修改 | F3 — CSP 配置 |
| `src-tauri/capabilities/default.json` | 修改 | F3 — 权限精简 |
| `src/lib/services/ai/providers.ts` | 修改 | F2 — 移除 fetch，改用 invoke |
| `src/lib/services/ai/ai-service.ts` | 修改 | F1 — Key 存取改为 IPC; F2 — 流式接收 |
| `src/lib/services/export-service.ts` | 修改 | F7 — HTML 清理 + URL 协议校验 |
| `src/lib/services/mcp/container-manager.ts` | 修改 | F4 — 动态服务启动确认 |
| `src/lib/components/ai/MCPPanel.svelte` | 修改 | F4 — 启动确认弹窗 |
| `.claude/CLAUDE.md` | 修改 | F6 — 安全规范 |

---

## 验证方案

### F1 验证
1. 配置 AI Provider 并保存 → `ai-config.json` 中 `apiKey` 为 `"***"`
2. macOS: Keychain Access 中可见 `com.moraya.app` 条目
3. 重启应用后 AI 配置正常加载，Key 正确恢复
4. 旧版升级：明文 Key 自动迁移到 Keychain

### F2 验证
1. AI 聊天功能正常，流式输出无延迟感
2. 所有 6 种 Provider 均可正常工作
3. 前端代码中不再有 `Authorization` / `x-api-key` / `Bearer` 字符串
4. DevTools Network 面板中无外部 API 请求（仅 IPC）

### F3 验证
1. DevTools Console 注入 `fetch("https://evil.com")` → 被 CSP 拦截
2. Sidebar 可浏览 Desktop/Document/Download 目录
3. File > Open 对话框可选择任意目录的文件

### F4 验证
1. 添加 stdio MCP server 并点击连接 → 弹出确认框
2. 包含 shell 元字符的命令 → 被 `validate_command` 拒绝
3. 断开连接后 `ps aux` 确认无僵尸进程
4. 动态 MCP 服务创建 → 弹出代码确认对话框

### F5 验证
1. 正常文件读写不受影响
2. 包含 `..` 的路径 → 返回错误
3. Home 目录外路径 → 返回 "Access denied"

### F7 验证
1. 包含 `<script>` 的 Markdown 导出 HTML → 无 `<script>` 标签
2. 包含 `<img onerror="...">` → 无 `onerror` 属性
3. 包含 `javascript:` 链接 → 被清理

### F8 验证
1. 读取不存在文件 → "File not found"，不含路径
2. 无权限操作 → "Permission denied"，不含 OS 错误码

### F9 验证
1. macOS `cargo check` 通过
2. Dock 图标行为正常
3. 所有 `unsafe` 块包含 `// SAFETY:` 注释
