# v0.9.0 ä»£ç å—å¢å¼º

> è¿­ä»£ç‰ˆæœ¬: v0.9.0
> ä¸Šä¸€ç‰ˆæœ¬: v0.8.0
> åˆ›å»ºæ—¥æœŸ: 2026-02-13
> çŠ¶æ€: ğŸ“‹ è®¡åˆ’ä¸­

---

## ç‰ˆæœ¬æ¦‚è¦

å¢å¼ºä»£ç å—çš„äº¤äº’ä½“éªŒï¼šè¯­è¨€æ ‡ç­¾æ˜¾ç¤ºã€è¯­è¨€é€‰æ‹©å™¨ã€ä¸€é”®å¤åˆ¶æŒ‰é’®ã€‚åº•å±‚è¯­æ³•é«˜äº®å·²å®Œæ•´å®ç°ï¼ˆhighlight.js + 25 ç§è¯­è¨€ï¼‰ï¼Œæœ¬ç‰ˆæœ¬èšç„¦**UI å±‚å¢å¼º**ï¼Œé›¶æ–°å¢ä¾èµ–ã€‚

---

## éœ€æ±‚èƒŒæ™¯

### å½“å‰ç°çŠ¶

| èƒ½åŠ› | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| Markdown è¯­è¨€å£°æ˜è§£æ | âœ… | ` ```java ` â†’ `node.attrs.language = "java"` |
| è¯­è¨€å›å†™ Markdown | âœ… | åºåˆ—åŒ–è¾“å‡º ` ```java ... ``` ` |
| è¯­æ³•é«˜äº®ç€è‰² | âœ… | highlight.js + ProseMirror Decorationï¼Œ25+ è¯­è¨€ |
| æ˜/æš—ä¸»é¢˜è‰²æ¿ | âœ… | `--hljs-*` CSS å˜é‡ |
| **è¯­è¨€æ ‡ç­¾æ˜¾ç¤º** | âŒ | ä»£ç å—æ— è¯­è¨€åç§°æ ‡è¯† |
| **è¯­è¨€é€‰æ‹©å™¨** | âŒ | æ— æ³•é€šè¿‡ UI åˆ‡æ¢ä»£ç å—è¯­è¨€ |
| **å¤åˆ¶ä»£ç æŒ‰é’®** | âŒ | æ— ä¸€é”®å¤åˆ¶åŠŸèƒ½ |

### ç›®æ ‡

- ä»£ç å—å³ä¸Šè§’æ˜¾ç¤ºè¯­è¨€æ ‡ç­¾ + å¤åˆ¶æŒ‰é’®
- ç‚¹å‡»è¯­è¨€æ ‡ç­¾å¼¹å‡ºå¯æœç´¢çš„è¯­è¨€é€‰æ‹©å™¨
- æ“ä½œæµç•…ï¼Œä¸å¹²æ‰°ç¼–è¾‘ä½“éªŒ
- é›¶æ–°å¢ä¾èµ–ï¼Œé›¶åŒ…å¤§å°å¢é•¿

---

## åŠŸèƒ½è®¾è®¡

### F1: ä»£ç å—å·¥å…·æ ï¼ˆCodeBlockView NodeViewï¼‰

é€šè¿‡ ProseMirror è‡ªå®šä¹‰ NodeView æ›¿æ¢é»˜è®¤çš„ `<pre>` æ¸²æŸ“ï¼Œä¸ºæ¯ä¸ªä»£ç å—æ·»åŠ æµ®åŠ¨å·¥å…·æ ã€‚

#### UI è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ javascript                               ğŸ“‹ Copy â”‚  â† å·¥å…·æ ï¼ˆæ‚¬åœ/èšç„¦æ—¶æ˜¾ç¤ºï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ function hello() {                                â”‚
â”‚   console.log("Hello, World!");                   â”‚
â”‚ }                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### äº¤äº’è§„åˆ™

- å·¥å…·æ **æ‚¬åœ/èšç„¦æ—¶æ˜¾ç¤º**ï¼ˆhoverã€èŠ‚ç‚¹é€‰ä¸­ã€è¯­è¨€é€‰æ‹©å™¨æ‰“å¼€æ—¶å¯è§ï¼‰ï¼Œ0.15s æ¸æ˜¾è¿‡æ¸¡
- å·¥å…·æ é«˜åº¦çº¦ 28pxï¼ŒèƒŒæ™¯è‰² `var(--bg-secondary)` ç¨æ·±è‰²
- è¯­è¨€æ ‡ç­¾åœ¨å·¦ä¾§ï¼Œå¤åˆ¶æŒ‰é’®åœ¨å³ä¾§
- ä»£ç å—æ— è¯­è¨€å£°æ˜æ—¶ï¼Œè¯­è¨€æ ‡ç­¾æ˜¾ç¤ºä¸º "text"ï¼ˆç°è‰²ï¼‰

### F2: è¯­è¨€é€‰æ‹©å™¨

ç‚¹å‡»è¯­è¨€æ ‡ç­¾ï¼Œåœ¨å·¥å…·æ ä¸‹æ–¹å¼¹å‡ºè¯­è¨€é€‰æ‹©ä¸‹æ‹‰åˆ—è¡¨ã€‚

#### è¯­è¨€åˆ—è¡¨

åˆ†ä¸ºã€Œå¸¸ç”¨è¯­è¨€ã€å’Œã€Œå…¨éƒ¨è¯­è¨€ã€ä¸¤ç»„ï¼š

**å¸¸ç”¨è¯­è¨€**ï¼ˆç½®é¡¶æ˜¾ç¤ºï¼‰ï¼š
JavaScript, TypeScript, Python, Java, Go, Rust, C, C++, Ruby, PHP, Swift, Kotlin, SQL, Bash, JSON, YAML, HTML, CSS, Markdown

**å…¨éƒ¨è¯­è¨€**ï¼ˆæŒ‰å­—æ¯æ’åºï¼‰ï¼š
åŒ…å« highlight.js å·²æ³¨å†Œçš„å…¨éƒ¨ 25+ è¯­è¨€åŠåˆ«åã€‚

#### äº¤äº’è§„åˆ™

- é¡¶éƒ¨æœç´¢è¾“å…¥æ¡†ï¼Œå®æ—¶è¿‡æ»¤åŒ¹é…ï¼ˆåŒ¹é…è¯­è¨€åæˆ–åˆ«åï¼‰
- é€‰æ‹©åæ›´æ–° `code_block` èŠ‚ç‚¹çš„ `language` å±æ€§
- å±æ€§æ›´æ–°å highlight.js æ’ä»¶è‡ªåŠ¨é‡æ–°ç€è‰²
- æŒ‰ Escape æˆ–ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰
- ä¸‹æ‹‰åˆ—è¡¨æœ€å¤§é«˜åº¦ 240pxï¼Œè¶…å‡ºæ»šåŠ¨

### F3: å¤åˆ¶ä»£ç æŒ‰é’®

ç‚¹å‡» ğŸ“‹ å›¾æ ‡ï¼Œå°†ä»£ç å—å…¨éƒ¨æ–‡æœ¬å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚

#### äº¤äº’è§„åˆ™

- ç‚¹å‡»åå›¾æ ‡å˜ä¸º âœ“ï¼Œæ–‡å­—å˜ä¸º "Copied"
- 1.5 ç§’åè‡ªåŠ¨æ¢å¤ä¸º ğŸ“‹ å›¾æ ‡
- ä½¿ç”¨ `navigator.clipboard.writeText()` API
- å¤åˆ¶æ“ä½œä¸å½±å“ç¼–è¾‘å™¨ç„¦ç‚¹å’Œå…‰æ ‡ä½ç½®

---

## æŠ€æœ¯æ–¹æ¡ˆ

### æ¶æ„

```
src/lib/editor/plugins/
â”œâ”€â”€ highlight.ts              # å·²æœ‰ï¼šè¯­æ³•é«˜äº®è£…é¥°
â””â”€â”€ code-block-view.ts        # æ–°å¢ï¼šCodeBlock NodeView æ’ä»¶

src/lib/editor/setup.ts       # ä¿®æ”¹ï¼šæ³¨å†Œ CodeBlockView æ’ä»¶
src/lib/styles/editor.css     # ä¿®æ”¹ï¼šæ–°å¢ä»£ç å—å·¥å…·æ æ ·å¼
```

### å®ç°æ–¹å¼ï¼šMilkdown $view + NodeView

ä½¿ç”¨ Milkdown çš„ `$view` å·¥å…·åˆ›å»º ProseMirror NodeViewï¼š

```typescript
import { $view } from '@milkdown/utils';
import { codeBlockSchema } from '@milkdown/preset-commonmark';

export const codeBlockView = $view(codeBlockSchema.node, () => {
  return (node, view, getPos) => {
    // åˆ›å»º DOM ç»“æ„
    const wrapper = document.createElement('div');
    wrapper.className = 'code-block-wrapper';

    const toolbar = document.createElement('div');
    toolbar.className = 'code-block-toolbar';

    const langLabel = document.createElement('span');
    langLabel.className = 'code-lang-label';
    langLabel.textContent = node.attrs.language || 'text';

    const copyBtn = document.createElement('button');
    copyBtn.className = 'code-copy-btn';

    toolbar.append(langLabel, copyBtn);

    const pre = document.createElement('pre');
    const code = document.createElement('code');
    pre.append(code);

    wrapper.append(toolbar, pre);

    return {
      dom: wrapper,
      contentDOM: code,
      update(updatedNode) {
        if (updatedNode.type.name !== 'code_block') return false;
        langLabel.textContent = updatedNode.attrs.language || 'text';
        return true;
      },
    };
  };
});
```

### è¯­è¨€é€‰æ‹©å™¨å®ç°

è¯­è¨€é€‰æ‹©å™¨ä½¿ç”¨åŸç”Ÿ DOMï¼ˆé Svelte ç»„ä»¶ï¼‰ï¼Œå› ä¸º NodeView è¿è¡Œåœ¨ ProseMirror çš„ DOM ç®¡ç†ä¹‹ä¸‹ï¼š

```typescript
// ç‚¹å‡»è¯­è¨€æ ‡ç­¾ â†’ åˆ›å»ºä¸‹æ‹‰é¢æ¿
langLabel.addEventListener('click', (e) => {
  e.stopPropagation();
  showLanguagePicker(langLabel, node.attrs.language, (newLang) => {
    const pos = getPos();
    if (pos === undefined) return;
    view.dispatch(
      view.state.tr.setNodeMarkup(pos, undefined, {
        ...node.attrs,
        language: newLang,
      })
    );
  });
});
```

### ä¸ highlight.ts çš„ååŒ

- highlight.ts æ’ä»¶ï¼ˆProseMirror Decorationï¼‰åœ¨ `code_block` çš„ `<code>` å…ƒç´ å†…éƒ¨æ·»åŠ  inline decoration
- CodeBlockView çš„ `contentDOM` æŒ‡å‘ `<code>` å…ƒç´ 
- ä¸¤è€…äº’ä¸å¹²æ‰°ï¼šNodeView ç®¡ç†å¤–å±‚ DOMï¼ˆwrapper + toolbar + preï¼‰ï¼ŒDecoration ç®¡ç†å†…éƒ¨æ–‡æœ¬ç€è‰²

### Tier 1 æ’ä»¶é›†æˆ

CodeBlockView ä½œä¸º Tier 1 å¢å¼ºæ’ä»¶ï¼Œé€šè¿‡ `setup.ts` çš„ `preloadEnhancementPlugins()` åŠ¨æ€åŠ è½½ï¼š

```typescript
// setup.ts â€” Tier1Plugins æ¥å£æ–°å¢
interface Tier1Plugins {
  highlight?: MilkdownPlugin;
  codeBlockView?: MilkdownPlugin;  // æ–°å¢
  emoji?: MilkdownPlugin;
  math?: MilkdownPlugin;
  defList?: MilkdownPlugin[];
}
```

---

## æ ·å¼è®¾è®¡

### ä»£ç å—å·¥å…·æ 

```css
.code-block-wrapper {
  position: relative;
  margin: 1em 0;
  border-radius: 6px;
  overflow: hidden;
  background: var(--bg-secondary);
}

.code-block-toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.25rem 0.75rem;
  background: var(--bg-active);
  font-size: var(--font-size-xs);
  color: var(--text-secondary);
  user-select: none;
}

.code-lang-label {
  cursor: pointer;
  padding: 0.1rem 0.4rem;
  border-radius: 3px;
}

.code-lang-label:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}

.code-copy-btn {
  background: none;
  border: none;
  cursor: pointer;
  color: var(--text-muted);
  padding: 0.2rem 0.4rem;
  border-radius: 3px;
}

.code-copy-btn:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}
```

### è¯­è¨€é€‰æ‹©å™¨ä¸‹æ‹‰

```css
.code-lang-picker {
  position: absolute;
  top: 100%;
  left: 0;
  z-index: 50;
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  width: 200px;
  max-height: 240px;
  overflow-y: auto;
}

.code-lang-search {
  position: sticky;
  top: 0;
  padding: 0.4rem;
  border-bottom: 1px solid var(--border-light);
  background: var(--bg-primary);
}

.code-lang-option {
  padding: 0.3rem 0.6rem;
  cursor: pointer;
  font-size: var(--font-size-xs);
}

.code-lang-option:hover,
.code-lang-option.selected {
  background: var(--bg-hover);
  color: var(--accent-color);
}

.code-lang-group-label {
  padding: 0.3rem 0.6rem;
  font-size: var(--font-size-xs);
  color: var(--text-muted);
  font-weight: 600;
}
```

---

## ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| `src/lib/editor/plugins/code-block-view.ts` | æ–°å¢ | CodeBlock NodeView + è¯­è¨€é€‰æ‹©å™¨ + å¤åˆ¶æŒ‰é’® |
| `src/lib/editor/setup.ts` | ä¿®æ”¹ | Tier1Plugins æ–°å¢ codeBlockViewï¼ŒåŠ¨æ€åŠ è½½ |
| `src/lib/styles/editor.css` | ä¿®æ”¹ | ä»£ç å—å·¥å…·æ ã€è¯­è¨€é€‰æ‹©å™¨ã€å¤åˆ¶æŒ‰é’®æ ·å¼ |
| `src/lib/i18n/locales/en.json` | ä¿®æ”¹ | æ–°å¢ `codeBlock.copy`, `codeBlock.copied` ç­‰ i18n key |
| `src/lib/i18n/locales/zh-CN.json` | ä¿®æ”¹ | å¯¹åº”ä¸­æ–‡ç¿»è¯‘ |

## åŒ…å¤§å°å½±å“

| æŒ‡æ ‡ | å˜åŒ– |
|------|------|
| æ–°å¢ä¾èµ– | æ—  |
| JS å¢é‡ | ~3-5 KBï¼ˆçº¯ TypeScript ä»£ç  + CSSï¼‰ |
| æ€»åŒ…å¤§å° | ä¸å˜ |

---

## éªŒè¯æ–¹æ¡ˆ

1. `pnpm check` â€” 0 TypeScript é”™è¯¯
2. `cargo check` â€” Rust ç¼–è¯‘é€šè¿‡
3. æ–°å»ºä»£ç å—ï¼ˆ` ```javascript `ï¼‰â†’ å·¥å…·æ æ˜¾ç¤º "javascript" + ğŸ“‹ æŒ‰é’®
4. æ— è¯­è¨€å£°æ˜çš„ä»£ç å— â†’ å·¥å…·æ æ˜¾ç¤º "text"
5. ç‚¹å‡»è¯­è¨€æ ‡ç­¾ â†’ å¼¹å‡ºæœç´¢ä¸‹æ‹‰ï¼Œé€‰æ‹© "python" â†’ ä»£ç é«˜äº®è‡ªåŠ¨åˆ‡æ¢ä¸º Python ç€è‰²
6. ç‚¹å‡»å¤åˆ¶æŒ‰é’® â†’ ä»£ç å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œå›¾æ ‡å˜ä¸º âœ“
7. åˆ‡æ¢åˆ°æºç æ¨¡å¼ â†’ è¯­è¨€å£°æ˜æ­£ç¡®åæ˜ ï¼ˆå¦‚ ` ```python `ï¼‰
8. æš—è‰²ä¸»é¢˜ â†’ å·¥å…·æ å’Œä¸‹æ‹‰æ ·å¼æ­£ç¡®
9. å¯¼å‡º HTML â†’ è¯­è¨€ class æ­£ç¡®ï¼ˆ`<code class="language-python">`ï¼‰
